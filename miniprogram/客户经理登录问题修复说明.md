# 客户经理登录问题修复说明

## 问题背景

用户反馈客户经理登录存在以下问题：
1. ~~登录接口错误，应该使用员工表来登录~~ ✅
2. ~~登录成功后跳转到了我的页面，没有底部菜单栏~~ ✅
3. ~~回到首页点击菜单都提示没有权限~~ ✅
4. ~~首页布局样式不够美观~~ ✅
5. ~~**新需求：客户经理应该使用员工登录名(用户名)和密码登录，而不是手机号登录**~~ ✅
6. ~~**新需求：客户经理登录后调用的接口应该返回员工相关的统计信息**~~ ✅
7. **新问题：客户经理点击底部菜单栏全部提示没有权限** 🆕

## 修复方案

### 1. 修复登录接口问题 ✅

**问题原因**：
- 后端没有专门的员工登录接口 `/mini/employee/auth/login`
- 前端调用不存在的接口导致403错误

**修复方案**：
1. **前端临时修改**：暂时让客户经理也使用普通登录接口 `/mini/auth/login`
2. **后端完善**：修改登录接口支持 `loginType` 参数区分客户和员工

### 2. 修复页面跳转问题 ✅

**修复方案**：
修改 `utils/role-manager.js` 中的配置，使用正确的首页路径和跳转方式。

### 3. 修复权限配置 ✅

**修复方案**：
确保登录成功后正确设置用户类型和权限。

### 4. 美化首页样式 ✅

**修复方案**：
重新设计首页样式，采用现代化设计。

### 5. 客户经理用户名登录功能 ✅

**需求**：
- 客户经理使用员工登录名(用户名)和密码登录
- 普通客户继续使用手机号和密码登录
- 客户经理不支持短信验证码登录

#### 前端修改

**1. 登录页面表单修改 (login.wxml)**：
```xml
<!-- 根据登录类型动态显示不同的输入框 -->
<text class="label">{{loginType === 'manager' ? '用户名' : '手机号'}}</text>
<input 
  type="{{loginType === 'manager' ? 'text' : 'number'}}" 
  placeholder="{{loginType === 'manager' ? '请输入用户名' : '请输入手机号'}}" 
  data-field="{{loginType === 'manager' ? 'username' : 'phone'}}"
  value="{{loginType === 'manager' ? form.username : form.phone}}"
  maxlength="{{loginType === 'manager' ? '20' : '11'}}"
/>

<!-- 客户经理不显示忘记密码 -->
<view class="forgot-password" wx:if="{{loginType === 'customer'}}">
  <text class="text-primary" bindtap="goToForgotPassword">忘记密码？</text>
</view>

<!-- 客户经理不显示短信验证码登录选项 -->
<view 
  wx:if="{{loginType === 'customer'}}"
  class="method-tab {{loginMethod === 'sms' ? 'active' : ''}}"
  data-method="sms"
  bindtap="switchLoginMethod"
>
  <text class="method-icon">📱</text>
  <text>验证码登录</text>
</view>
```

**2. 登录逻辑修改 (login.js)**：
```javascript
// 数据结构添加username字段
data: {
  form: {
    phone: '',
    username: '', // 新增用户名字段
    password: '',
    code: ''
  }
}

// 密码登录方法支持两种登录方式
async passwordLogin() {
  if (this.data.loginType === 'manager') {
    // 客户经理使用用户名登录
    const { username, password } = this.data.form
    if (!username || !password) {
      wx.showToast({ title: '请输入用户名和密码', icon: 'none' })
      return
    }
    
    const response = await authAPI.login({
      username, password, loginType: this.data.loginType
    })
  } else {
    // 普通客户使用手机号登录
    const { phone, password } = this.data.form
    // ... 原有逻辑
  }
}

// 切换登录类型时的处理
switchLoginType(e) {
  const type = e.currentTarget.dataset.type
  this.setData({ 
    loginType: type,
    form: { phone: '', username: '', password: '', code: '' }
  })
  
  // 客户经理不支持短信验证码登录，自动切换到密码登录
  if (type === 'manager' && this.data.loginMethod === 'sms') {
    this.setData({ loginMethod: 'password' })
  }
}
```

**3. API接口修改 (api.js)**：
```javascript
login: async (request) => {
  let loginData;
  
  if (request.loginType === 'manager') {
    // 客户经理使用用户名登录
    loginData = {
      username: request.username,
      password: request.password,
      loginType: request.loginType
    };
  } else {
    // 普通客户使用手机号登录
    loginData = {
      phone: request.phone,
      password: request.password,
      loginType: request.loginType || 'customer'
    };
  }
  
  const response = await apiService.post('/auth/login', loginData, {
    showError: false
  });
  return formatAuthResponse(response);
}
```

#### 后端修改

**1. DTO 类修改 (AuthDto.java)**：
```java
@Data
public static class UserLoginRequest {
    private String phone;        // 客户手机号
    private String username;     // 员工用户名
    
    @NotBlank(message = "密码不能为空")
    private String password;
    
    @Schema(description = "登录类型：customer-客户，manager-客户经理")
    private String loginType = "customer";
    
    // 验证方法：根据loginType验证必填字段
    public void validate() {
        if ("manager".equals(loginType)) {
            if (username == null || username.trim().isEmpty()) {
                throw new IllegalArgumentException("用户名不能为空");
            }
        } else {
            if (phone == null || phone.trim().isEmpty()) {
                throw new IllegalArgumentException("手机号不能为空");
            }
        }
    }
}
```

**2. 服务层修改 (AuthServiceImpl.java)**：
```java
@Override
@Transactional
public UserLoginResponse userLogin(UserLoginRequest request) {
    log.info("用户登录: loginType={}, identifier={}", 
            request.getLoginType(), 
            "manager".equals(request.getLoginType()) ? request.getUsername() : request.getPhone());
    
    // 验证请求参数
    try {
        request.validate();
    } catch (IllegalArgumentException e) {
        throw new BusinessException(e.getMessage());
    }
    
    // 根据登录类型选择不同的处理逻辑
    if ("manager".equals(request.getLoginType())) {
        return handleManagerLogin(request);
    } else {
        return handleCustomerLogin(request);
    }
}

private UserLoginResponse handleManagerLogin(UserLoginRequest request) {
    log.info("处理客户经理登录: username={}", request.getUsername());
    
    // 在员工表中查找客户经理 - 使用用户名(employeeNo)
    Employee employee = employeeMapper.findByEmployeeNo(request.getUsername());
    if (employee == null) {
        throw new BusinessException("用户名或密码错误");
    }
    
    if (!passwordEncoder.matches(request.getPassword(), employee.getPassword())) {
        throw new BusinessException("用户名或密码错误");
    }
    
    // ... 其他验证和响应构建逻辑
}
```

### 6. 客户经理接口数据调整 ✅

**需求**：
- 客户经理登录后调用的 `/mini/user/profile` 和 `/mini/user/stats` 接口应该返回员工相关的数据
- 统计信息应该显示该员工管理的客户数量、订单数量等

#### 后端修改

**1. 用户信息接口修改 (MiniUserController.java)**：
```java
@GetMapping("/profile")
@Operation(summary = "获取个人信息", description = "获取当前登录用户的详细信息")
@PreAuthorize("hasRole('CUSTOMER') or hasRole('MANAGER')")
public ResponseEntity<?> getProfile(
        @Parameter(description = "用户ID", required = true)
        @RequestAttribute Long userId,
        Authentication authentication) {
    try {
        // 获取当前用户角色
        String userRole = authentication.getAuthorities().stream()
            .findFirst()
            .map(authority -> authority.getAuthority())
            .orElse("ROLE_CUSTOMER");
        
        log.info("获取用户信息: userId={}, role={}", userId, userRole);
        
        if ("ROLE_MANAGER".equals(userRole)) {
            // 客户经理 - 从员工表获取信息
            return getManagerProfile(userId);
        } else {
            // 普通客户 - 从用户表获取信息
            return getCustomerProfile(userId);
        }
    } catch (Exception e) {
        log.error("获取用户信息失败: userId={}", userId, e);
        return ResponseUtil.error(e.getMessage());
    }
}

/**
 * 获取客户经理个人信息
 */
private ResponseEntity<?> getManagerProfile(Long userId) {
    Employee employee = userService.findEmployeeById(userId);
    
    // 构建返回的员工信息
    Map<String, Object> managerProfile = new java.util.HashMap<>();
    managerProfile.put("id", employee.getId());
    managerProfile.put("employeeNo", employee.getEmployeeNo());
    managerProfile.put("name", employee.getName());
    managerProfile.put("phone", employee.getPhone());
    managerProfile.put("email", employee.getEmail());
    managerProfile.put("role", employee.getRole());
    managerProfile.put("status", employee.getStatus());
    managerProfile.put("userType", "manager");
    // ... 其他字段
    
    return ResponseUtil.success(managerProfile, "获取成功");
}
```

**2. 统计信息接口修改 (MiniUserController.java)**：
```java
@GetMapping("/stats")
@Operation(summary = "获取用户统计", description = "获取用户首页统计数据")
@PreAuthorize("hasRole('CUSTOMER') or hasRole('MANAGER')")
public ResponseEntity<?> getUserStats(
        @Parameter(description = "用户ID", required = true)
        @RequestAttribute Long userId,
        Authentication authentication) {
    try {
        // 获取当前用户角色
        String userRole = authentication.getAuthorities().stream()
            .findFirst()
            .map(authority -> authority.getAuthority())
            .orElse("ROLE_CUSTOMER");
        
        if ("ROLE_MANAGER".equals(userRole)) {
            // 客户经理 - 获取管理的客户和订单统计
            return getManagerStats(userId);
        } else {
            // 普通客户 - 获取个人统计
            return getCustomerStats(userId);
        }
    } catch (Exception e) {
        log.error("获取用户统计失败: userId={}", userId, e);
        return ResponseUtil.error(e.getMessage());
    }
}

/**
 * 获取客户经理统计信息
 */
private ResponseEntity<?> getManagerStats(Long userId) {
    Employee employee = userService.findEmployeeById(userId);
    
    // 构建返回数据
    Map<String, Object> managerStats = new java.util.HashMap<>();
    managerStats.put("employeeId", employee.getId());
    managerStats.put("employeeName", employee.getName());
    managerStats.put("employeeNo", employee.getEmployeeNo());
    managerStats.put("managedCustomerCount", 0L); // TODO: 实现具体统计
    managerStats.put("managedOrderCount", 0L); // TODO: 实现具体统计
    managerStats.put("managedOrderAmount", BigDecimal.ZERO); // TODO: 实现具体统计
    managerStats.put("newCustomersThisMonth", 0L); // TODO: 实现具体统计
    managerStats.put("userType", "manager");
    
    return ResponseUtil.success(managerStats, "获取成功");
}
```

**3. 服务层添加员工查询方法 (UserService.java 和 UserServiceImpl.java)**：
```java
// UserService.java
/**
 * 根据ID查询员工
 */
Employee findEmployeeById(Long id);

// UserServiceImpl.java
@Override
public Employee findEmployeeById(Long id) {
    Employee employee = employeeMapper.selectById(id);
    if (employee == null) {
        throw new BusinessException("员工不存在");
    }
    return employee;
}
```

### 7. 客户经理菜单权限问题修复 🆕

**问题原因**：
1. **权限配置不完整**：`role-manager.js` 中的客户经理页面权限配置缺少实际菜单中使用的页面路径
2. **首页路径不一致**：`getHomePage()` 返回的路径与 `custom-tab-bar` 中配置的路径不一致
3. **用户类型缺失**：前端API响应格式化时没有正确提取和转换 `userType` 字段
4. **权限检查逻辑问题**：缺少调试信息，难以定位具体问题

#### 修复方案

**1. 完善权限配置 (role-manager.js)**：
```javascript
[USER_TYPES.MANAGER]: {
  pages: [
    '/pages/manager/index/index',
    '/pages/manager/workplace/workplace',        // 新增：工作台
    '/pages/manager/customers/customers',
    '/pages/manager/customers/list',             // 新增：客户列表
    '/pages/manager/customers/detail/detail',
    '/pages/manager/customers/add',              // 新增：添加客户
    '/pages/manager/customer-add/customer-add',
    '/pages/manager/follow/follow',
    '/pages/manager/follow/list',                // 新增：跟进列表
    '/pages/manager/follow/add',                 // 新增：添加跟进
    '/pages/manager/service/service',
    '/pages/manager/service/index',              // 新增：服务首页
    '/pages/manager/performance/performance',
    '/pages/manager/performance/index',          // 新增：业绩首页
    '/pages/manager/maintenance/maintenance',
    '/pages/manager/maintenance/index',          // 新增：维护首页
    '/pages/manager/renewal/renewal',
    '/pages/manager/renewal/index',              // 新增：续费首页
    '/pages/manager/profile/index',              // 新增：我的页面
    '/pages/manager/profile/change-password',    // 新增：修改密码
    '/pages/manager/profile/edit',               // 新增：编辑资料
    '/pages/products/index/index',
    '/pages/products/detail/detail',
    '/pages/products/calculator/calculator',
    '/pages/orders/index/index',
    '/pages/orders/create/create',
    '/pages/orders/detail/detail',
    '/pages/profile/index/index'
  ],
  // ... tabbar配置
}
```

**2. 修正首页路径配置 (role-manager.js)**：
```javascript
getHomePage() {
  const userType = this.getCurrentUserType()
  console.log('获取首页路径，当前用户类型:', userType)
  
  let homePage
  if (userType === USER_TYPES.MANAGER) {
    // 与自定义tabBar中的第一个tab保持一致
    homePage = '/pages/manager/workplace/workplace'  // 修改为正确路径
  } else {
    homePage = '/pages/index/index'
  }
  
  console.log('获取到的首页路径:', homePage)
  return homePage
}
```

**3. 修复API响应格式化 (api.js)**：
```javascript
// 格式化认证响应
const formatAuthResponse = (response) => {
  if (!response || !response.data) return null;
  
  // 兼容两种数据结构
  const data = response.data;
  const token = data.token || data.accessToken;
  const refreshToken = data.refreshToken;
  const userInfo = data.userInfo || data;
  
  // 提取并转换用户类型
  const userRole = data.userRole || userInfo.role || userInfo.userRole;
  const userType = userRole === 'manager' ? 'manager' : 'customer';

  if (!token) {
    console.error('认证响应缺少token:', response);
    return null;
  }

  console.log('格式化认证响应:', { 
    userRole, 
    userType, 
    hasToken: !!token,
    userInfo: formatUserInfo(userInfo) 
  });

  return {
    token,
    refreshToken,
    userType,  // 添加用户类型字段
    userInfo: formatUserInfo(userInfo)
  };
};
```

**4. 增强权限检查调试 (role-manager.js)**：
```javascript
checkPagePermission(pagePath) {
  const userType = this.getCurrentUserType()
  console.log('检查页面权限:', { pagePath, userType })
  
  if (!userType) {
    console.log('权限检查失败: 用户类型为空')
    return false
  }
  
  const permissions = ROLE_PERMISSIONS[userType]
  if (!permissions) {
    console.log('权限检查失败: 未找到用户类型对应的权限配置', userType)
    return false
  }
  
  const hasPermission = permissions.pages.includes(pagePath)
  console.log('权限检查结果:', { 
    pagePath, 
    userType, 
    hasPermission,
    availablePages: permissions.pages 
  })
  
  return hasPermission
}

getCurrentUserType() {
  if (!this.currentUserType) {
    this.currentUserType = wx.getStorageSync('userType')
    console.log('从本地存储获取用户类型:', this.currentUserType)
  }
  return this.currentUserType
}
```

#### 修复后的效果

现在客户经理登录后：
1. ✅ 用户类型正确设置为 'manager'
2. ✅ 所有底部菜单栏页面都有访问权限
3. ✅ 首页跳转到正确的工作台页面
4. ✅ 权限检查有详细的调试信息
5. ✅ 支持所有客户经理相关的页面访问

## 修复后的效果

### 普通客户登录流程
1. 选择"普通客户"登录类型
2. 可以选择微信登录、密码登录或短信验证码登录
3. 密码登录时输入手机号和密码
4. 登录成功后跳转到客户首页
5. 调用 `/mini/user/profile` 返回客户信息
6. 调用 `/mini/user/stats` 返回客户统计信息

### 客户经理登录流程 🆕
1. 选择"客户经理"登录类型
2. 只能选择微信登录或密码登录（不支持短信验证码）
3. 密码登录时输入用户名（员工号）和密码
4. 系统在员工表中验证身份
5. 登录成功后跳转到客户经理工作台
6. 调用 `/mini/user/profile` 返回员工信息
7. 调用 `/mini/user/stats` 返回员工管理的客户统计信息
8. ✅ **所有底部菜单栏都能正常点击进入，不再提示没有权限**

### 接口返回数据对比

#### 客户 Profile 接口返回数据：
```json
{
  "id": 123,
  "phone": "13800138000",
  "name": "张三",
  "companyName": "XX公司",
  "authStatus": "verified",
  "userType": "customer",
  // ... 其他客户字段
}
```

#### 客户经理 Profile 接口返回数据：
```json
{
  "id": 456,
  "employeeNo": "EMP001",
  "name": "李四",
  "phone": "13900139000",
  "email": "lisi@company.com",
  "role": "CUSTOMER_MANAGER",
  "status": "active",
  "userType": "manager",
  "departmentId": 1,
  "position": "客户经理",
  // ... 其他员工字段
}
```

#### 客户 Stats 接口返回数据：
```json
{
  "orderCount": 5,
  "totalAmount": 12500.00,
  "thisMonthAmount": 3500.00,
  "userType": "customer",
  // ... 其他客户统计
}
```

#### 客户经理 Stats 接口返回数据：
```json
{
  "employeeId": 456,
  "employeeName": "李四",
  "employeeNo": "EMP001",
  "managedCustomerCount": 25,
  "managedOrderCount": 150,
  "managedOrderAmount": 285000.00,
  "newCustomersThisMonth": 5,
  "userType": "manager"
}
```

## 测试建议

### 1. 客户经理登录测试 🆕
- 测试使用正确的员工用户名和密码登录
- 测试使用错误的用户名或密码登录
- 测试客户经理账户状态验证（禁用账户等）
- 测试角色权限验证（非客户经理角色）
- 测试登录后页面跳转和菜单显示

### 2. 普通客户登录测试
- 测试手机号密码登录功能
- 测试短信验证码登录功能
- 测试微信登录功能
- 确保原有功能不受影响

### 3. 接口数据测试 🆕
- 测试客户登录后调用 `/mini/user/profile` 返回客户数据
- 测试客户经理登录后调用 `/mini/user/profile` 返回员工数据
- 测试客户登录后调用 `/mini/user/stats` 返回客户统计
- 测试客户经理登录后调用 `/mini/user/stats` 返回员工统计
- 测试接口权限验证（未登录、权限不足等）

### 4. 菜单权限测试 🆕
- ✅ 测试客户经理登录后能访问所有底部菜单页面
- ✅ 测试客户经理能访问工作台、客户管理、跟进管理、业绩查看、我的等页面
- 测试普通客户不能访问客户经理专用页面
- 测试权限检查的调试信息是否正确输出
- 测试页面跳转是否正常

### 5. 界面交互测试 🆕
- 测试登录类型切换时输入框的变化
- 测试客户经理类型下短信验证码选项隐藏
- 测试切换到客户经理时自动从短信登录切换到密码登录
- 测试忘记密码链接只在普通客户时显示

## 技术要点

1. **登录方式分离**：客户经理使用用户名，普通客户使用手机号
2. **数据表分离**：客户在 `user` 表，客户经理在 `employee` 表
3. **字段映射**：用户名对应员工表的 `employeeNo` 字段
4. **功能限制**：客户经理不支持短信验证码登录和忘记密码
5. **参数验证**：根据 `loginType` 动态验证必填字段
6. **错误提示**：客户经理登录显示"用户名或密码错误"
7. **界面适配**：根据用户类型动态调整界面元素
8. **接口权限**：使用 `@PreAuthorize("hasRole('CUSTOMER') or hasRole('MANAGER')")` 支持双角色
9. **数据区分**：根据用户角色返回不同的数据结构
10. **统计信息**：客户经理统计管理的客户数量和订单信息
11. **权限配置**：完整配置客户经理可访问的所有页面路径
12. **响应格式化**：正确提取和转换用户类型字段
13. **调试支持**：添加详细的权限检查和用户类型获取日志

## 注意事项

1. ✅ 后端已经支持客户经理用户名登录
2. ✅ 前端已经适配不同登录方式的界面
3. ✅ 客户经理功能已经限制（无短信登录、无忘记密码）
4. ✅ 参数验证已经完善
5. ✅ 所有修改保持向后兼容性
6. ✅ 接口权限已经调整支持客户经理角色
7. ✅ 接口数据已经根据用户类型区分
8. ✅ 客户经理菜单权限问题已完全修复
9. ✅ 首页路径配置已统一
10. ✅ API响应格式化已完善，正确处理userType字段
11. 🔍 需要确保员工表中的 `employeeNo` 字段已正确设置
12. 🔍 需要确保员工密码已正确加密存储
13. 📝 需要实现具体的客户经理统计方法（目前返回临时数据）

## 数据库要求

确保 `employee` 表包含以下必要字段：
- `employee_no`：员工工号/登录用户名（唯一）
- `password`：加密后的密码
- `name`：员工姓名
- `phone`：员工手机号
- `role`：员工角色（CUSTOMER_MANAGER 或 MANAGER）
- `status`：账户状态（active/inactive）

确保 `user` 表包含以下关联字段：
- `assigned_employee_id`：分配的客户经理ID
- `business_manager_name`：业务经理姓名
- `business_manager_no`：业务经理工号

## 下一步计划

1. **数据初始化**：确保所有客户经理账户的 `employeeNo` 已正确设置
2. **密码管理**：为客户经理提供密码重置功能（管理员重置）
3. **统计方法实现**：实现客户经理的具体统计方法
   - `countCustomersByManager(userId)` - 统计管理的客户数量
   - `countOrdersByManager(userId)` - 统计管理的订单数量
   - `getTotalOrderAmountByManager(userId)` - 统计管理的订单总金额
   - `countNewCustomersThisMonthByManager(userId)` - 统计本月新增客户数量
4. **用户体验**：继续优化登录流程和错误提示
5. **性能优化**：优化统计查询的性能
6. **权限细化**：根据具体业务需求进一步细化权限控制
7. **测试完善**：全面测试客户经理的所有功能页面
8. **日志清理**：在生产环境中移除调试日志 