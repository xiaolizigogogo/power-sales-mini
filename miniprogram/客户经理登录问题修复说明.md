# å®¢æˆ·ç»ç†ç™»å½•é—®é¢˜ä¿®å¤è¯´æ˜

## é—®é¢˜èƒŒæ™¯

ç”¨æˆ·åé¦ˆå®¢æˆ·ç»ç†ç™»å½•å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
1. ~~ç™»å½•æ¥å£é”™è¯¯ï¼Œåº”è¯¥ä½¿ç”¨å‘˜å·¥è¡¨æ¥ç™»å½•~~ âœ…
2. ~~ç™»å½•æˆåŠŸåè·³è½¬åˆ°äº†æˆ‘çš„é¡µé¢ï¼Œæ²¡æœ‰åº•éƒ¨èœå•æ ~~ âœ…
3. ~~å›åˆ°é¦–é¡µç‚¹å‡»èœå•éƒ½æç¤ºæ²¡æœ‰æƒé™~~ âœ…
4. ~~é¦–é¡µå¸ƒå±€æ ·å¼ä¸å¤Ÿç¾è§‚~~ âœ…
5. ~~**æ–°éœ€æ±‚ï¼šå®¢æˆ·ç»ç†åº”è¯¥ä½¿ç”¨å‘˜å·¥ç™»å½•å(ç”¨æˆ·å)å’Œå¯†ç ç™»å½•ï¼Œè€Œä¸æ˜¯æ‰‹æœºå·ç™»å½•**~~ âœ…
6. ~~**æ–°éœ€æ±‚ï¼šå®¢æˆ·ç»ç†ç™»å½•åè°ƒç”¨çš„æ¥å£åº”è¯¥è¿”å›å‘˜å·¥ç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯**~~ âœ…
7. **æ–°é—®é¢˜ï¼šå®¢æˆ·ç»ç†ç‚¹å‡»åº•éƒ¨èœå•æ å…¨éƒ¨æç¤ºæ²¡æœ‰æƒé™** ğŸ†•

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤ç™»å½•æ¥å£é—®é¢˜ âœ…

**é—®é¢˜åŸå› **ï¼š
- åç«¯æ²¡æœ‰ä¸“é—¨çš„å‘˜å·¥ç™»å½•æ¥å£ `/mini/employee/auth/login`
- å‰ç«¯è°ƒç”¨ä¸å­˜åœ¨çš„æ¥å£å¯¼è‡´403é”™è¯¯

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
1. **å‰ç«¯ä¸´æ—¶ä¿®æ”¹**ï¼šæš‚æ—¶è®©å®¢æˆ·ç»ç†ä¹Ÿä½¿ç”¨æ™®é€šç™»å½•æ¥å£ `/mini/auth/login`
2. **åç«¯å®Œå–„**ï¼šä¿®æ”¹ç™»å½•æ¥å£æ”¯æŒ `loginType` å‚æ•°åŒºåˆ†å®¢æˆ·å’Œå‘˜å·¥

### 2. ä¿®å¤é¡µé¢è·³è½¬é—®é¢˜ âœ…

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
ä¿®æ”¹ `utils/role-manager.js` ä¸­çš„é…ç½®ï¼Œä½¿ç”¨æ­£ç¡®çš„é¦–é¡µè·¯å¾„å’Œè·³è½¬æ–¹å¼ã€‚

### 3. ä¿®å¤æƒé™é…ç½® âœ…

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
ç¡®ä¿ç™»å½•æˆåŠŸåæ­£ç¡®è®¾ç½®ç”¨æˆ·ç±»å‹å’Œæƒé™ã€‚

### 4. ç¾åŒ–é¦–é¡µæ ·å¼ âœ…

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
é‡æ–°è®¾è®¡é¦–é¡µæ ·å¼ï¼Œé‡‡ç”¨ç°ä»£åŒ–è®¾è®¡ã€‚

### 5. å®¢æˆ·ç»ç†ç”¨æˆ·åç™»å½•åŠŸèƒ½ âœ…

**éœ€æ±‚**ï¼š
- å®¢æˆ·ç»ç†ä½¿ç”¨å‘˜å·¥ç™»å½•å(ç”¨æˆ·å)å’Œå¯†ç ç™»å½•
- æ™®é€šå®¢æˆ·ç»§ç»­ä½¿ç”¨æ‰‹æœºå·å’Œå¯†ç ç™»å½•
- å®¢æˆ·ç»ç†ä¸æ”¯æŒçŸ­ä¿¡éªŒè¯ç ç™»å½•

#### å‰ç«¯ä¿®æ”¹

**1. ç™»å½•é¡µé¢è¡¨å•ä¿®æ”¹ (login.wxml)**ï¼š
```xml
<!-- æ ¹æ®ç™»å½•ç±»å‹åŠ¨æ€æ˜¾ç¤ºä¸åŒçš„è¾“å…¥æ¡† -->
<text class="label">{{loginType === 'manager' ? 'ç”¨æˆ·å' : 'æ‰‹æœºå·'}}</text>
<input 
  type="{{loginType === 'manager' ? 'text' : 'number'}}" 
  placeholder="{{loginType === 'manager' ? 'è¯·è¾“å…¥ç”¨æˆ·å' : 'è¯·è¾“å…¥æ‰‹æœºå·'}}" 
  data-field="{{loginType === 'manager' ? 'username' : 'phone'}}"
  value="{{loginType === 'manager' ? form.username : form.phone}}"
  maxlength="{{loginType === 'manager' ? '20' : '11'}}"
/>

<!-- å®¢æˆ·ç»ç†ä¸æ˜¾ç¤ºå¿˜è®°å¯†ç  -->
<view class="forgot-password" wx:if="{{loginType === 'customer'}}">
  <text class="text-primary" bindtap="goToForgotPassword">å¿˜è®°å¯†ç ï¼Ÿ</text>
</view>

<!-- å®¢æˆ·ç»ç†ä¸æ˜¾ç¤ºçŸ­ä¿¡éªŒè¯ç ç™»å½•é€‰é¡¹ -->
<view 
  wx:if="{{loginType === 'customer'}}"
  class="method-tab {{loginMethod === 'sms' ? 'active' : ''}}"
  data-method="sms"
  bindtap="switchLoginMethod"
>
  <text class="method-icon">ğŸ“±</text>
  <text>éªŒè¯ç ç™»å½•</text>
</view>
```

**2. ç™»å½•é€»è¾‘ä¿®æ”¹ (login.js)**ï¼š
```javascript
// æ•°æ®ç»“æ„æ·»åŠ usernameå­—æ®µ
data: {
  form: {
    phone: '',
    username: '', // æ–°å¢ç”¨æˆ·åå­—æ®µ
    password: '',
    code: ''
  }
}

// å¯†ç ç™»å½•æ–¹æ³•æ”¯æŒä¸¤ç§ç™»å½•æ–¹å¼
async passwordLogin() {
  if (this.data.loginType === 'manager') {
    // å®¢æˆ·ç»ç†ä½¿ç”¨ç”¨æˆ·åç™»å½•
    const { username, password } = this.data.form
    if (!username || !password) {
      wx.showToast({ title: 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', icon: 'none' })
      return
    }
    
    const response = await authAPI.login({
      username, password, loginType: this.data.loginType
    })
  } else {
    // æ™®é€šå®¢æˆ·ä½¿ç”¨æ‰‹æœºå·ç™»å½•
    const { phone, password } = this.data.form
    // ... åŸæœ‰é€»è¾‘
  }
}

// åˆ‡æ¢ç™»å½•ç±»å‹æ—¶çš„å¤„ç†
switchLoginType(e) {
  const type = e.currentTarget.dataset.type
  this.setData({ 
    loginType: type,
    form: { phone: '', username: '', password: '', code: '' }
  })
  
  // å®¢æˆ·ç»ç†ä¸æ”¯æŒçŸ­ä¿¡éªŒè¯ç ç™»å½•ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å¯†ç ç™»å½•
  if (type === 'manager' && this.data.loginMethod === 'sms') {
    this.setData({ loginMethod: 'password' })
  }
}
```

**3. APIæ¥å£ä¿®æ”¹ (api.js)**ï¼š
```javascript
login: async (request) => {
  let loginData;
  
  if (request.loginType === 'manager') {
    // å®¢æˆ·ç»ç†ä½¿ç”¨ç”¨æˆ·åç™»å½•
    loginData = {
      username: request.username,
      password: request.password,
      loginType: request.loginType
    };
  } else {
    // æ™®é€šå®¢æˆ·ä½¿ç”¨æ‰‹æœºå·ç™»å½•
    loginData = {
      phone: request.phone,
      password: request.password,
      loginType: request.loginType || 'customer'
    };
  }
  
  const response = await apiService.post('/auth/login', loginData, {
    showError: false
  });
  return formatAuthResponse(response);
}
```

#### åç«¯ä¿®æ”¹

**1. DTO ç±»ä¿®æ”¹ (AuthDto.java)**ï¼š
```java
@Data
public static class UserLoginRequest {
    private String phone;        // å®¢æˆ·æ‰‹æœºå·
    private String username;     // å‘˜å·¥ç”¨æˆ·å
    
    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    private String password;
    
    @Schema(description = "ç™»å½•ç±»å‹ï¼šcustomer-å®¢æˆ·ï¼Œmanager-å®¢æˆ·ç»ç†")
    private String loginType = "customer";
    
    // éªŒè¯æ–¹æ³•ï¼šæ ¹æ®loginTypeéªŒè¯å¿…å¡«å­—æ®µ
    public void validate() {
        if ("manager".equals(loginType)) {
            if (username == null || username.trim().isEmpty()) {
                throw new IllegalArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");
            }
        } else {
            if (phone == null || phone.trim().isEmpty()) {
                throw new IllegalArgumentException("æ‰‹æœºå·ä¸èƒ½ä¸ºç©º");
            }
        }
    }
}
```

**2. æœåŠ¡å±‚ä¿®æ”¹ (AuthServiceImpl.java)**ï¼š
```java
@Override
@Transactional
public UserLoginResponse userLogin(UserLoginRequest request) {
    log.info("ç”¨æˆ·ç™»å½•: loginType={}, identifier={}", 
            request.getLoginType(), 
            "manager".equals(request.getLoginType()) ? request.getUsername() : request.getPhone());
    
    // éªŒè¯è¯·æ±‚å‚æ•°
    try {
        request.validate();
    } catch (IllegalArgumentException e) {
        throw new BusinessException(e.getMessage());
    }
    
    // æ ¹æ®ç™»å½•ç±»å‹é€‰æ‹©ä¸åŒçš„å¤„ç†é€»è¾‘
    if ("manager".equals(request.getLoginType())) {
        return handleManagerLogin(request);
    } else {
        return handleCustomerLogin(request);
    }
}

private UserLoginResponse handleManagerLogin(UserLoginRequest request) {
    log.info("å¤„ç†å®¢æˆ·ç»ç†ç™»å½•: username={}", request.getUsername());
    
    // åœ¨å‘˜å·¥è¡¨ä¸­æŸ¥æ‰¾å®¢æˆ·ç»ç† - ä½¿ç”¨ç”¨æˆ·å(employeeNo)
    Employee employee = employeeMapper.findByEmployeeNo(request.getUsername());
    if (employee == null) {
        throw new BusinessException("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
    }
    
    if (!passwordEncoder.matches(request.getPassword(), employee.getPassword())) {
        throw new BusinessException("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
    }
    
    // ... å…¶ä»–éªŒè¯å’Œå“åº”æ„å»ºé€»è¾‘
}
```

### 6. å®¢æˆ·ç»ç†æ¥å£æ•°æ®è°ƒæ•´ âœ…

**éœ€æ±‚**ï¼š
- å®¢æˆ·ç»ç†ç™»å½•åè°ƒç”¨çš„ `/mini/user/profile` å’Œ `/mini/user/stats` æ¥å£åº”è¯¥è¿”å›å‘˜å·¥ç›¸å…³çš„æ•°æ®
- ç»Ÿè®¡ä¿¡æ¯åº”è¯¥æ˜¾ç¤ºè¯¥å‘˜å·¥ç®¡ç†çš„å®¢æˆ·æ•°é‡ã€è®¢å•æ•°é‡ç­‰

#### åç«¯ä¿®æ”¹

**1. ç”¨æˆ·ä¿¡æ¯æ¥å£ä¿®æ”¹ (MiniUserController.java)**ï¼š
```java
@GetMapping("/profile")
@Operation(summary = "è·å–ä¸ªäººä¿¡æ¯", description = "è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯")
@PreAuthorize("hasRole('CUSTOMER') or hasRole('MANAGER')")
public ResponseEntity<?> getProfile(
        @Parameter(description = "ç”¨æˆ·ID", required = true)
        @RequestAttribute Long userId,
        Authentication authentication) {
    try {
        // è·å–å½“å‰ç”¨æˆ·è§’è‰²
        String userRole = authentication.getAuthorities().stream()
            .findFirst()
            .map(authority -> authority.getAuthority())
            .orElse("ROLE_CUSTOMER");
        
        log.info("è·å–ç”¨æˆ·ä¿¡æ¯: userId={}, role={}", userId, userRole);
        
        if ("ROLE_MANAGER".equals(userRole)) {
            // å®¢æˆ·ç»ç† - ä»å‘˜å·¥è¡¨è·å–ä¿¡æ¯
            return getManagerProfile(userId);
        } else {
            // æ™®é€šå®¢æˆ· - ä»ç”¨æˆ·è¡¨è·å–ä¿¡æ¯
            return getCustomerProfile(userId);
        }
    } catch (Exception e) {
        log.error("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: userId={}", userId, e);
        return ResponseUtil.error(e.getMessage());
    }
}

/**
 * è·å–å®¢æˆ·ç»ç†ä¸ªäººä¿¡æ¯
 */
private ResponseEntity<?> getManagerProfile(Long userId) {
    Employee employee = userService.findEmployeeById(userId);
    
    // æ„å»ºè¿”å›çš„å‘˜å·¥ä¿¡æ¯
    Map<String, Object> managerProfile = new java.util.HashMap<>();
    managerProfile.put("id", employee.getId());
    managerProfile.put("employeeNo", employee.getEmployeeNo());
    managerProfile.put("name", employee.getName());
    managerProfile.put("phone", employee.getPhone());
    managerProfile.put("email", employee.getEmail());
    managerProfile.put("role", employee.getRole());
    managerProfile.put("status", employee.getStatus());
    managerProfile.put("userType", "manager");
    // ... å…¶ä»–å­—æ®µ
    
    return ResponseUtil.success(managerProfile, "è·å–æˆåŠŸ");
}
```

**2. ç»Ÿè®¡ä¿¡æ¯æ¥å£ä¿®æ”¹ (MiniUserController.java)**ï¼š
```java
@GetMapping("/stats")
@Operation(summary = "è·å–ç”¨æˆ·ç»Ÿè®¡", description = "è·å–ç”¨æˆ·é¦–é¡µç»Ÿè®¡æ•°æ®")
@PreAuthorize("hasRole('CUSTOMER') or hasRole('MANAGER')")
public ResponseEntity<?> getUserStats(
        @Parameter(description = "ç”¨æˆ·ID", required = true)
        @RequestAttribute Long userId,
        Authentication authentication) {
    try {
        // è·å–å½“å‰ç”¨æˆ·è§’è‰²
        String userRole = authentication.getAuthorities().stream()
            .findFirst()
            .map(authority -> authority.getAuthority())
            .orElse("ROLE_CUSTOMER");
        
        if ("ROLE_MANAGER".equals(userRole)) {
            // å®¢æˆ·ç»ç† - è·å–ç®¡ç†çš„å®¢æˆ·å’Œè®¢å•ç»Ÿè®¡
            return getManagerStats(userId);
        } else {
            // æ™®é€šå®¢æˆ· - è·å–ä¸ªäººç»Ÿè®¡
            return getCustomerStats(userId);
        }
    } catch (Exception e) {
        log.error("è·å–ç”¨æˆ·ç»Ÿè®¡å¤±è´¥: userId={}", userId, e);
        return ResponseUtil.error(e.getMessage());
    }
}

/**
 * è·å–å®¢æˆ·ç»ç†ç»Ÿè®¡ä¿¡æ¯
 */
private ResponseEntity<?> getManagerStats(Long userId) {
    Employee employee = userService.findEmployeeById(userId);
    
    // æ„å»ºè¿”å›æ•°æ®
    Map<String, Object> managerStats = new java.util.HashMap<>();
    managerStats.put("employeeId", employee.getId());
    managerStats.put("employeeName", employee.getName());
    managerStats.put("employeeNo", employee.getEmployeeNo());
    managerStats.put("managedCustomerCount", 0L); // TODO: å®ç°å…·ä½“ç»Ÿè®¡
    managerStats.put("managedOrderCount", 0L); // TODO: å®ç°å…·ä½“ç»Ÿè®¡
    managerStats.put("managedOrderAmount", BigDecimal.ZERO); // TODO: å®ç°å…·ä½“ç»Ÿè®¡
    managerStats.put("newCustomersThisMonth", 0L); // TODO: å®ç°å…·ä½“ç»Ÿè®¡
    managerStats.put("userType", "manager");
    
    return ResponseUtil.success(managerStats, "è·å–æˆåŠŸ");
}
```

**3. æœåŠ¡å±‚æ·»åŠ å‘˜å·¥æŸ¥è¯¢æ–¹æ³• (UserService.java å’Œ UserServiceImpl.java)**ï¼š
```java
// UserService.java
/**
 * æ ¹æ®IDæŸ¥è¯¢å‘˜å·¥
 */
Employee findEmployeeById(Long id);

// UserServiceImpl.java
@Override
public Employee findEmployeeById(Long id) {
    Employee employee = employeeMapper.selectById(id);
    if (employee == null) {
        throw new BusinessException("å‘˜å·¥ä¸å­˜åœ¨");
    }
    return employee;
}
```

### 7. å®¢æˆ·ç»ç†èœå•æƒé™é—®é¢˜ä¿®å¤ ğŸ†•

**é—®é¢˜åŸå› **ï¼š
1. **æƒé™é…ç½®ä¸å®Œæ•´**ï¼š`role-manager.js` ä¸­çš„å®¢æˆ·ç»ç†é¡µé¢æƒé™é…ç½®ç¼ºå°‘å®é™…èœå•ä¸­ä½¿ç”¨çš„é¡µé¢è·¯å¾„
2. **é¦–é¡µè·¯å¾„ä¸ä¸€è‡´**ï¼š`getHomePage()` è¿”å›çš„è·¯å¾„ä¸ `custom-tab-bar` ä¸­é…ç½®çš„è·¯å¾„ä¸ä¸€è‡´
3. **ç”¨æˆ·ç±»å‹ç¼ºå¤±**ï¼šå‰ç«¯APIå“åº”æ ¼å¼åŒ–æ—¶æ²¡æœ‰æ­£ç¡®æå–å’Œè½¬æ¢ `userType` å­—æ®µ
4. **æƒé™æ£€æŸ¥é€»è¾‘é—®é¢˜**ï¼šç¼ºå°‘è°ƒè¯•ä¿¡æ¯ï¼Œéš¾ä»¥å®šä½å…·ä½“é—®é¢˜

#### ä¿®å¤æ–¹æ¡ˆ

**1. å®Œå–„æƒé™é…ç½® (role-manager.js)**ï¼š
```javascript
[USER_TYPES.MANAGER]: {
  pages: [
    '/pages/manager/index/index',
    '/pages/manager/workplace/workplace',        // æ–°å¢ï¼šå·¥ä½œå°
    '/pages/manager/customers/customers',
    '/pages/manager/customers/list',             // æ–°å¢ï¼šå®¢æˆ·åˆ—è¡¨
    '/pages/manager/customers/detail/detail',
    '/pages/manager/customers/add',              // æ–°å¢ï¼šæ·»åŠ å®¢æˆ·
    '/pages/manager/customer-add/customer-add',
    '/pages/manager/follow/follow',
    '/pages/manager/follow/list',                // æ–°å¢ï¼šè·Ÿè¿›åˆ—è¡¨
    '/pages/manager/follow/add',                 // æ–°å¢ï¼šæ·»åŠ è·Ÿè¿›
    '/pages/manager/service/service',
    '/pages/manager/service/index',              // æ–°å¢ï¼šæœåŠ¡é¦–é¡µ
    '/pages/manager/performance/performance',
    '/pages/manager/performance/index',          // æ–°å¢ï¼šä¸šç»©é¦–é¡µ
    '/pages/manager/maintenance/maintenance',
    '/pages/manager/maintenance/index',          // æ–°å¢ï¼šç»´æŠ¤é¦–é¡µ
    '/pages/manager/renewal/renewal',
    '/pages/manager/renewal/index',              // æ–°å¢ï¼šç»­è´¹é¦–é¡µ
    '/pages/manager/profile/index',              // æ–°å¢ï¼šæˆ‘çš„é¡µé¢
    '/pages/manager/profile/change-password',    // æ–°å¢ï¼šä¿®æ”¹å¯†ç 
    '/pages/manager/profile/edit',               // æ–°å¢ï¼šç¼–è¾‘èµ„æ–™
    '/pages/products/index/index',
    '/pages/products/detail/detail',
    '/pages/products/calculator/calculator',
    '/pages/orders/index/index',
    '/pages/orders/create/create',
    '/pages/orders/detail/detail',
    '/pages/profile/index/index'
  ],
  // ... tabbaré…ç½®
}
```

**2. ä¿®æ­£é¦–é¡µè·¯å¾„é…ç½® (role-manager.js)**ï¼š
```javascript
getHomePage() {
  const userType = this.getCurrentUserType()
  console.log('è·å–é¦–é¡µè·¯å¾„ï¼Œå½“å‰ç”¨æˆ·ç±»å‹:', userType)
  
  let homePage
  if (userType === USER_TYPES.MANAGER) {
    // ä¸è‡ªå®šä¹‰tabBarä¸­çš„ç¬¬ä¸€ä¸ªtabä¿æŒä¸€è‡´
    homePage = '/pages/manager/workplace/workplace'  // ä¿®æ”¹ä¸ºæ­£ç¡®è·¯å¾„
  } else {
    homePage = '/pages/index/index'
  }
  
  console.log('è·å–åˆ°çš„é¦–é¡µè·¯å¾„:', homePage)
  return homePage
}
```

**3. ä¿®å¤APIå“åº”æ ¼å¼åŒ– (api.js)**ï¼š
```javascript
// æ ¼å¼åŒ–è®¤è¯å“åº”
const formatAuthResponse = (response) => {
  if (!response || !response.data) return null;
  
  // å…¼å®¹ä¸¤ç§æ•°æ®ç»“æ„
  const data = response.data;
  const token = data.token || data.accessToken;
  const refreshToken = data.refreshToken;
  const userInfo = data.userInfo || data;
  
  // æå–å¹¶è½¬æ¢ç”¨æˆ·ç±»å‹
  const userRole = data.userRole || userInfo.role || userInfo.userRole;
  const userType = userRole === 'manager' ? 'manager' : 'customer';

  if (!token) {
    console.error('è®¤è¯å“åº”ç¼ºå°‘token:', response);
    return null;
  }

  console.log('æ ¼å¼åŒ–è®¤è¯å“åº”:', { 
    userRole, 
    userType, 
    hasToken: !!token,
    userInfo: formatUserInfo(userInfo) 
  });

  return {
    token,
    refreshToken,
    userType,  // æ·»åŠ ç”¨æˆ·ç±»å‹å­—æ®µ
    userInfo: formatUserInfo(userInfo)
  };
};
```

**4. å¢å¼ºæƒé™æ£€æŸ¥è°ƒè¯• (role-manager.js)**ï¼š
```javascript
checkPagePermission(pagePath) {
  const userType = this.getCurrentUserType()
  console.log('æ£€æŸ¥é¡µé¢æƒé™:', { pagePath, userType })
  
  if (!userType) {
    console.log('æƒé™æ£€æŸ¥å¤±è´¥: ç”¨æˆ·ç±»å‹ä¸ºç©º')
    return false
  }
  
  const permissions = ROLE_PERMISSIONS[userType]
  if (!permissions) {
    console.log('æƒé™æ£€æŸ¥å¤±è´¥: æœªæ‰¾åˆ°ç”¨æˆ·ç±»å‹å¯¹åº”çš„æƒé™é…ç½®', userType)
    return false
  }
  
  const hasPermission = permissions.pages.includes(pagePath)
  console.log('æƒé™æ£€æŸ¥ç»“æœ:', { 
    pagePath, 
    userType, 
    hasPermission,
    availablePages: permissions.pages 
  })
  
  return hasPermission
}

getCurrentUserType() {
  if (!this.currentUserType) {
    this.currentUserType = wx.getStorageSync('userType')
    console.log('ä»æœ¬åœ°å­˜å‚¨è·å–ç”¨æˆ·ç±»å‹:', this.currentUserType)
  }
  return this.currentUserType
}
```

#### ä¿®å¤åçš„æ•ˆæœ

ç°åœ¨å®¢æˆ·ç»ç†ç™»å½•åï¼š
1. âœ… ç”¨æˆ·ç±»å‹æ­£ç¡®è®¾ç½®ä¸º 'manager'
2. âœ… æ‰€æœ‰åº•éƒ¨èœå•æ é¡µé¢éƒ½æœ‰è®¿é—®æƒé™
3. âœ… é¦–é¡µè·³è½¬åˆ°æ­£ç¡®çš„å·¥ä½œå°é¡µé¢
4. âœ… æƒé™æ£€æŸ¥æœ‰è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
5. âœ… æ”¯æŒæ‰€æœ‰å®¢æˆ·ç»ç†ç›¸å…³çš„é¡µé¢è®¿é—®

## ä¿®å¤åçš„æ•ˆæœ

### æ™®é€šå®¢æˆ·ç™»å½•æµç¨‹
1. é€‰æ‹©"æ™®é€šå®¢æˆ·"ç™»å½•ç±»å‹
2. å¯ä»¥é€‰æ‹©å¾®ä¿¡ç™»å½•ã€å¯†ç ç™»å½•æˆ–çŸ­ä¿¡éªŒè¯ç ç™»å½•
3. å¯†ç ç™»å½•æ—¶è¾“å…¥æ‰‹æœºå·å’Œå¯†ç 
4. ç™»å½•æˆåŠŸåè·³è½¬åˆ°å®¢æˆ·é¦–é¡µ
5. è°ƒç”¨ `/mini/user/profile` è¿”å›å®¢æˆ·ä¿¡æ¯
6. è°ƒç”¨ `/mini/user/stats` è¿”å›å®¢æˆ·ç»Ÿè®¡ä¿¡æ¯

### å®¢æˆ·ç»ç†ç™»å½•æµç¨‹ ğŸ†•
1. é€‰æ‹©"å®¢æˆ·ç»ç†"ç™»å½•ç±»å‹
2. åªèƒ½é€‰æ‹©å¾®ä¿¡ç™»å½•æˆ–å¯†ç ç™»å½•ï¼ˆä¸æ”¯æŒçŸ­ä¿¡éªŒè¯ç ï¼‰
3. å¯†ç ç™»å½•æ—¶è¾“å…¥ç”¨æˆ·åï¼ˆå‘˜å·¥å·ï¼‰å’Œå¯†ç 
4. ç³»ç»Ÿåœ¨å‘˜å·¥è¡¨ä¸­éªŒè¯èº«ä»½
5. ç™»å½•æˆåŠŸåè·³è½¬åˆ°å®¢æˆ·ç»ç†å·¥ä½œå°
6. è°ƒç”¨ `/mini/user/profile` è¿”å›å‘˜å·¥ä¿¡æ¯
7. è°ƒç”¨ `/mini/user/stats` è¿”å›å‘˜å·¥ç®¡ç†çš„å®¢æˆ·ç»Ÿè®¡ä¿¡æ¯
8. âœ… **æ‰€æœ‰åº•éƒ¨èœå•æ éƒ½èƒ½æ­£å¸¸ç‚¹å‡»è¿›å…¥ï¼Œä¸å†æç¤ºæ²¡æœ‰æƒé™**

### æ¥å£è¿”å›æ•°æ®å¯¹æ¯”

#### å®¢æˆ· Profile æ¥å£è¿”å›æ•°æ®ï¼š
```json
{
  "id": 123,
  "phone": "13800138000",
  "name": "å¼ ä¸‰",
  "companyName": "XXå…¬å¸",
  "authStatus": "verified",
  "userType": "customer",
  // ... å…¶ä»–å®¢æˆ·å­—æ®µ
}
```

#### å®¢æˆ·ç»ç† Profile æ¥å£è¿”å›æ•°æ®ï¼š
```json
{
  "id": 456,
  "employeeNo": "EMP001",
  "name": "æå››",
  "phone": "13900139000",
  "email": "lisi@company.com",
  "role": "CUSTOMER_MANAGER",
  "status": "active",
  "userType": "manager",
  "departmentId": 1,
  "position": "å®¢æˆ·ç»ç†",
  // ... å…¶ä»–å‘˜å·¥å­—æ®µ
}
```

#### å®¢æˆ· Stats æ¥å£è¿”å›æ•°æ®ï¼š
```json
{
  "orderCount": 5,
  "totalAmount": 12500.00,
  "thisMonthAmount": 3500.00,
  "userType": "customer",
  // ... å…¶ä»–å®¢æˆ·ç»Ÿè®¡
}
```

#### å®¢æˆ·ç»ç† Stats æ¥å£è¿”å›æ•°æ®ï¼š
```json
{
  "employeeId": 456,
  "employeeName": "æå››",
  "employeeNo": "EMP001",
  "managedCustomerCount": 25,
  "managedOrderCount": 150,
  "managedOrderAmount": 285000.00,
  "newCustomersThisMonth": 5,
  "userType": "manager"
}
```

## æµ‹è¯•å»ºè®®

### 1. å®¢æˆ·ç»ç†ç™»å½•æµ‹è¯• ğŸ†•
- æµ‹è¯•ä½¿ç”¨æ­£ç¡®çš„å‘˜å·¥ç”¨æˆ·åå’Œå¯†ç ç™»å½•
- æµ‹è¯•ä½¿ç”¨é”™è¯¯çš„ç”¨æˆ·åæˆ–å¯†ç ç™»å½•
- æµ‹è¯•å®¢æˆ·ç»ç†è´¦æˆ·çŠ¶æ€éªŒè¯ï¼ˆç¦ç”¨è´¦æˆ·ç­‰ï¼‰
- æµ‹è¯•è§’è‰²æƒé™éªŒè¯ï¼ˆéå®¢æˆ·ç»ç†è§’è‰²ï¼‰
- æµ‹è¯•ç™»å½•åé¡µé¢è·³è½¬å’Œèœå•æ˜¾ç¤º

### 2. æ™®é€šå®¢æˆ·ç™»å½•æµ‹è¯•
- æµ‹è¯•æ‰‹æœºå·å¯†ç ç™»å½•åŠŸèƒ½
- æµ‹è¯•çŸ­ä¿¡éªŒè¯ç ç™»å½•åŠŸèƒ½
- æµ‹è¯•å¾®ä¿¡ç™»å½•åŠŸèƒ½
- ç¡®ä¿åŸæœ‰åŠŸèƒ½ä¸å—å½±å“

### 3. æ¥å£æ•°æ®æµ‹è¯• ğŸ†•
- æµ‹è¯•å®¢æˆ·ç™»å½•åè°ƒç”¨ `/mini/user/profile` è¿”å›å®¢æˆ·æ•°æ®
- æµ‹è¯•å®¢æˆ·ç»ç†ç™»å½•åè°ƒç”¨ `/mini/user/profile` è¿”å›å‘˜å·¥æ•°æ®
- æµ‹è¯•å®¢æˆ·ç™»å½•åè°ƒç”¨ `/mini/user/stats` è¿”å›å®¢æˆ·ç»Ÿè®¡
- æµ‹è¯•å®¢æˆ·ç»ç†ç™»å½•åè°ƒç”¨ `/mini/user/stats` è¿”å›å‘˜å·¥ç»Ÿè®¡
- æµ‹è¯•æ¥å£æƒé™éªŒè¯ï¼ˆæœªç™»å½•ã€æƒé™ä¸è¶³ç­‰ï¼‰

### 4. èœå•æƒé™æµ‹è¯• ğŸ†•
- âœ… æµ‹è¯•å®¢æˆ·ç»ç†ç™»å½•åèƒ½è®¿é—®æ‰€æœ‰åº•éƒ¨èœå•é¡µé¢
- âœ… æµ‹è¯•å®¢æˆ·ç»ç†èƒ½è®¿é—®å·¥ä½œå°ã€å®¢æˆ·ç®¡ç†ã€è·Ÿè¿›ç®¡ç†ã€ä¸šç»©æŸ¥çœ‹ã€æˆ‘çš„ç­‰é¡µé¢
- æµ‹è¯•æ™®é€šå®¢æˆ·ä¸èƒ½è®¿é—®å®¢æˆ·ç»ç†ä¸“ç”¨é¡µé¢
- æµ‹è¯•æƒé™æ£€æŸ¥çš„è°ƒè¯•ä¿¡æ¯æ˜¯å¦æ­£ç¡®è¾“å‡º
- æµ‹è¯•é¡µé¢è·³è½¬æ˜¯å¦æ­£å¸¸

### 5. ç•Œé¢äº¤äº’æµ‹è¯• ğŸ†•
- æµ‹è¯•ç™»å½•ç±»å‹åˆ‡æ¢æ—¶è¾“å…¥æ¡†çš„å˜åŒ–
- æµ‹è¯•å®¢æˆ·ç»ç†ç±»å‹ä¸‹çŸ­ä¿¡éªŒè¯ç é€‰é¡¹éšè—
- æµ‹è¯•åˆ‡æ¢åˆ°å®¢æˆ·ç»ç†æ—¶è‡ªåŠ¨ä»çŸ­ä¿¡ç™»å½•åˆ‡æ¢åˆ°å¯†ç ç™»å½•
- æµ‹è¯•å¿˜è®°å¯†ç é“¾æ¥åªåœ¨æ™®é€šå®¢æˆ·æ—¶æ˜¾ç¤º

## æŠ€æœ¯è¦ç‚¹

1. **ç™»å½•æ–¹å¼åˆ†ç¦»**ï¼šå®¢æˆ·ç»ç†ä½¿ç”¨ç”¨æˆ·åï¼Œæ™®é€šå®¢æˆ·ä½¿ç”¨æ‰‹æœºå·
2. **æ•°æ®è¡¨åˆ†ç¦»**ï¼šå®¢æˆ·åœ¨ `user` è¡¨ï¼Œå®¢æˆ·ç»ç†åœ¨ `employee` è¡¨
3. **å­—æ®µæ˜ å°„**ï¼šç”¨æˆ·åå¯¹åº”å‘˜å·¥è¡¨çš„ `employeeNo` å­—æ®µ
4. **åŠŸèƒ½é™åˆ¶**ï¼šå®¢æˆ·ç»ç†ä¸æ”¯æŒçŸ­ä¿¡éªŒè¯ç ç™»å½•å’Œå¿˜è®°å¯†ç 
5. **å‚æ•°éªŒè¯**ï¼šæ ¹æ® `loginType` åŠ¨æ€éªŒè¯å¿…å¡«å­—æ®µ
6. **é”™è¯¯æç¤º**ï¼šå®¢æˆ·ç»ç†ç™»å½•æ˜¾ç¤º"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"
7. **ç•Œé¢é€‚é…**ï¼šæ ¹æ®ç”¨æˆ·ç±»å‹åŠ¨æ€è°ƒæ•´ç•Œé¢å…ƒç´ 
8. **æ¥å£æƒé™**ï¼šä½¿ç”¨ `@PreAuthorize("hasRole('CUSTOMER') or hasRole('MANAGER')")` æ”¯æŒåŒè§’è‰²
9. **æ•°æ®åŒºåˆ†**ï¼šæ ¹æ®ç”¨æˆ·è§’è‰²è¿”å›ä¸åŒçš„æ•°æ®ç»“æ„
10. **ç»Ÿè®¡ä¿¡æ¯**ï¼šå®¢æˆ·ç»ç†ç»Ÿè®¡ç®¡ç†çš„å®¢æˆ·æ•°é‡å’Œè®¢å•ä¿¡æ¯
11. **æƒé™é…ç½®**ï¼šå®Œæ•´é…ç½®å®¢æˆ·ç»ç†å¯è®¿é—®çš„æ‰€æœ‰é¡µé¢è·¯å¾„
12. **å“åº”æ ¼å¼åŒ–**ï¼šæ­£ç¡®æå–å’Œè½¬æ¢ç”¨æˆ·ç±»å‹å­—æ®µ
13. **è°ƒè¯•æ”¯æŒ**ï¼šæ·»åŠ è¯¦ç»†çš„æƒé™æ£€æŸ¥å’Œç”¨æˆ·ç±»å‹è·å–æ—¥å¿—

## æ³¨æ„äº‹é¡¹

1. âœ… åç«¯å·²ç»æ”¯æŒå®¢æˆ·ç»ç†ç”¨æˆ·åç™»å½•
2. âœ… å‰ç«¯å·²ç»é€‚é…ä¸åŒç™»å½•æ–¹å¼çš„ç•Œé¢
3. âœ… å®¢æˆ·ç»ç†åŠŸèƒ½å·²ç»é™åˆ¶ï¼ˆæ— çŸ­ä¿¡ç™»å½•ã€æ— å¿˜è®°å¯†ç ï¼‰
4. âœ… å‚æ•°éªŒè¯å·²ç»å®Œå–„
5. âœ… æ‰€æœ‰ä¿®æ”¹ä¿æŒå‘åå…¼å®¹æ€§
6. âœ… æ¥å£æƒé™å·²ç»è°ƒæ•´æ”¯æŒå®¢æˆ·ç»ç†è§’è‰²
7. âœ… æ¥å£æ•°æ®å·²ç»æ ¹æ®ç”¨æˆ·ç±»å‹åŒºåˆ†
8. âœ… å®¢æˆ·ç»ç†èœå•æƒé™é—®é¢˜å·²å®Œå…¨ä¿®å¤
9. âœ… é¦–é¡µè·¯å¾„é…ç½®å·²ç»Ÿä¸€
10. âœ… APIå“åº”æ ¼å¼åŒ–å·²å®Œå–„ï¼Œæ­£ç¡®å¤„ç†userTypeå­—æ®µ
11. ğŸ” éœ€è¦ç¡®ä¿å‘˜å·¥è¡¨ä¸­çš„ `employeeNo` å­—æ®µå·²æ­£ç¡®è®¾ç½®
12. ğŸ” éœ€è¦ç¡®ä¿å‘˜å·¥å¯†ç å·²æ­£ç¡®åŠ å¯†å­˜å‚¨
13. ğŸ“ éœ€è¦å®ç°å…·ä½“çš„å®¢æˆ·ç»ç†ç»Ÿè®¡æ–¹æ³•ï¼ˆç›®å‰è¿”å›ä¸´æ—¶æ•°æ®ï¼‰

## æ•°æ®åº“è¦æ±‚

ç¡®ä¿ `employee` è¡¨åŒ…å«ä»¥ä¸‹å¿…è¦å­—æ®µï¼š
- `employee_no`ï¼šå‘˜å·¥å·¥å·/ç™»å½•ç”¨æˆ·åï¼ˆå”¯ä¸€ï¼‰
- `password`ï¼šåŠ å¯†åçš„å¯†ç 
- `name`ï¼šå‘˜å·¥å§“å
- `phone`ï¼šå‘˜å·¥æ‰‹æœºå·
- `role`ï¼šå‘˜å·¥è§’è‰²ï¼ˆCUSTOMER_MANAGER æˆ– MANAGERï¼‰
- `status`ï¼šè´¦æˆ·çŠ¶æ€ï¼ˆactive/inactiveï¼‰

ç¡®ä¿ `user` è¡¨åŒ…å«ä»¥ä¸‹å…³è”å­—æ®µï¼š
- `assigned_employee_id`ï¼šåˆ†é…çš„å®¢æˆ·ç»ç†ID
- `business_manager_name`ï¼šä¸šåŠ¡ç»ç†å§“å
- `business_manager_no`ï¼šä¸šåŠ¡ç»ç†å·¥å·

## ä¸‹ä¸€æ­¥è®¡åˆ’

1. **æ•°æ®åˆå§‹åŒ–**ï¼šç¡®ä¿æ‰€æœ‰å®¢æˆ·ç»ç†è´¦æˆ·çš„ `employeeNo` å·²æ­£ç¡®è®¾ç½®
2. **å¯†ç ç®¡ç†**ï¼šä¸ºå®¢æˆ·ç»ç†æä¾›å¯†ç é‡ç½®åŠŸèƒ½ï¼ˆç®¡ç†å‘˜é‡ç½®ï¼‰
3. **ç»Ÿè®¡æ–¹æ³•å®ç°**ï¼šå®ç°å®¢æˆ·ç»ç†çš„å…·ä½“ç»Ÿè®¡æ–¹æ³•
   - `countCustomersByManager(userId)` - ç»Ÿè®¡ç®¡ç†çš„å®¢æˆ·æ•°é‡
   - `countOrdersByManager(userId)` - ç»Ÿè®¡ç®¡ç†çš„è®¢å•æ•°é‡
   - `getTotalOrderAmountByManager(userId)` - ç»Ÿè®¡ç®¡ç†çš„è®¢å•æ€»é‡‘é¢
   - `countNewCustomersThisMonthByManager(userId)` - ç»Ÿè®¡æœ¬æœˆæ–°å¢å®¢æˆ·æ•°é‡
4. **ç”¨æˆ·ä½“éªŒ**ï¼šç»§ç»­ä¼˜åŒ–ç™»å½•æµç¨‹å’Œé”™è¯¯æç¤º
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šä¼˜åŒ–ç»Ÿè®¡æŸ¥è¯¢çš„æ€§èƒ½
6. **æƒé™ç»†åŒ–**ï¼šæ ¹æ®å…·ä½“ä¸šåŠ¡éœ€æ±‚è¿›ä¸€æ­¥ç»†åŒ–æƒé™æ§åˆ¶
7. **æµ‹è¯•å®Œå–„**ï¼šå…¨é¢æµ‹è¯•å®¢æˆ·ç»ç†çš„æ‰€æœ‰åŠŸèƒ½é¡µé¢
8. **æ—¥å¿—æ¸…ç†**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç§»é™¤è°ƒè¯•æ—¥å¿— 