<!--pages/menu/user/profile/index/index.wxml-->
<view class="container">
  <!-- ä¸‹æ‹‰åˆ·æ–°æç¤º -->
  <view class="refresh-tip" wx:if="{{refreshing}}">
    <van-loading size="20px" type="spinner" />
    <text>æ­£åœ¨åˆ·æ–°...</text>
  </view>

  <!-- é¡¶éƒ¨èƒŒæ™¯ -->
  <view class="header-bg"></view>

  <!-- ç”¨æˆ·ä¿¡æ¯ -->
  <view class="user-section">
    <view class="user-info" bindtap="onAvatarTap">
      <view class="avatar-wrapper">
        <block wx:if="{{userInfo.avatarUrl || userInfo.avatar}}">
          <image class="avatar" src="{{ userInfo.avatarUrl || userInfo.avatar }}" mode="aspectFill"/>
        </block>
        <block wx:else>
          <view class="avatar default-avatar">ğŸ‘¤</view>
        </block>
        <view class="user-level" wx:if="{{userInfo.userLevel}}">{{userInfo.userLevel}}</view>
      </view>
      <view class="info-right">
        <view class="name-row">
          <text class="name">{{ userInfo.nickName || userInfo.realName || userInfo.name || (isLoggedIn ? 'å¾®ä¿¡ç”¨æˆ·' : 'æœªç™»å½•') }}</text>
          <view class="edit-profile" catchtap="navigateTo" data-url="/pages/profile/info/info" wx:if="{{isLoggedIn}}">
            <text>ç¼–è¾‘èµ„æ–™</text>
            <van-icon name="arrow" />
          </view>
        </view>
        <!-- è®¤è¯çŠ¶æ€ -->
        <view class="auth-status" wx:if="{{isLoggedIn}}">
          <view class="auth-badge {{userInfo.authStatus === 'verified' ? 'verified' : userInfo.authStatus === 'pending' ? 'pending' : 'unverified'}}" 
                bindtap="{{userInfo.authStatus !== 'verified' ? 'goToAuth' : ''}}"
                data-status="{{userInfo.authStatus}}">
            <view class="auth-main">
              <text class="auth-icon">{{userInfo.authStatus === 'verified' ? 'âœ“' : userInfo.authStatus === 'pending' ? 'â³' : '!'}}</text>
              <text class="auth-text">
                {{userInfo.authStatus === 'verified' ? 'ä¼ä¸šå·²è®¤è¯' : userInfo.authStatus === 'pending' ? 'è®¤è¯å®¡æ ¸ä¸­' : 'ä¼ä¸šæœªè®¤è¯'}}
              </text>
            </view>
            <view class="auth-action" wx:if="{{userInfo.authStatus !== 'verified'}}">
              <text class="action-text">{{userInfo.authStatus === 'pending' ? 'æŸ¥çœ‹è¿›åº¦' : 'ç«‹å³è®¤è¯'}}</text>
              <text class="action-arrow">â€º</text>
            </view>
          </view>
        </view>
        <view class="manager-info" 
              wx:if="{{ userInfo.managerName }}" 
              bindtap="contactManager">
          <text class="manager-label">ä¸“å±ç»ç†ï¼š</text>
          <text class="manager-name">{{ userInfo.managerName }}</text>
          <text class="manager-action">ç‚¹å‡»è”ç³»</text>
        </view>
        <view class="manager-info unbound" 
              wx:if="{{ !userInfo.managerName && isLoggedIn }}" 
              bindtap="showManagerInputDialog">
          <text class="manager-label">ä¸“å±ç»ç†ï¼š</text>
          <text class="manager-bind">ç‚¹å‡»ç»‘å®šå®¢æˆ·ç»ç†</text>
        </view>
        <view class="join-date" wx:if="{{ userInfo.createTime }}">
          <text class="join-label">åŠ å…¥æ—¶é—´ï¼š</text>
          <text class="join-time">{{ userInfo.createTime }}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ•°æ®æ¦‚è§ˆå¡ç‰‡ -->
  <view class="stats-card">
    <view class="stat-item" bindtap="onStatsTap" data-type="orders">
      <text class="value">{{ stats.orderCount || 0 }}</text>
      <text class="label">è®¢å•æ•°</text>
    </view>
    <view class="divider"></view>
    <view class="stat-item" bindtap="onStatsTap" data-type="contracts">
      <text class="value">{{ stats.contractCount || 0 }}</text>
      <text class="label">åˆåŒæ•°</text>
    </view>
    <view class="divider"></view>
    <view class="stat-item" bindtap="onStatsTap" data-type="power-points">
      <text class="value">{{ stats.powerPoints || 0 }}</text>
      <text class="label">ç”¨ç”µæˆ·å·</text>
    </view>
  </view>


  <!-- å¿«æ·åŠŸèƒ½åŒº -->
  <view class="quick-actions">
    <view class="quick-action-item" wx:for="{{quickActions}}" wx:key="id"
          bindtap="onQuickActionTap" data-id="{{item.id}}">
      <view class="icon-wrapper" style="background-color: {{item.color}}">
        <text class="icon-text">{{item.icon}}</text>
      </view>
      <text>{{item.title}}</text>
    </view>
  </view>


  <!-- åŠŸèƒ½èœå• -->
  <view class="menu-section">
    <view class="menu-list">
      <view class="menu-item" wx:for="{{menuItems}}" wx:key="id"
            bindtap="onMenuTap" data-id="{{item.id}}" data-url="{{item.url}}">
        <view class="menu-item-left">
          <text class="menu-icon">{{item.icon}}</text>
          <view class="text-wrapper">
            <text class="title">{{item.title}}</text>
            <text class="subtitle" wx:if="{{item.subtitle}}">{{item.subtitle}}</text>
          </view>
        </view>
        <view class="menu-item-right">
          <view class="badge" wx:if="{{item.badge > 0}}">{{item.badge}}</view>
          <van-icon name="arrow" />
        </view>
      </view>
    </view>

    <!-- ç™»å½•/é€€å‡ºæŒ‰é’® -->
    <view class="action-button">
      <block wx:if="{{!isLoggedIn}}">
        <button class="login-btn" bindtap="onAuthConfirm">
          <text class="btn-icon">ğŸ”‘</text>
          <text>ç«‹å³ç™»å½•</text>
        </button>
      </block>
      <block wx:else>
        <button class="logout-btn" bindtap="handleLogout">
          <text class="btn-icon">ğŸšª</text>
          <text>é€€å‡ºç™»å½•</text>
        </button>
      </block>
    </view>
  </view>

  <!-- æˆæƒç™»å½•å¼¹çª— -->
  <van-dialog
    use-slot
    title="ç™»å½•æç¤º"
    show="{{ showAuthDialog }}"
    show-cancel-button
    confirm-button-text="å»ç™»å½•"
    cancel-button-text="æš‚ä¸ç™»å½•"
    bind:confirm="onAuthConfirm"
    bind:cancel="onAuthCancel"
  >
    <view class="auth-dialog-content">
      <text>ç™»å½•åå³å¯ä½¿ç”¨å®Œæ•´åŠŸèƒ½</text>
    </view>
  </van-dialog>

  <!-- ç»‘å®šå®¢æˆ·ç»ç†å¼¹çª— -->
  <view class="manager-dialog-overlay" wx:if="{{showManagerDialog}}" bindtap="closeManagerDialog">
    <view class="manager-dialog" catchtap="stopPropagation">
      <view class="dialog-header">
        <text class="dialog-title">ç»‘å®šå®¢æˆ·ç»ç†</text>
        <view class="dialog-close" bindtap="closeManagerDialog">âœ•</view>
      </view>
      
      <view class="dialog-content">
        <view class="input-section">
          <text class="input-label">å®¢æˆ·ç»ç†æ‰‹æœºå·</text>
          <input class="manager-phone-input" 
                 type="number"
                 placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·ç "
                 value="{{managerPhone}}"
                 bindinput="onManagerPhoneInput"
                 maxlength="11" />
        </view>
        
        <view class="dialog-tip">
          <text class="tip-icon">ğŸ’¡</text>
          <text class="tip-text">è¯·è¾“å…¥æ‚¨çš„ä¸“å±å®¢æˆ·ç»ç†æ‰‹æœºå·ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨éªŒè¯å¹¶ç»‘å®š</text>
        </view>
      </view>
      
      <view class="dialog-footer">
        <button class="cancel-btn" bindtap="closeManagerDialog">å–æ¶ˆ</button>
        <button class="confirm-btn" bindtap="confirmBindManager">ç¡®è®¤ç»‘å®š</button>
      </view>
    </view>
  </view>


</view> 