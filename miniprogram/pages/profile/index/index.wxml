<!--pages/profile/index/index.wxml-->
<view class="container {{loading ? 'loading' : ''}}">
  <!-- ä¸‹æ‹‰åˆ·æ–°æç¤º -->
  <view class="refresh-tip" wx:if="{{refreshing}}">
    <van-loading size="20px" type="spinner" />
    <text>æ­£åœ¨åˆ·æ–°...</text>
  </view>

  <!-- é¡¶éƒ¨èƒŒæ™¯ -->
  <view class="header-bg"></view>

  <!-- ç”¨æˆ·ä¿¡æ¯ -->
  <view class="user-section">
    <view class="user-info" bindtap="onAvatarTap">
      <view class="avatar-wrapper">
        <block wx:if="{{userInfo.avatarUrl || userInfo.avatar}}">
          <image class="avatar" src="{{ userInfo.avatarUrl || userInfo.avatar }}" mode="aspectFill"/>
        </block>
        <block wx:else>
          <view class="avatar default-avatar">ğŸ‘¤</view>
        </block>
        <view class="user-level" wx:if="{{userInfo.userLevel}}">{{userInfo.userLevel}}</view>
      </view>
      <view class="info-right">
        <view class="name-row">
          <text class="name">{{ userInfo.nickName || userInfo.realName || userInfo.name || (isLoggedIn ? 'å¾®ä¿¡ç”¨æˆ·' : 'æœªç™»å½•') }}</text>
          <view class="edit-profile" catchtap="navigateTo" data-url="/pages/profile/info/info" wx:if="{{isLoggedIn}}">
            <text>ç¼–è¾‘èµ„æ–™</text>
            <van-icon name="arrow" />
          </view>
        </view>
        <!-- è®¤è¯çŠ¶æ€ -->
        <view class="auth-status" wx:if="{{isLoggedIn}}">
          <view class="auth-badge {{userInfo.authStatus === 'verified' ? 'verified' : userInfo.authStatus === 'pending' ? 'pending' : 'unverified'}}" 
                bindtap="{{userInfo.authStatus !== 'verified' ? 'goToAuth' : ''}}"
                data-status="{{userInfo.authStatus}}">
            <text class="auth-icon">{{userInfo.authStatus === 'verified' ? 'âœ“' : userInfo.authStatus === 'pending' ? 'â³' : '!'}}</text>
            <text class="auth-text">
              {{userInfo.authStatus === 'verified' ? 'å·²è®¤è¯' : userInfo.authStatus === 'pending' ? 'è®¤è¯ä¸­' : 'æœªè®¤è¯'}}
            </text>
            <text class="auth-action" wx:if="{{userInfo.authStatus !== 'verified'}}">ç‚¹å‡»{{userInfo.authStatus === 'pending' ? 'æŸ¥çœ‹' : 'è®¤è¯'}}</text>
          </view>
        </view>
        <view class="company" wx:if="{{ userInfo.companyName }}">{{ userInfo.companyName }}</view>
        <view class="phone" wx:if="{{ userInfo.phone }}">{{ userInfo.phone }}</view>
        <view class="phone" wx:if="{{ userInfo.openId && !userInfo.phone }}">ID: {{ userInfo.openId.substring(0, 10) }}...</view>
      </view>
    </view>
  </view>

  <!-- æ•°æ®æ¦‚è§ˆå¡ç‰‡ -->
  <view class="stats-card">
    <view class="stat-item" bindtap="onStatsTap" data-type="orders">
      <text class="value">{{ stats.orderCount || 0 }}</text>
      <text class="label">è®¢å•æ•°</text>
    </view>
    <view class="divider"></view>
    <view class="stat-item" bindtap="onStatsTap" data-type="contracts">
      <text class="value">{{ stats.contractCount || 0 }}</text>
      <text class="label">åˆåŒæ•°</text>
    </view>
    <view class="divider"></view>
    <view class="stat-item" bindtap="onStatsTap" data-type="power-points">
      <text class="value">{{ stats.powerPoints || 0 }}</text>
      <text class="label">ç”¨ç”µæˆ·å·</text>
    </view>
  </view>

  <!-- ä¸´æ—¶è°ƒè¯•ä¿¡æ¯ -->
  <view style="background: #f0f0f0; padding: 20rpx; margin: 20rpx; border-radius: 10rpx; font-size: 24rpx;" wx:if="{{stats}}">
    <text>è°ƒè¯•ä¿¡æ¯ï¼š</text>
    <text>orderCount: {{stats.orderCount}}</text>
    <text>contractCount: {{stats.contractCount}}</text>
    <text>powerPoints: {{stats.powerPoints}}</text>
  </view>

  <!-- å¿«æ·åŠŸèƒ½åŒº -->
  <view class="quick-actions">
    <view class="quick-action-item" wx:for="{{quickActions}}" wx:key="id"
          bindtap="onQuickActionTap" data-id="{{item.id}}">
      <view class="icon-wrapper" style="background-color: {{item.color}}">
        <text class="icon-text">{{item.icon}}</text>
      </view>
      <text>{{item.title}}</text>
    </view>
  </view>

  <!-- ç”¨ç”µæ•°æ®å¡ç‰‡ -->
  <view class="power-card">
    <view class="card-header">
      <text class="title">æœ¬æœˆç”¨ç”µæ¦‚å†µ</text>
      <text class="more" bindtap="viewPowerData">æŸ¥çœ‹è¯¦æƒ…</text>
    </view>
    <view class="power-stats">
      <view class="power-item">
        <text class="item-label">ç”¨ç”µé‡</text>
        <view class="item-value">
          <text class="number">{{ powerData.monthlyConsumption || 0 }}</text>
          <text class="unit">åº¦</text>
        </view>
      </view>
      <view class="power-item">
        <text class="item-label">ç”µè´¹</text>
        <view class="item-value">
          <text class="number">{{ powerData.monthlyBill || 0 }}</text>
          <text class="unit">å…ƒ</text>
        </view>
      </view>
      <view class="power-item highlight">
        <text class="item-label">èŠ‚çœ</text>
        <view class="item-value">
          <text class="number">{{ powerData.savingRate || 0 }}</text>
          <text class="unit">%</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠŸèƒ½èœå• -->
  <view class="menu-section">
    <view class="menu-list">
      <view class="menu-item" wx:for="{{menuItems}}" wx:key="id"
            bindtap="onMenuTap" data-id="{{item.id}}" data-url="{{item.url}}">
        <view class="menu-item-left">
          <text class="menu-icon">{{item.icon}}</text>
          <view class="text-wrapper">
            <text class="title">{{item.title}}</text>
            <text class="subtitle" wx:if="{{item.subtitle}}">{{item.subtitle}}</text>
          </view>
        </view>
        <view class="menu-item-right">
          <view class="badge" wx:if="{{item.badge > 0}}">{{item.badge}}</view>
          <van-icon name="arrow" />
        </view>
      </view>
    </view>

    <!-- ç™»å½•/é€€å‡ºæŒ‰é’® -->
    <view class="action-button">
      <block wx:if="{{!isLoggedIn}}">
        <button class="login-btn" bindtap="onAuthConfirm">
          <text class="btn-icon">ğŸ”‘</text>
          <text>ç«‹å³ç™»å½•</text>
        </button>
      </block>
      <block wx:else>
        <button class="logout-btn" bindtap="handleLogout">
          <text class="btn-icon">ğŸšª</text>
          <text>é€€å‡ºç™»å½•</text>
        </button>
      </block>
    </view>
  </view>

  <!-- æˆæƒç™»å½•å¼¹çª— -->
  <van-dialog
    use-slot
    title="ç™»å½•æç¤º"
    show="{{ showAuthDialog }}"
    show-cancel-button
    confirm-button-text="å»ç™»å½•"
    cancel-button-text="æš‚ä¸ç™»å½•"
    bind:confirm="onAuthConfirm"
    bind:cancel="onAuthCancel"
  >
    <view class="auth-dialog-content">
      <text>ç™»å½•åå³å¯ä½¿ç”¨å®Œæ•´åŠŸèƒ½</text>
    </view>
  </van-dialog>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-mask" wx:if="{{loading}}">
    <van-loading type="spinner" color="#1890FF" />
  </view>
</view> 