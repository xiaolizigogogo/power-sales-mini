<!-- pages/profile/contracts/contracts.wxml -->
<view class="container">
  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <view class="statistics-section">
    <view class="stat-grid">
      <view class="stat-item">
        <view class="stat-icon">ğŸ“„</view>
        <view class="stat-number">{{statistics.total}}</view>
        <view class="stat-label">æ€»åˆåŒ</view>
      </view>
      <view class="stat-item">
        <view class="stat-icon">âœ…</view>
        <view class="stat-number">{{statistics.signed}}</view>
        <view class="stat-label">å·²ç­¾ç½²</view>
      </view>
      <view class="stat-item">
        <view class="stat-icon">âš¡</view>
        <view class="stat-number">{{statistics.executing}}</view>
        <view class="stat-label">æ‰§è¡Œä¸­</view>
      </view>
      <view class="stat-item">
        <view class="stat-icon">â°</view>
        <view class="stat-number">{{statistics.nearExpiry}}</view>
        <view class="stat-label">å³å°†åˆ°æœŸ</view>
      </view>
    </view>
  </view>

  <!-- æœç´¢å’Œç­›é€‰æ  -->
  <view class="search-section">
    <view class="search-bar">
      <view class="search-input-wrapper">
        <text class="search-icon">ğŸ”</text>
        <input
          class="search-input"
          placeholder="æœç´¢åˆåŒç¼–å·ã€åç§°"
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
          bindconfirm="onSearchConfirm"
        />
        <view wx:if="{{searchKeyword}}" class="clear-btn" bindtap="onSearchClear">
          <text>âŒ</text>
        </view>
      </view>
      <view class="filter-btn" bindtap="showFilter">
        <text class="filter-icon">ğŸ”½</text>
        <text>ç­›é€‰</text>
      </view>
    </view>
  </view>

  <!-- çŠ¶æ€æ ‡ç­¾æ  -->
  <view class="status-tabs">
    <view 
      wx:for="{{statusTabs}}" 
      wx:key="value"
      class="status-tab {{currentStatus === item.value ? 'active' : ''}}"
      bindtap="onStatusTabTap"
      data-status="{{item.value}}"
    >
      <text class="tab-icon">{{item.icon}}</text>
      <text class="tab-text">{{item.label}}</text>
      <view wx:if="{{item.count > 0}}" class="tab-badge">{{item.count}}</view>
    </view>
  </view>

  <!-- åˆ·æ–°æŒ‡ç¤ºå™¨ -->
  <view wx:if="{{refreshing}}" class="refresh-indicator">
    <text class="loading-icon">â³</text>
    <text>åˆ·æ–°ä¸­...</text>
  </view>

  <!-- åˆåŒåˆ—è¡¨ -->
  <view class="contracts-list">
    <view
      wx:for="{{filteredContracts}}"
      wx:key="id"
      class="contract-item"
      bindtap="onContractTap"
      data-id="{{item.id}}"
    >
      <!-- åˆåŒçŠ¶æ€æŒ‡ç¤ºæ¡ -->
      <view class="status-indicator status-{{item.status}}"></view>
      
      <!-- åˆåŒåŸºæœ¬ä¿¡æ¯ -->
      <view class="contract-header">
        <view class="contract-title-section">
          <view class="contract-name">{{item.contractName}}</view>
          <view class="contract-number">{{item.contractNumber}}</view>
        </view>
        <view class="contract-status status-{{item.status}}">
          <text class="status-icon">{{getStatusIcon(item.status)}}</text>
          <text class="status-text">{{getStatusText(item.status)}}</text>
        </view>
      </view>

      <!-- åˆåŒè¯¦æƒ… -->
      <view class="contract-details">
        <view class="detail-row">
          <text class="detail-label">ğŸ“… ç­¾ç½²æ—¥æœŸ</text>
          <text class="detail-value">{{item.signedDate ? formatDate(item.signedDate) : 'æœªç­¾ç½²'}}</text>
        </view>
        <view class="detail-row">
          <text class="detail-label">â° æœåŠ¡æœŸé™</text>
          <text class="detail-value">
            {{formatDate(item.startDate)}} - {{formatDate(item.endDate)}}
          </text>
        </view>
        <view class="detail-row">
          <text class="detail-label">ğŸ’° åˆåŒé‡‘é¢</text>
          <text class="detail-value amount">{{formatAmount(item.amount)}}</text>
        </view>
        <view wx:if="{{item.productName}}" class="detail-row">
          <text class="detail-label">ğŸ”§ æœåŠ¡äº§å“</text>
          <text class="detail-value">{{item.productName}}</text>
        </view>
      </view>

      <!-- åˆ°æœŸæé†’ -->
      <view wx:if="{{isNearExpiry(item.endDate)}}" class="expiry-notice">
        <text class="notice-icon">âš ï¸</text>
        <text class="notice-text">åˆåŒå³å°†åˆ°æœŸï¼Œè¯·åŠæ—¶ç»­ç­¾</text>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="contract-actions">
        <button
          wx:if="{{item.status === 'pending'}}"
          class="action-btn primary"
          catchtap="signContract"
          data-id="{{item.id}}"
        >
          âœï¸ ç«‹å³ç­¾ç½²
        </button>
        
        <button
          wx:if="{{item.status === 'signed' || item.status === 'executing'}}"
          class="action-btn secondary"
          catchtap="renewContract"
          data-id="{{item.id}}"
        >
          ğŸ”„ ç”³è¯·ç»­ç­¾
        </button>
        
        <button
          class="action-btn secondary"
          catchtap="previewContract"
          data-id="{{item.id}}"
        >
          ğŸ‘ï¸ é¢„è§ˆ
        </button>
        
        <button
          wx:if="{{item.status !== 'pending'}}"
          class="action-btn secondary"
          catchtap="downloadContract"
          data-id="{{item.id}}"
        >
          ğŸ“¥ ä¸‹è½½
        </button>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-section">
    <text class="loading-icon">â³</text>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ç©ºçŠ¶æ€æç¤º -->
  <view wx:if="{{!loading && filteredContracts.length === 0}}" class="empty-section">
    <view class="empty-content">
      <text class="empty-icon">ğŸ“‹</text>
      <text class="empty-title">{{getEmptyTitle()}}</text>
      <text class="empty-desc">{{getEmptyDesc()}}</text>
      <view class="empty-actions">
        <button class="empty-btn secondary" bindtap="goBack">â† è¿”å›ä¸Šé¡µ</button>
        <button class="empty-btn primary" bindtap="goToProducts">æµè§ˆäº§å“</button>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰å¼¹çª— -->
  <view wx:if="{{filterVisible}}" class="filter-modal">
    <view class="filter-mask" bindtap="hideFilter"></view>
    <view class="filter-content">
      <view class="filter-header">
        <text class="filter-title">ç­›é€‰æ¡ä»¶</text>
        <view class="close-btn" bindtap="hideFilter">âŒ</view>
      </view>

      <view class="filter-body">
        <view class="filter-section">
          <text class="section-title">åˆåŒçŠ¶æ€</text>
          <view class="status-options">
            <view 
              wx:for="{{statusOptions}}" 
              wx:key="value"
              class="status-option {{selectedStatus === item.value ? 'selected' : ''}}"
              bindtap="onStatusSelect"
              data-status="{{item.value}}"
            >
              <text class="option-icon">{{item.icon}}</text>
              <text class="option-text">{{item.label}}</text>
              <text wx:if="{{selectedStatus === item.value}}" class="check-icon">âœ…</text>
            </view>
          </view>
        </view>

        <view class="filter-section">
          <text class="section-title">ç­¾ç½²æ—¥æœŸ</text>
          <view class="date-range">
            <view class="date-picker" bindtap="selectStartDate">
              <text class="date-icon">ğŸ“…</text>
              <text class="date-text">{{dateRange.start || 'å¼€å§‹æ—¥æœŸ'}}</text>
            </view>
            <text class="date-separator">è‡³</text>
            <view class="date-picker" bindtap="selectEndDate">
              <text class="date-icon">ğŸ“…</text>
              <text class="date-text">{{dateRange.end || 'ç»“æŸæ—¥æœŸ'}}</text>
            </view>
          </view>
        </view>
      </view>

      <view class="filter-actions">
        <button class="filter-reset-btn" bindtap="resetFilter">é‡ç½®</button>
        <button class="filter-apply-btn" bindtap="applyFilter">åº”ç”¨</button>
      </view>
    </view>
  </view>

  <!-- åˆåŒé¢„è§ˆå¼¹çª— -->
  <view wx:if="{{previewVisible}}" class="preview-modal">
    <view class="preview-mask" bindtap="closePreview"></view>
    <view class="preview-content">
      <view class="preview-header">
        <text class="preview-title">åˆåŒé¢„è§ˆ</text>
        <view class="close-btn" bindtap="closePreview">âŒ</view>
      </view>

      <scroll-view scroll-y class="preview-body">
        <view wx:if="{{previewContract}}" class="contract-preview">
          <view class="preview-info">
            <text class="preview-contract-name">{{previewContract.contractName}}</text>
            <text class="preview-contract-number">ç¼–å·ï¼š{{previewContract.contractNumber}}</text>
          </view>

          <view class="preview-parties">
            <view class="party">
              <text class="party-title">ğŸ¢ ç”²æ–¹ï¼ˆæœåŠ¡æ–¹ï¼‰</text>
              <text class="party-name">{{previewContract.partyAName}}</text>
              <text class="party-address">{{previewContract.partyAAddress}}</text>
            </view>
            <view class="party">
              <text class="party-title">ğŸ‘¤ ä¹™æ–¹ï¼ˆå®¢æˆ·æ–¹ï¼‰</text>
              <text class="party-name">{{previewContract.partyBName}}</text>
              <text class="party-address">{{previewContract.partyBAddress}}</text>
            </view>
          </view>

          <view class="preview-terms">
            <text class="terms-title">ğŸ“‹ ä¸»è¦æ¡æ¬¾</text>
            <view class="term-item">
              <text class="term-label">æœåŠ¡å†…å®¹ï¼š</text>
              <text class="term-value">{{previewContract.serviceContent}}</text>
            </view>
            <view class="term-item">
              <text class="term-label">æœåŠ¡æœŸé™ï¼š</text>
              <text class="term-value">
                {{formatDate(previewContract.startDate)}} - {{formatDate(previewContract.endDate)}}
              </text>
            </view>
            <view class="term-item">
              <text class="term-label">åˆåŒé‡‘é¢ï¼š</text>
              <text class="term-value amount">{{formatAmount(previewContract.amount)}}</text>
            </view>
            <view class="term-item">
              <text class="term-label">ä»˜æ¬¾æ–¹å¼ï¼š</text>
              <text class="term-value">{{previewContract.paymentMethod}}</text>
            </view>
          </view>
        </view>
      </scroll-view>

      <view class="preview-actions">
        <button class="preview-btn secondary" bindtap="closePreview">å…³é—­</button>
        <button
          wx:if="{{previewContract.status === 'pending'}}"
          class="preview-btn primary"
          bindtap="signContract"
          data-id="{{previewContract.id}}"
        >
          âœï¸ ç«‹å³ç­¾ç½²
        </button>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨å¿«æ·æ“ä½œ -->
  <view class="bottom-actions">
    <button class="bottom-btn secondary" bindtap="goBack">
      <text class="btn-icon">â†</text>
      <text>è¿”å›</text>
    </button>
    <button class="bottom-btn primary" bindtap="goToProducts">
      <text class="btn-icon">ğŸ›ï¸</text>
      <text>æµè§ˆäº§å“</text>
    </button>
  </view>
</view> 