<!-- pages/calculator/index/index.wxml -->
<view class="calculator-container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="header-section">
    <view class="title">èŠ‚ç”µæ•ˆç›Šè®¡ç®—å™¨</view>
    <view class="subtitle">ç²¾å‡†è®¡ç®—ï¼Œæ™ºèƒ½é€‰æ‹©æœ€ä¼˜ç”µåŠ›å¥—é¤</view>
    
    <!-- æç¤ºè½®æ’­ -->
    <view class="tips-carousel">
      <view class="tip-item">
        <text class="tip-icon">ğŸ’¡</text>
        <text class="tip-text">{{tips[currentTip]}}</text>
      </view>
    </view>
  </view>

  <!-- è¡¨å•è¾“å…¥åŒºåŸŸ -->
  <view class="form-section">
    <view class="section-title">
      <text class="title-text">ç”¨ç”µä¿¡æ¯</text>
      <view class="section-actions">
        <text class="action-btn" bindtap="onUploadBill">ğŸ“· æ‹ç”µè´¹å•</text>
        <text class="action-btn" bindtap="onUseTemplate">ğŸ“‹ ä½¿ç”¨æ¨¡æ¿</text>
      </view>
    </view>

    <!-- ç”¨ç”µå®¹é‡è¾“å…¥ -->
    <view class="form-item">
      <view class="form-label">
        <text class="label-text">ç”¨ç”µå®¹é‡</text>
        <text class="required">*</text>
      </view>
      <view class="input-wrapper">
        <input
          class="form-input {{errors.capacity ? 'error' : ''}}"
          type="digit"
          placeholder="è¯·è¾“å…¥ç”¨ç”µå®¹é‡"
          value="{{powerInfo.capacity}}"
          data-field="capacity"
          bindinput="onInputChange"
        />
        <text class="input-unit">kW</text>
      </view>
      <view class="error-text" wx:if="{{errors.capacity}}">{{errors.capacity}}</view>
    </view>

    <!-- æœˆç”¨ç”µé‡è¾“å…¥ -->
    <view class="form-item">
      <view class="form-label">
        <text class="label-text">æœˆç”¨ç”µé‡</text>
        <text class="required">*</text>
      </view>
      <view class="input-wrapper">
        <input
          class="form-input {{errors.monthlyUsage ? 'error' : ''}}"
          type="digit"
          placeholder="è¯·è¾“å…¥æœˆç”¨ç”µé‡"
          value="{{powerInfo.monthlyUsage}}"
          data-field="monthlyUsage"
          bindinput="onInputChange"
        />
        <text class="input-unit">kWh</text>
      </view>
      <view class="error-text" wx:if="{{errors.monthlyUsage}}">{{errors.monthlyUsage}}</view>
    </view>

    <!-- å½“å‰ç”µä»·è¾“å…¥ -->
    <view class="form-item">
      <view class="form-label">
        <text class="label-text">å½“å‰ç”µä»·</text>
        <text class="required">*</text>
      </view>
      <view class="input-wrapper">
        <input
          class="form-input {{errors.currentPrice ? 'error' : ''}}"
          type="digit"
          placeholder="è¯·è¾“å…¥å½“å‰ç”µä»·"
          value="{{powerInfo.currentPrice}}"
          data-field="currentPrice"
          bindinput="onInputChange"
        />
        <text class="input-unit">å…ƒ/kWh</text>
      </view>
      <view class="error-text" wx:if="{{errors.currentPrice}}">{{errors.currentPrice}}</view>
    </view>

    <!-- è¡Œä¸šç±»å‹é€‰æ‹© -->
    <view class="form-item">
      <view class="form-label">
        <text class="label-text">è¡Œä¸šç±»å‹</text>
        <text class="required">*</text>
      </view>
      <picker
        class="form-picker {{errors.industryType ? 'error' : ''}}"
        mode="selector"
        range="{{industryTypes}}"
        range-key="name"
        value="{{industryIndex}}"
        bindchange="onIndustryChange"
      >
        <view class="picker-content">
          <text class="picker-text {{industryIndex === -1 ? 'placeholder' : ''}}">
            {{industryIndex === -1 ? 'è¯·é€‰æ‹©è¡Œä¸šç±»å‹' : industryTypes[industryIndex].name}}
          </text>
          <text class="picker-arrow">></text>
        </view>
      </picker>
      <view class="error-text" wx:if="{{errors.industryType}}">{{errors.industryType}}</view>
    </view>

    <!-- ç”¨ç”µæ€§è´¨é€‰æ‹© -->
    <view class="form-item">
      <view class="form-label">
        <text class="label-text">ç”¨ç”µæ€§è´¨</text>
      </view>
      <picker
        class="form-picker"
        mode="selector"
        range="{{usagePatterns}}"
        value="{{usageIndex}}"
        bindchange="onUsagePatternChange"
      >
        <view class="picker-content">
          <text class="picker-text">{{usagePatterns[usageIndex]}}</text>
          <text class="picker-arrow">></text>
        </view>
      </picker>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="form-actions">
      <button class="calculate-btn" bindtap="onCalculate" disabled="{{loading}}">
        <text wx:if="{{!loading}}">ğŸ§® å¼€å§‹è®¡ç®—</text>
        <text wx:else>è®¡ç®—ä¸­...</text>
      </button>
      <view class="action-links">
        <text class="link-btn" bindtap="onClearForm">æ¸…ç©º</text>
        <text class="link-btn" bindtap="onSaveTemplate">ä¿å­˜æ¨¡æ¿</text>
        <text class="link-btn" bindtap="onViewHistory">å†å²è®°å½•</text>
      </view>
    </view>
  </view>

  <!-- è®¡ç®—ç»“æœåŒºåŸŸ -->
  <view class="results-section" wx:if="{{showResults}}">
    <view class="section-title">
      <text class="title-text">è®¡ç®—ç»“æœ</text>
      <text class="subtitle-text">ä¸ºæ‚¨æ¨èä»¥ä¸‹ç”µåŠ›å¥—é¤</text>
    </view>

    <!-- æ¨èäº§å“å¡ç‰‡ -->
    <view class="recommended-card" wx:if="{{recommendedProduct}}">
      <view class="card-header">
        <view class="recommend-badge">ğŸ† æœ€ä½³æ¨è</view>
        <view class="share-btn" bindtap="onShareResult">åˆ†äº«</view>
      </view>
      <view class="product-info">
        <view class="product-name">{{recommendedProduct.productName}}</view>
        <view class="savings-highlight">
          é¢„è®¡å¹´èŠ‚çœï¼š<text class="amount">{{recommendedProduct.annualSavings}}</text>å…ƒ
        </view>
      </view>
      <view class="calculation-details">
        <view class="detail-item">
          <text class="detail-label">æ–°ç”µä»·ï¼š</text>
          <text class="detail-value">{{recommendedProduct.newPrice}}å…ƒ/kWh</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">æœˆèŠ‚çœï¼š</text>
          <text class="detail-value">{{recommendedProduct.monthlySavings}}å…ƒ</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">æŠ•èµ„å›æ”¶æœŸï¼š</text>
          <text class="detail-value">{{recommendedProduct.paybackPeriod}}ä¸ªæœˆ</text>
        </view>
      </view>
      <view class="card-actions">
        <button 
          class="detail-btn" 
          data-product-id="{{recommendedProduct.productId}}"
          bindtap="onViewDetails"
        >
          æŸ¥çœ‹è¯¦æƒ…
        </button>
        <button 
          class="order-btn" 
          data-product-id="{{recommendedProduct.productId}}"
          bindtap="onCreateOrder"
        >
          ç«‹å³ä¸‹å•
        </button>
      </view>
    </view>

    <!-- å…¶ä»–äº§å“åˆ—è¡¨ -->
    <view class="other-products" wx:if="{{calculationResults.length > 1}}">
      <view class="section-subtitle">å…¶ä»–å¯é€‰æ–¹æ¡ˆ</view>
      <view class="product-list">
        <view 
          class="product-item" 
          wx:for="{{calculationResults}}" 
          wx:key="productId"
          wx:if="{{item.productId !== recommendedProduct.productId}}"
        >
          <view class="product-header">
            <view class="product-name">{{item.productName}}</view>
            <view class="product-price">{{item.priceDisplay}}</view>
          </view>
          <view class="savings-info">
            <view class="savings-item">
              <text class="savings-label">å¹´èŠ‚çœï¼š</text>
              <text class="savings-value positive" wx:if="{{item.annualSavings > 0}}">
                +{{item.annualSavings}}å…ƒ
              </text>
              <text class="savings-value negative" wx:else>
                {{item.annualSavings}}å…ƒ
              </text>
            </view>
            <view class="savings-item">
              <text class="savings-label">æœˆèŠ‚çœï¼š</text>
              <text class="savings-value positive" wx:if="{{item.monthlySavings > 0}}">
                +{{item.monthlySavings}}å…ƒ
              </text>
              <text class="savings-value negative" wx:else>
                {{item.monthlySavings}}å…ƒ
              </text>
            </view>
          </view>
          <view class="product-actions">
            <text 
              class="action-link" 
              data-product-id="{{item.productId}}"
              bindtap="onViewDetails"
            >
              è¯¦æƒ…
            </text>
            <text 
              class="action-link" 
              data-product-id="{{item.productId}}"
              bindtap="onSelectProduct"
            >
              æŸ¥çœ‹
            </text>
            <text 
              class="action-link primary" 
              data-product-id="{{item.productId}}"
              bindtap="onCreateOrder"
              wx:if="{{item.annualSavings > 0}}"
            >
              ä¸‹å•
            </text>
          </view>
        </view>
      </view>
    </view>

    <!-- è®¡ç®—è¯´æ˜ -->
    <view class="calculation-note">
      <view class="note-title">ğŸ’¡ è®¡ç®—è¯´æ˜</view>
      <view class="note-content">
        <text>â€¢ ä»¥ä¸Šè®¡ç®—ç»“æœåŸºäºæ‚¨æä¾›çš„ç”¨ç”µä¿¡æ¯è¿›è¡Œä¼°ç®—</text>
        <text>â€¢ å®é™…èŠ‚è´¹é‡‘é¢å¯èƒ½å› ç”¨ç”µé‡æ³¢åŠ¨è€Œæœ‰æ‰€å·®å¼‚</text>
        <text>â€¢ å»ºè®®ä¸Šä¼ è¿‘æœŸç”µè´¹å•è·å¾—æ›´ç²¾å‡†çš„è®¡ç®—ç»“æœ</text>
        <text>â€¢ å¦‚éœ€è¯¦ç»†åˆ†æï¼Œè¯·è”ç³»å®¢æœè·å¾—ä¸“ä¸šå’¨è¯¢</text>
      </view>
    </view>
  </view>

  <!-- è¯¦æƒ…å¼¹çª— -->
  <view class="detail-modal" wx:if="{{showDetails}}" bindtap="onCloseDetails">
    <view class="modal-content" catchtap="">
      <view class="modal-header">
        <view class="modal-title">è®¡ç®—è¯¦æƒ…</view>
        <view class="close-btn" bindtap="onCloseDetails">Ã—</view>
      </view>
      <view class="modal-body" wx:if="{{selectedResult}}">
        <view class="detail-section">
          <view class="section-title">äº§å“ä¿¡æ¯</view>
          <view class="info-item">
            <text class="info-label">äº§å“åç§°ï¼š</text>
            <text class="info-value">{{selectedResult.productName}}</text>
          </view>
          <view class="info-item">
            <text class="info-label">äº§å“ç±»å‹ï¼š</text>
            <text class="info-value">{{selectedResult.productType}}</text>
          </view>
          <view class="info-item">
            <text class="info-label">æ–°ç”µä»·ï¼š</text>
            <text class="info-value">{{selectedResult.newPrice}}å…ƒ/kWh</text>
          </view>
        </view>

        <view class="detail-section">
          <view class="section-title">èŠ‚è´¹åˆ†æ</view>
          <view class="info-item">
            <text class="info-label">å½“å‰æœˆç”µè´¹ï¼š</text>
            <text class="info-value">{{selectedResult.currentMonthlyBill}}å…ƒ</text>
          </view>
          <view class="info-item">
            <text class="info-label">æ–°ç”µè´¹ï¼š</text>
            <text class="info-value">{{selectedResult.newMonthlyBill}}å…ƒ</text>
          </view>
          <view class="info-item">
            <text class="info-label">æœˆèŠ‚çœé‡‘é¢ï¼š</text>
            <text class="info-value highlight">{{selectedResult.monthlySavings}}å…ƒ</text>
          </view>
          <view class="info-item">
            <text class="info-label">å¹´èŠ‚çœé‡‘é¢ï¼š</text>
            <text class="info-value highlight">{{selectedResult.annualSavings}}å…ƒ</text>
          </view>
        </view>

        <view class="detail-section">
          <view class="section-title">æŠ•èµ„åˆ†æ</view>
          <view class="info-item">
            <text class="info-label">åˆæœŸæŠ•èµ„ï¼š</text>
            <text class="info-value">{{selectedResult.initialCost}}å…ƒ</text>
          </view>
          <view class="info-item">
            <text class="info-label">æŠ•èµ„å›æ”¶æœŸï¼š</text>
            <text class="info-value">{{selectedResult.paybackPeriod}}ä¸ªæœˆ</text>
          </view>
          <view class="info-item">
            <text class="info-label">ä¸‰å¹´æ€»æ”¶ç›Šï¼š</text>
            <text class="info-value highlight">{{selectedResult.threeYearSavings}}å…ƒ</text>
          </view>
        </view>
      </view>
      <view class="modal-actions">
        <button class="modal-btn secondary" bindtap="onCloseDetails">å…³é—­</button>
        <button 
          class="modal-btn primary" 
          data-product-id="{{selectedResult.productId}}"
          bindtap="onSelectProduct"
        >
          æŸ¥çœ‹äº§å“
        </button>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œåŒº -->
  <view class="bottom-actions">
    <button class="contact-btn" bindtap="onContactService">
      <text class="btn-icon">ğŸ“</text>
      <text class="btn-text">è”ç³»å®¢æœ</text>
    </button>
  </view>

  <!-- åŠ è½½é®ç½© -->
  <view class="loading-mask" wx:if="{{loading}}">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">è®¡ç®—ä¸­ï¼Œè¯·ç¨å€™...</text>
    </view>
  </view>
</view> 