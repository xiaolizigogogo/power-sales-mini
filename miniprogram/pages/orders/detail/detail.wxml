<view class="order-detail">
  <!-- 加载状态 -->
  <van-loading wx:if="{{ loading }}" custom-class="page-loading" />

  <block wx:else>
    <!-- 订单状态 -->
    <view class="status-card">
      <view class="status-text" style="color: {{ statusColorMap[order.status] }}">
        {{ statusMap[order.status] }}
      </view>
      <view class="order-no">订单号：{{ order.orderNo }}</view>
    </view>

    <!-- 产品信息 -->
    <view class="info-card">
      <view class="card-title">产品信息</view>
      <view class="product-info">
        <image class="product-image" src="{{ order.product.image }}" mode="aspectFill" />
        <view class="product-detail">
          <view class="product-name">{{ order.product.name }}</view>
          <view class="product-price">
            <text class="price">{{ order.product.price }}</text>
            <text class="unit">元/kWh</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 订单信息 -->
    <view class="info-card">
      <view class="card-title">订单信息</view>
      <view class="info-item">
        <text class="label">服务期限</text>
        <text class="value">{{ order.servicePeriod }}个月</text>
      </view>
      <view class="info-item">
        <text class="label">开始时间</text>
        <text class="value">{{ order.startDate }}</text>
      </view>
      <view class="info-item">
        <text class="label">预估月用电量</text>
        <text class="value">{{ order.estimatedUsage }} kWh</text>
      </view>
      <view class="info-item">
        <text class="label">月均费用</text>
        <text class="value">{{ order.monthlyFee }} 元</text>
      </view>
      <view class="info-item">
        <text class="label">服务期总费用</text>
        <text class="value highlight">{{ order.totalAmount }} 元</text>
      </view>
      <block wx:if="{{ order.specialRequirements }}">
        <view class="info-item">
          <text class="label">特殊需求</text>
          <text class="value">{{ order.specialRequirements }}</text>
        </view>
      </block>
      <block wx:if="{{ order.remarks }}">
        <view class="info-item">
          <text class="label">备注</text>
          <text class="value">{{ order.remarks }}</text>
        </view>
      </block>
    </view>

    <!-- 商务洽谈记录 -->
    <view class="info-card" wx:if="{{ order.negotiations.length > 0 }}">
      <view class="card-title">商务洽谈记录</view>
      <view class="negotiation-list">
        <view 
          class="negotiation-item"
          wx:for="{{ order.negotiations }}"
          wx:key="id"
        >
          <view class="negotiation-header">
            <view class="negotiator">{{ item.negotiatorName }}</view>
            <view class="time">{{ item.createTime }}</view>
          </view>
          <view class="negotiation-content">{{ item.content }}</view>
          <view class="file-list" wx:if="{{ item.files.length > 0 }}">
            <view 
              class="file-item"
              wx:for="{{ item.files }}"
              wx:for-item="file"
              wx:key="id"
              data-url="{{ file.url }}"
              bind:tap="previewFile"
            >
              <van-icon name="description" />
              <text class="file-name">{{ file.name }}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 服务状态 -->
    <view class="info-card" wx:if="{{ order.status === 'active' || order.status === 'completed' }}">
      <view class="card-title">服务状态</view>
      <view class="service-status">
        <view class="service-item">
          <text class="label">服务状态</text>
          <text class="value status-active">{{ getServiceStatusText(order.serviceStatus) }}</text>
        </view>
        <view class="service-item">
          <text class="label">开通时间</text>
          <text class="value">{{ order.activationDate || '待开通' }}</text>
        </view>
        <view class="service-item">
          <text class="label">有效期至</text>
          <text class="value">{{ order.serviceEndDate }}</text>
        </view>
        <view class="service-item" wx:if="{{ order.serviceStatus === 'active' }}">
          <text class="label">本月用电量</text>
          <text class="value">{{ serviceData.monthlyUsage || 0 }} kWh</text>
        </view>
        <view class="service-item" wx:if="{{ order.serviceStatus === 'active' }}">
          <text class="label">本月节省金额</text>
          <text class="value highlight">¥{{ serviceData.monthlySavings || 0 }}</text>
        </view>
        <view class="service-item" wx:if="{{ order.serviceStatus === 'active' }}">
          <text class="label">累计节省金额</text>
          <text class="value highlight">¥{{ serviceData.totalSavings || 0 }}</text>
        </view>
      </view>
      
      <!-- 服务进度 -->
      <view class="service-progress" wx:if="{{ order.serviceStatus === 'activating' }}">
        <view class="progress-title">开通进度</view>
        <view class="progress-bar">
          <view class="progress-fill" style="width: {{ order.progressPercent || 0 }}%"></view>
        </view>
        <view class="progress-text">{{ order.progressText || '准备开通中' }}</view>
      </view>
    </view>

    <!-- 联系信息 -->
    <view class="info-card">
      <view class="card-title">联系方式</view>
      <view class="contact-info">
        <block wx:if="{{ isManager }}">
          <text>客户：{{ order.customerName }}</text>
        </block>
        <block wx:else>
          <text>客户经理：{{ order.managerName }}</text>
        </block>
        <view class="contact-btn" bind:tap="makePhoneCall">
          <van-icon name="phone" />
          <text>立即联系</text>
        </view>
      </view>
    </view>

    <!-- 底部操作栏 -->
    <view class="bottom-bar">
      <block wx:if="{{ isManager }}">
        <block wx:if="{{ order.status === 'pending' }}">
          <van-button 
            type="info" 
            bind:click="updateOrderStatus" 
            data-status="negotiating"
          >开始商务洽谈</van-button>
          <van-button 
            type="danger" 
            bind:click="updateOrderStatus" 
            data-status="rejected"
          >拒绝订单</van-button>
        </block>
        <block wx:elif="{{ order.status === 'negotiating' }}">
          <van-button 
            type="primary" 
            bind:click="showNegotiation"
          >添加洽谈记录</van-button>
          <van-button 
            type="success" 
            bind:click="updateOrderStatus" 
            data-status="confirmed"
          >确认订单</van-button>
        </block>
      </block>
      <block wx:else>
        <block wx:if="{{ order.status === 'pending' }}">
          <van-button 
            type="danger" 
            bind:click="updateOrderStatus" 
            data-status="cancelled"
          >取消订单</van-button>
        </block>
      </block>
    </view>
  </block>

  <!-- 商务洽谈弹窗 -->
  <van-popup
    show="{{ showNegotiationPopup }}"
    position="bottom"
    round
    custom-style="min-height: 60%"
    bind:close="closeNegotiation"
  >
    <view class="negotiation-popup">
      <view class="popup-title">添加洽谈记录</view>
      
      <view class="popup-content">
        <van-field
          value="{{ negotiationForm.content }}"
          type="textarea"
          placeholder="请输入洽谈内容"
          autosize
          border="{{ false }}"
          bind:change="onNegotiationInput"
        />

        <view class="upload-section">
          <view class="upload-title">上传附件</view>
          <view class="file-list">
            <view 
              class="file-item"
              wx:for="{{ negotiationForm.files }}"
              wx:key="path"
            >
              <text class="file-name">{{ item.name }}</text>
              <van-icon 
                name="cross" 
                bind:click="removeFile"
                data-index="{{ index }}"
              />
            </view>
          </view>
          <van-button 
            type="info" 
            size="small" 
            bind:click="uploadFile"
            wx:if="{{ negotiationForm.files.length < 5 }}"
          >上传文件</van-button>
        </view>
      </view>

      <view class="popup-footer">
        <van-button 
          type="default" 
          bind:click="closeNegotiation"
        >取消</van-button>
        <van-button 
          type="primary" 
          bind:click="submitNegotiation"
          loading="{{ submitting }}"
        >提交</van-button>
      </view>
    </view>
  </van-popup>
</view> 