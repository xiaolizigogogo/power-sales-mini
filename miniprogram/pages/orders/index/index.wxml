<!--pages/orders/index/index.wxml-->
<view class="container">
  <!-- æœç´¢æ  -->
  <view class="search-bar">
    <view class="search-input-wrapper">
      <text class="search-icon">ğŸ”</text>
      <input 
        class="search-input"
        placeholder="æœç´¢è®¢å•å·ã€äº§å“åç§°"
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        bindfocus="onSearchFocus"
        bindblur="onSearchBlur"
        bindconfirm="onSearchConfirm"
      />
      <view class="search-clear {{searchKeyword ? 'show' : ''}}" bindtap="onClearSearch">
        <text>âœ•</text>
      </view>
    </view>
    <view class="filter-btn" bindtap="onShowFilter">
      <text>âš™ï¸</text>
    </view>
  </view>

  <!-- çŠ¶æ€æ ‡ç­¾æ  -->
  <scroll-view class="tab-bar" scroll-x="true">
    <view class="tab-list">
      <view 
        class="tab-item {{activeTab === item.key ? 'active' : ''}}"
        wx:for="{{tabList}}"
        wx:key="key"
        data-key="{{item.key}}"
        bindtap="onTabChange"
      >
        <text class="tab-name">{{item.name}}</text>
        <text class="tab-count" wx:if="{{item.count > 0}}">({{item.count}})</text>
      </view>
    </view>
  </scroll-view>

  <!-- è®¢å•åˆ—è¡¨ -->
  <view class="order-list">
    <!-- æ ‡ç­¾é¡µ -->
    <van-tabs 
      active="{{ activeTab }}" 
      bind:change="onTabChange"
      sticky
      swipeable
    >
      <van-tab 
        wx:for="{{ tabs }}" 
        wx:key="key"
        name="{{ item.key }}"
        title="{{ item.name }}"
      >
        <!-- è®¢å•åˆ—è¡¨ -->
        <view class="order-container">
          <block wx:if="{{ orders.length > 0 }}">
            <view 
              class="order-card"
              wx:for="{{ orders }}"
              wx:key="id"
              data-id="{{ item.id }}"
              bind:tap="viewOrderDetail"
            >
              <!-- è®¢å•å¤´éƒ¨ -->
              <view class="order-header">
                <view class="order-no">è®¢å•å·ï¼š{{ item.orderNo }}</view>
                <view 
                  class="order-status"
                  style="color: {{ statusColorMap[item.status] }}"
                >{{ statusMap[item.status] }}</view>
              </view>

              <!-- äº§å“ä¿¡æ¯ -->
              <view class="product-info">
                <image 
                  class="product-image" 
                  src="{{ item.product.image }}" 
  <view class="order-list-container">
    <!-- åŠ è½½çŠ¶æ€ -->
    <van-loading size="24px" vertical wx:if="{{loading && orderList.length === 0}}">åŠ è½½ä¸­...</van-loading>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && isEmpty}}">
      <text class="empty-icon">ğŸ“‹</text>
      <text class="empty-text">æš‚æ— è®¢å•</text>
      <text class="empty-desc">æ‚¨è¿˜æ²¡æœ‰ä»»ä½•è®¢å•ï¼Œå¿«å»é€‰è´­äº§å“å§~</text>
      <button class="empty-btn" bindtap="onGoShopping">å»é€‰è´­</button>
    </view>

    <!-- è®¢å•åˆ—è¡¨ -->
    <view class="order-list" wx:if="{{orderList.length > 0}}">
      <view 
        class="order-item"
        wx:for="{{orderList}}"
        wx:key="id"
        data-order="{{item}}"
        bindtap="onOrderItemTap"
      >
        <!-- è®¢å•å¤´éƒ¨ -->
        <view class="order-header">
          <view class="order-info">
            <text class="order-number">è®¢å•å·ï¼š{{item.orderNumber}}</text>
            <text class="order-date">{{item.createdAt}}</text>
          </view>
          <view class="order-status {{item.statusClass}}">
            <text>{{item.statusText}}</text>
          </view>
        </view>

        <!-- äº§å“ä¿¡æ¯ -->
        <view class="product-info">
          <image class="product-image" src="{{item.productImage}}" mode="aspectFill"></image>
          <view class="product-details">
            <text class="product-name">{{item.productName}}</text>
            <text class="product-desc">{{item.productDesc}}</text>
            <view class="product-specs">
              <text class="spec-item">å®¹é‡ï¼š{{item.capacity}}</text>
              <text class="spec-item">æœŸé™ï¼š{{item.servicePeriod}}</text>
            </view>
          </view>
          <view class="product-price">
            <text class="price-symbol">Â¥</text>
            <text class="price-amount">{{item.amount}}</text>
          </view>
        </view>

        <!-- æœåŠ¡ä¿¡æ¯ -->
        <view class="service-info" wx:if="{{item.assignedEmployee}}">
          <view class="service-item">
            <text class="service-icon">ğŸ‘¨â€ğŸ’¼</text>
            <text class="service-text">æœåŠ¡ç»ç†ï¼š{{item.assignedEmployee.name}}</text>
            <text class="service-phone" catchtap="onCallService" data-phone="{{item.assignedEmployee.phone}}">
              {{item.assignedEmployee.phone}}
            </text>
          </view>
        </view>

        <!-- è¿›åº¦æ¡ -->
        <view class="progress-bar" wx:if="{{item.showProgress}}">
          <view class="progress-steps">
            <view 
              class="step-item {{index <= item.currentStep ? 'completed' : ''}}"
              wx:for="{{item.progressSteps}}"
              wx:key="id"
              wx:for-index="index"
            >
              <view class="step-dot"></view>
              <text class="step-text">{{item.name}}</text>
            </view>
          </view>
          <view class="progress-line">
            <view class="progress-fill" style="width: {{item.progressPercent}}%"></view>
          </view>
        </view>

        <!-- æ“ä½œæŒ‰é’® -->
        <view class="order-actions">
          <button 
            class="action-btn secondary"
            wx:if="{{item.canCancel}}"
            catchtap="onCancelOrder"
            data-order-id="{{item.id}}"
          >
            å–æ¶ˆè®¢å•
          </button>
          <button 
            class="action-btn secondary"
            wx:if="{{item.canModify}}"
            catchtap="onModifyOrder"
            data-order-id="{{item.id}}"
          >
            ä¿®æ”¹è®¢å•
          </button>
          <button 
            class="action-btn primary"
            wx:if="{{item.canPay}}"
            catchtap="onPayOrder"
            data-order-id="{{item.id}}"
          >
            ç«‹å³æ”¯ä»˜
          </button>
          <button 
            class="action-btn secondary"
            wx:if="{{item.canViewContract}}"
            catchtap="onViewContract"
            data-order-id="{{item.id}}"
          >
            æŸ¥çœ‹åˆåŒ
          </button>
          <button 
            class="action-btn primary"
            wx:if="{{item.canConfirm}}"
            catchtap="onConfirmOrder"
            data-order-id="{{item.id}}"
          >
            ç¡®è®¤æ”¶è´§
          </button>
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{hasMore && orderList.length > 0}}">
      <van-loading size="16px" wx:if="{{loadingMore}}">åŠ è½½ä¸­...</van-loading>
      <text wx:else>ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤šæ•°æ® -->
    <view class="no-more" wx:if="{{!hasMore && orderList.length > 0}}">
      <text>å·²æ˜¾ç¤ºå…¨éƒ¨è®¢å•</text>
    </view>
  </view>

  <!-- ç­›é€‰å¼¹çª— -->
  <van-popup 
    show="{{showFilter}}" 
    position="bottom"
    bind:close="onCloseFilter"
    round="{{true}}"
    close-icon="true"
  >
    <view class="filter-popup">
      <view class="filter-header">
        <text class="filter-title">ç­›é€‰æ¡ä»¶</text>
        <text class="filter-reset" bindtap="onResetFilter">é‡ç½®</text>
      </view>
      
      <view class="filter-content">
        <!-- è®¢å•çŠ¶æ€ç­›é€‰ -->
        <view class="filter-section">
          <view class="filter-section-title">è®¢å•çŠ¶æ€</view>
          <view class="filter-options">
            <view 
              class="filter-option {{item.checked ? 'checked' : ''}}"
              wx:for="{{filterOptions.status}}"
              wx:key="value"
              data-type="status"
              data-value="{{item.value}}"
              bindtap="onFilterOptionTap"
            >
              <text>{{item.label}}</text>
              <text class="check-icon">âœ“</text>
            </view>
          </view>
        </view>

        <!-- æ—¶é—´èŒƒå›´ç­›é€‰ -->
        <view class="filter-section">
          <view class="filter-section-title">ä¸‹å•æ—¶é—´</view>
          <view class="filter-options">
            <view 
              class="filter-option {{item.checked ? 'checked' : ''}}"
              wx:for="{{filterOptions.dateRange}}"
              wx:key="value"
              data-type="dateRange"
              data-value="{{item.value}}"
              bindtap="onFilterOptionTap"
            >
              <text>{{item.label}}</text>
              <text class="check-icon">âœ“</text>
            </view>
          </view>
        </view>

        <!-- é‡‘é¢èŒƒå›´ç­›é€‰ -->
        <view class="filter-section">
          <view class="filter-section-title">è®¢å•é‡‘é¢</view>
          <view class="filter-options">
            <view 
              class="filter-option {{item.checked ? 'checked' : ''}}"
              wx:for="{{filterOptions.amountRange}}"
              wx:key="value"
              data-type="amountRange"
              data-value="{{item.value}}"
              bindtap="onFilterOptionTap"
            >
              <text>{{item.label}}</text>
              <text class="check-icon">âœ“</text>
            </view>
          </view>
        </view>
      </view>

      <view class="filter-footer">
        <button class="filter-cancel" bindtap="onCloseFilter">å–æ¶ˆ</button>
        <button class="filter-confirm" bindtap="onConfirmFilter">ç¡®å®š</button>
      </view>
    </view>
  </van-popup>

  <!-- æ“ä½œç¡®è®¤å¼¹çª— -->
  <van-dialog
    show="{{showConfirmDialog}}"
    title="{{confirmDialog.title}}"
    message="{{confirmDialog.message}}"
    show-cancel-button
    bind:confirm="onConfirmAction"
    bind:cancel="onCancelAction"
  />

  <!-- å®¢æœè”ç³»å¼¹çª— -->
  <van-action-sheet
    show="{{showContactSheet}}"
    actions="{{contactActions}}"
    cancel-text="å–æ¶ˆ"
    bind:select="onContactSelect"
    bind:close="onCloseContactSheet"
  />
</view> 