<!--pages/orders/index/index.wxml-->
<view class="container">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <view class="custom-navbar">
    <view class="navbar-title">æˆ‘çš„è®¢å•</view>
  </view>

  <!-- æœç´¢æ  -->
  <view class="search-section">
    <view class="search-bar">
      <view class="search-input-wrapper">
        <icon class="search-icon" type="search" size="16" color="#999"/>
        <input 
          class="search-input"
          placeholder="æœç´¢è®¢å•å·ã€äº§å“åç§°"
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
          bindconfirm="onSearchConfirm"
        />
        <view class="search-clear {{searchKeyword ? 'show' : ''}}" bindtap="onClearSearch">
          <icon type="clear" size="14" color="#999"/>
        </view>
      </view>
      <view class="filter-btn" bindtap="showFilterPopup">
        <icon type="success" size="16" color="#666"/>
        <text>ç­›é€‰</text>
      </view>
    </view>
  </view>

  <!-- çŠ¶æ€æ ‡ç­¾æ  -->
  <view class="tabs-section">
    <scroll-view class="tabs-container" scroll-x="true">
      <view class="tabs-list">
        <view 
          class="tab-item {{activeTab === index ? 'active' : ''}}"
          wx:for="{{tabList}}"
          wx:key="key"
          data-index="{{index}}"
          bindtap="onTabChange"
        >
          <text class="tab-text">{{item.name}}</text>
          <view class="tab-badge" wx:if="{{item.count > 0}}">{{item.count}}</view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- è®¢å•åˆ—è¡¨ -->
  <view class="orders-container">
    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-container" wx:if="{{loading && orderList.length === 0}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-container" wx:if="{{!loading && isEmpty}}">
      <view class="empty-icon">ğŸ“‹</view>
      <text class="empty-title">æš‚æ— è®¢å•</text>
      <text class="empty-desc">æ‚¨è¿˜æ²¡æœ‰ä»»ä½•è®¢å•è®°å½•</text>
      <button class="empty-action-btn" bindtap="onGoShopping">
        <text>å»é€‰è´­äº§å“</text>
      </button>
    </view>

    <!-- è®¢å•åˆ—è¡¨ -->
    <view class="orders-list" wx:if="{{orderList.length > 0}}">
      <view 
        class="order-card"
        wx:for="{{orderList}}"
        wx:key="id"
        data-order="{{item}}"
        bindtap="viewOrderDetail"
      >
        <!-- è®¢å•å¤´éƒ¨ -->
        <view class="order-header">
          <view class="order-meta">
            <text class="order-number">{{item.orderNumber || 'è®¢å•å·ï¼š' + item.id}}</text>
            <text class="order-date">{{item.createTime || item.createdAt}}</text>
          </view>
          <view class="order-status {{item.status || 'pending'}}">
            <text class="status-text">{{item.statusText || 'å¾…å¤„ç†'}}</text>
          </view>
        </view>

        <!-- äº§å“ä¿¡æ¯ -->
        <view class="product-section">
          <view class="product-image-wrapper">
            <image 
              class="product-image" 
              src="{{item.productImage}}" 
              mode="aspectFill"
              lazy-load
              binderror="onImageError"
            />
            <view class="product-image-placeholder" wx:if="{{!item.productImage}}">
              <text>ğŸ“¦</text>
            </view>
          </view>
          <view class="product-info">
            <text class="product-name">{{item.productName || 'èŠ‚ç”µäº§å“'}}</text>
            <text class="product-specs">{{item.productDesc || 'é«˜æ•ˆèŠ‚èƒ½è®¾å¤‡'}}</text>
            <view class="product-details">
              <text class="detail-item">å®¹é‡ï¼š{{item.capacity || 'å¾…ç¡®å®š'}}</text>
              <text class="detail-item">æœŸé™ï¼š{{item.servicePeriod || '1å¹´'}}</text>
            </view>
          </view>
          <view class="product-price">
            <text class="price-symbol">Â¥</text>
            <text class="price-amount">{{item.amount || '0'}}</text>
            <text class="price-unit">èµ·</text>
          </view>
        </view>

        <!-- æœåŠ¡ä¿¡æ¯ -->
        <view class="service-section" wx:if="{{item.assignedEmployee}}">
          <view class="service-info">
            <view class="service-avatar">
              <image 
                class="avatar-image" 
                src="{{item.assignedEmployee.avatar}}" 
                mode="aspectFill"
                binderror="onAvatarError"
              />
              <view class="avatar-placeholder" wx:if="{{!item.assignedEmployee.avatar}}">
                <text>ğŸ‘¤</text>
              </view>
            </view>
            <view class="service-details">
              <text class="service-name">{{item.assignedEmployee.name}}</text>
              <text class="service-title">ä¸“å±æœåŠ¡ç»ç†</text>
            </view>
            <view class="service-contact" catchtap="onCallService" data-phone="{{item.assignedEmployee.phone}}">
              <icon type="info" size="16" color="#1890ff"/>
              <text class="contact-text">è”ç³»</text>
            </view>
          </view>
        </view>

        <!-- è¿›åº¦æ¡ -->
        <view class="progress-section" wx:if="{{item.showProgress}}">
          <view class="progress-header">
            <text class="progress-title">è®¢å•è¿›åº¦</text>
            <text class="progress-percent">{{item.progressPercent || 0}}%</text>
          </view>
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{item.progressPercent || 0}}%"></view>
          </view>
          <view class="progress-steps">
            <text 
              class="step-item {{index <= (item.currentStep || 0) ? 'completed' : ''}}"
              wx:for="{{item.progressSteps || ['ä¸‹å•', 'ç¡®è®¤', 'æœåŠ¡ä¸­', 'å®Œæˆ']}}"
              wx:key="*this"
              wx:for-index="index"
            >{{item}}</text>
          </view>
        </view>

        <!-- è®¢å•æ“ä½œ -->
        <view class="order-actions">
          <button 
            class="action-btn secondary"
            wx:if="{{item.canCancel}}"
            catchtap="showOrderActions"
            data-order="{{item}}"
          >å–æ¶ˆè®¢å•</button>
          <button 
            class="action-btn secondary"
            wx:if="{{item.canViewContract}}"
            catchtap="viewContract"
            data-order="{{item}}"
          >æŸ¥çœ‹åˆåŒ</button>
          <button 
            class="action-btn primary"
            wx:if="{{item.canPay}}"
            catchtap="onPayOrder"
            data-order="{{item}}"
          >ç«‹å³æ”¯ä»˜</button>
          <button 
            class="action-btn primary"
            wx:if="{{item.canConfirm}}"
            catchtap="confirmOrder"
            data-order="{{item}}"
          >ç¡®è®¤æ”¶è´§</button>
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more-section" wx:if="{{orderList.length > 0}}">
      <view class="load-more-indicator" wx:if="{{hasMore}}">
        <view class="loading-spinner small" wx:if="{{loadingMore}}"></view>
        <text class="load-more-text">{{loadingMore ? 'åŠ è½½ä¸­...' : 'ä¸Šæ‹‰åŠ è½½æ›´å¤š'}}</text>
      </view>
      <view class="no-more-indicator" wx:else>
        <text class="no-more-text">å·²æ˜¾ç¤ºå…¨éƒ¨è®¢å•</text>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰å¼¹çª— -->
  <view class="filter-popup {{showFilter ? 'show' : ''}}" catchtap="closeFilterPopup">
    <view class="filter-content" catchtap="stopPropagation">
      <view class="filter-header">
        <text class="filter-title">ç­›é€‰è®¢å•</text>
        <view class="filter-close" bindtap="closeFilterPopup">
          <icon type="cancel" size="18" color="#666"/>
        </view>
      </view>
      
      <view class="filter-body">
        <view class="filter-group">
          <text class="filter-label">è®¢å•çŠ¶æ€</text>
          <view class="filter-options">
            <view 
              class="filter-option {{filterData.status === item.value ? 'selected' : ''}}"
              wx:for="{{statusOptions}}"
              wx:key="value"
              data-value="{{item.value}}"
              bindtap="onFilterStatusChange"
            >
              <text>{{item.text}}</text>
            </view>
          </view>
        </view>

        <view class="filter-group">
          <text class="filter-label">é‡‘é¢èŒƒå›´</text>
          <view class="filter-options">
            <view 
              class="filter-option {{filterData.amountRange === item.value ? 'selected' : ''}}"
              wx:for="{{amountRangeOptions}}"
              wx:key="value"
              data-value="{{item.value}}"
              bindtap="onFilterAmountChange"
            >
              <text>{{item.text}}</text>
            </view>
          </view>
        </view>
      </view>

      <view class="filter-footer">
        <button class="filter-btn reset" bindtap="resetFilter">é‡ç½®</button>
        <button class="filter-btn confirm" bindtap="applyFilter">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- æ“ä½œèœå• -->
  <view class="action-sheet {{showActionSheet ? 'show' : ''}}" catchtap="closeActionSheet">
    <view class="action-sheet-content" catchtap="stopPropagation">
      <view class="action-sheet-header">
        <text class="action-sheet-title">è®¢å•æ“ä½œ</text>
      </view>
      <view class="action-sheet-body">
        <view 
          class="action-sheet-item"
          wx:for="{{actionSheetActions}}"
          wx:key="action"
          data-action="{{item.action}}"
          bindtap="onActionSelect"
        >
          <text class="action-text">{{item.text}}</text>
        </view>
      </view>
      <view class="action-sheet-footer">
        <button class="action-sheet-cancel" bindtap="closeActionSheet">å–æ¶ˆ</button>
      </view>
    </view>
  </view>
</view> 