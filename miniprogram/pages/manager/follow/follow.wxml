<!--pages/manager/follow/follow.wxml-->
<view class="container">
  <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
  <view class="tabs-container">
    <view class="tabs-nav">
      <view 
        class="tab-item {{activeTab === index ? 'active' : ''}}" 
        wx:for="{{tabs}}" 
        wx:key="index"
        bindtap="onTabChange"
        data-index="{{index}}"
      >
        <text>{{item}}</text>
        <view class="tab-indicator" wx:if="{{activeTab === index}}"></view>
      </view>
    </view>
  </view>

  <!-- é¡¶éƒ¨ç­›é€‰æ  -->
  <view class="filter-bar">
    <view class="filter-item">
      <picker 
        bindchange="onStatusFilter" 
        value="{{statusFilterIndex}}" 
        range="{{statusFilterOptions}}"
        range-key="label"
      >
        <view class="picker-text">
          {{statusFilterOptions[statusFilterIndex].label}}
          <text class="iconfont icon-arrow-down"></text>
        </view>
      </picker>
    </view>
    
    <view class="filter-item">
      <picker 
        mode="date" 
        value="{{dateFilter}}" 
        bindchange="onDateFilter"
      >
        <view class="picker-text">
          {{dateFilter || 'é€‰æ‹©æ—¥æœŸ'}}
          <text class="iconfont icon-calendar"></text>
        </view>
      </picker>
    </view>
    
    <view class="filter-item search-item">
      <input 
        class="search-input" 
        placeholder="æœç´¢å®¢æˆ·å§“å" 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        confirm-type="search"
        bindconfirm="onSearchConfirm"
      />
      <text class="iconfont icon-search" bindtap="onSearchConfirm"></text>
    </view>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="stats-bar">
    <view class="stat-item">
      <text class="stat-number">{{statistics.todayFollow}}</text>
      <text class="stat-label">ä»Šæ—¥è·Ÿè¿›</text>
    </view>
    <view class="stat-item">
      <text class="stat-number">{{statistics.overdueFollow}}</text>
      <text class="stat-label">é€¾æœŸè·Ÿè¿›</text>
    </view>
    <view class="stat-item">
      <text class="stat-number">{{statistics.weeklyTarget}}</text>
      <text class="stat-label">å‘¨ç›®æ ‡</text>
    </view>
    <view class="stat-item">
      <text class="stat-number">{{statistics.completionRatePercent}}%</text>
      <text class="stat-label">å®Œæˆç‡</text>
    </view>
  </view>

  <!-- å¿«é€Ÿæ“ä½œæ  -->
  <view class="quick-actions">
    <view class="action-btn primary" bindtap="showAddFollowDialog">
      <van-icon name="plus" size="16px" />
      <text>æ·»åŠ è·Ÿè¿›</text>
    </view>
    <view class="action-btn secondary" bindtap="showAddFollowDialog" data-first-contact="true">
      <van-icon name="phone-o" size="16px" />
      <text>é¦–æ¬¡æ¥è§¦</text>
    </view>
    <view class="action-btn" bindtap="toggleSelectMode">
      <van-icon name="{{selectMode ? 'close' : 'setting-o'}}" size="16px" />
      <text>{{selectMode ? 'å–æ¶ˆé€‰æ‹©' : 'æ‰¹é‡æ“ä½œ'}}</text>
    </view>
  </view>

  <!-- è·Ÿè¿›åˆ—è¡¨ -->
  <view class="follow-list">
    <view 
      class="follow-item {{item.priority === 'high' ? 'urgent' : ''}}" 
      wx:for="{{followList}}" 
      wx:key="id"
      bindtap="onFollowItemTap"
      data-follow="{{item}}"
    >
      <!-- å®¢æˆ·ä¿¡æ¯å¤´éƒ¨ -->
      <view class="item-header">
        <view class="customer-info">
          <text class="customer-name">{{item.customerName}}</text>
          <text class="company-name">{{item.companyName}}</text>
          <view class="status-badges">
            <text class="badge status-{{item.status}}">{{item.statusText || 'å¾…è·Ÿè¿›'}}</text>
            <text class="badge priority-high" wx:if="{{item.priority === 'high'}}">ç´§æ€¥</text>
          </view>
        </view>
        <view class="item-actions">
          <text class="phone-btn" bindtap="onCallCustomer" data-phone="{{item.phone}}">ğŸ“</text>
        </view>
      </view>

      <!-- è·Ÿè¿›å†…å®¹ -->
      <view class="follow-content">
        <view class="follow-type">
          <text class="type-text">{{item.typeText || 'ç”µè¯æ²Ÿé€š'}}</text>
        </view>
        <view class="follow-desc">{{item.content}}</view>
        <view class="follow-result" wx:if="{{item.result}}">
          <text class="result-label">è·Ÿè¿›ç»“æœï¼š</text>
          <text class="result-text">{{item.result}}</text>
        </view>
      </view>

      <!-- æ—¶é—´å’Œä¸‹æ¬¡è·Ÿè¿› -->
      <view class="item-footer">
        <view class="time-info">
          <view class="follow-time">
            <text>è·Ÿè¿›æ—¶é—´ï¼š{{item.followDate}}</text>
          </view>
          <view class="next-follow" wx:if="{{item.nextFollowDate}}">
            <text class="{{item.isOverdue ? 'overdue' : ''}}">
              ä¸‹æ¬¡è·Ÿè¿›ï¼š{{item.nextFollowDate}}
            </text>
          </view>
        </view>
        
        <view class="operation-btns">
          <text class="op-btn" bindtap="onEditFollow" data-follow="{{item}}">ç¼–è¾‘</text>
          <text class="op-btn" bindtap="onContinueFollow" data-follow="{{item}}">ç»§ç»­è·Ÿè¿›</text>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{followList.length === 0 && !loading}}">
      <text class="empty-text">æš‚æ— è·Ÿè¿›è®°å½•</text>
      <view class="empty-action" bindtap="showAddFollowDialog">
        <text>æ·»åŠ ç¬¬ä¸€æ¡è·Ÿè¿›è®°å½•</text>
      </view>
    </view>

    <!-- åŠ è½½ä¸­çŠ¶æ€ -->
    <view class="loading-state" wx:if="{{loading}}">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- è°ƒè¯•ä¿¡æ¯ -->
    <view class="debug-info" style="padding: 20rpx; background: #f0f0f0; margin: 20rpx;">
      <text>è°ƒè¯•ä¿¡æ¯ï¼š</text>
      <text>followListé•¿åº¦: {{followList.length}}</text>
      <text>loadingçŠ¶æ€: {{loading ? 'æ˜¯' : 'å¦'}}</text>
      <text>activeTab: {{activeTab}}</text>
    </view>
  </view>

  <!-- æ·»åŠ è·Ÿè¿›æµ®åŠ¨æŒ‰é’® -->
  <view class="fab" bindtap="showAddFollowDialog">
    <text>+</text>
  </view>
</view>

<!-- æ·»åŠ /ç¼–è¾‘è·Ÿè¿›å¼¹çª— -->
<van-popup
  show="{{ showAddFollow }}"
  position="bottom"
  custom-style="min-height: 60%"
  bind:close="closeAddFollow"
>
  <view class="add-follow-container">
    <view class="popup-header">
      <text class="popup-title">æ·»åŠ è·Ÿè¿›è®°å½•</text>
      <van-icon name="cross" bind:click="closeAddFollow" />
    </view>

    <!-- å®¢æˆ·é€‰æ‹© -->
    <view class="form-item">
      <text class="form-label">è·Ÿè¿›å®¢æˆ·</text>
      <view class="customer-selector" bind:tap="selectCustomer">
        <text>{{ followForm.customerName || 'è¯·é€‰æ‹©å®¢æˆ·' }}</text>
        <van-icon name="arrow" />
      </view>
    </view>

    <!-- è·Ÿè¿›æ–¹å¼ -->
    <view class="form-item">
      <text class="form-label">è·Ÿè¿›æ–¹å¼</text>
      <view class="follow-type-selector" bind:tap="selectFollowType">
        <view class="type-info">
          <van-icon name="{{ getFollowTypeIcon(followForm.type) }}" />
          <text>{{ followForm.typeText }}</text>
        </view>
        <van-icon name="arrow" />
      </view>
    </view>

    <!-- éœ€æ±‚åˆ†ææŒ‰é’® -->
    <view class="form-item">
      <van-button 
        type="info" 
        block 
        icon="records" 
        bind:click="showNeedsAnalysisDialog"
      >
        è¿›è¡Œéœ€æ±‚åˆ†æ
      </van-button>
    </view>

    <!-- äº§å“æ¨èæŒ‰é’® -->
    <view class="form-item">
      <van-button 
        type="primary" 
        block 
        icon="gift" 
        bind:click="showProductRecommendDialog"
      >
        æ¨èäº§å“æ–¹æ¡ˆ
      </van-button>
    </view>

    <!-- è®¡ç®—å™¨æŒ‰é’® -->
    <view class="form-item">
      <van-button 
        type="warning" 
        block 
        icon="balance-list" 
        bind:click="goToCalculator"
      >
        èŠ‚ç”µæ•ˆç›Šè®¡ç®—
      </van-button>
    </view>

    <!-- è·Ÿè¿›å†…å®¹ -->
    <view class="form-item">
      <text class="form-label">è·Ÿè¿›å†…å®¹</text>
      <van-field
        type="textarea"
        value="{{ followForm.content }}"
        placeholder="è¯·è¾“å…¥è·Ÿè¿›å†…å®¹"
        autosize
        border="{{ false }}"
        bind:change="onContentInput"
      />
    </view>

    <!-- è·Ÿè¿›ç»“æœ -->
    <view class="form-item">
      <text class="form-label">è·Ÿè¿›ç»“æœ</text>
      <van-field
        type="textarea"
        value="{{ followForm.result }}"
        placeholder="è¯·è¾“å…¥è·Ÿè¿›ç»“æœ"
        autosize
        border="{{ false }}"
        bind:change="onResultInput"
      />
    </view>

    <!-- å…¶ä»–è¡¨å•é¡¹... -->

    <!-- ä¿å­˜æŒ‰é’® -->
    <view class="form-actions">
      <van-button 
        type="primary" 
        block 
        loading="{{ saving }}"
        bind:click="saveFollow"
      >
        ä¿å­˜
      </van-button>
    </view>
  </view>
</van-popup>

<!-- éœ€æ±‚åˆ†æå¼¹çª— -->
<van-popup
  show="{{ showNeedsAnalysis }}"
  position="bottom"
  custom-style="min-height: 70%"
  bind:close="closeNeedsAnalysis"
>
  <view class="needs-analysis-container">
    <view class="popup-header">
      <text class="popup-title">éœ€æ±‚åˆ†æ</text>
      <van-icon name="cross" bind:click="closeNeedsAnalysis" />
    </view>

    <!-- ç”¨ç”µä¿¡æ¯ -->
    <view class="form-section">
      <view class="section-title">ç”¨ç”µä¿¡æ¯</view>
      
      <view class="form-item">
        <text class="form-label">å½“å‰ç”¨ç”µé‡(kWh/æœˆ)</text>
        <van-field
          value="{{ needsForm.currentUsage }}"
          type="digit"
          placeholder="è¯·è¾“å…¥æœˆå‡ç”¨ç”µé‡"
          border="{{ false }}"
          bind:change="onNeedsFormInput"
          data-field="currentUsage"
        />
      </view>

      <view class="form-item">
        <text class="form-label">ç”µå‹ç­‰çº§</text>
        <van-field
          value="{{ needsForm.voltageLevel }}"
          placeholder="è¯·è¾“å…¥ç”µå‹ç­‰çº§"
          border="{{ false }}"
          bind:change="onNeedsFormInput"
          data-field="voltageLevel"
        />
      </view>
    </view>

    <!-- ä¼ä¸šä¿¡æ¯ -->
    <view class="form-section">
      <view class="section-title">ä¼ä¸šä¿¡æ¯</view>
      
      <view class="form-item">
        <text class="form-label">æ‰€å±è¡Œä¸š</text>
        <van-field
          value="{{ needsForm.industryType }}"
          placeholder="è¯·è¾“å…¥æ‰€å±è¡Œä¸š"
          border="{{ false }}"
          bind:change="onNeedsFormInput"
          data-field="industryType"
        />
      </view>

      <view class="form-item">
        <text class="form-label">ç»è¥è§„æ¨¡</text>
        <van-field
          value="{{ needsForm.businessScale }}"
          placeholder="è¯·è¾“å…¥ç»è¥è§„æ¨¡"
          border="{{ false }}"
          bind:change="onNeedsFormInput"
          data-field="businessScale"
        />
      </view>
    </view>

    <!-- éœ€æ±‚ä¿¡æ¯ -->
    <view class="form-section">
      <view class="section-title">éœ€æ±‚ä¿¡æ¯</view>
      
      <view class="form-item">
        <text class="form-label">ä¸»è¦ç—›ç‚¹</text>
        <van-checkbox-group value="{{ needsForm.painPoints }}" bind:change="onPainPointsChange">
          <van-checkbox
            wx:for="{{ painPointOptions }}"
            wx:key="value"
            name="{{ item.value }}"
            shape="square"
          >
            {{ item.text }}
          </van-checkbox>
        </van-checkbox-group>
      </view>

      <view class="form-item">
        <text class="form-label">é¢„ç®—èŒƒå›´</text>
        <van-dropdown-menu>
          <van-dropdown-item
            value="{{ needsForm.budget }}"
            options="{{ budgetOptions }}"
            bind:change="onNeedsFormInput"
            data-field="budget"
          />
        </van-dropdown-menu>
      </view>

      <view class="form-item">
        <text class="form-label">æœŸæœ›æ”¶ç›Š</text>
        <van-field
          value="{{ needsForm.expectedReturn }}"
          placeholder="è¯·è¾“å…¥æœŸæœ›æ”¶ç›Š"
          border="{{ false }}"
          bind:change="onNeedsFormInput"
          data-field="expectedReturn"
        />
      </view>

      <view class="form-item">
        <text class="form-label">å†³ç­–å‘¨æœŸ</text>
        <van-dropdown-menu>
          <van-dropdown-item
            value="{{ needsForm.decisionCycle }}"
            options="{{ decisionCycleOptions }}"
            bind:change="onNeedsFormInput"
            data-field="decisionCycle"
          />
        </van-dropdown-menu>
      </view>

      <view class="form-item">
        <text class="form-label">ç‰¹æ®Šéœ€æ±‚</text>
        <van-field
          type="textarea"
          value="{{ needsForm.specialNeeds }}"
          placeholder="è¯·è¾“å…¥ç‰¹æ®Šéœ€æ±‚"
          autosize
          border="{{ false }}"
          bind:change="onNeedsFormInput"
          data-field="specialNeeds"
        />
      </view>
    </view>

    <!-- ä¿å­˜æŒ‰é’® -->
    <view class="form-actions">
      <van-button 
        type="primary" 
        block 
        bind:click="saveNeedsAnalysis"
      >
        ä¿å­˜å¹¶æ¨èäº§å“
      </van-button>
    </view>
  </view>
</van-popup>

<!-- äº§å“æ¨èå¼¹çª— -->
<van-popup
  show="{{ showProductRecommend }}"
  position="bottom"
  custom-style="min-height: 60%"
  bind:close="closeProductRecommend"
>
  <view class="product-recommend-container">
    <view class="popup-header">
      <text class="popup-title">æ¨èäº§å“</text>
      <van-icon name="cross" bind:click="closeProductRecommend" />
    </view>

    <!-- äº§å“åˆ—è¡¨ -->
    <view class="product-list">
      <view 
        class="product-item"
        wx:for="{{ recommendProducts }}"
        wx:key="id"
        bind:tap="onSelectProduct"
        data-product="{{ item }}"
      >
        <image class="product-image" src="{{ item.image }}" mode="aspectFill"/>
        <view class="product-info">
          <view class="product-name">{{ item.name }}</view>
          <view class="product-price">{{ item.price }}å…ƒ/kWh</view>
          <view class="recommend-reason">{{ item.recommendReason }}</view>
          <view class="estimated-saving">é¢„è®¡æœˆèŠ‚çœ{{ item.estimatedSaving }}å…ƒ</view>
        </view>
        <van-icon name="arrow" />
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <van-empty 
      wx:if="{{ recommendProducts.length === 0 }}"
      description="æš‚æ— æ¨èäº§å“"
    />
  </view>
</van-popup>

<!-- å®¢æˆ·é€‰æ‹©å¼¹çª— -->
<van-popup show="{{showCustomerModal}}" position="bottom" round bind:close="closeCustomerModal">
  <view class="modal-content customer-modal">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©å®¢æˆ·</text>
      <text class="iconfont icon-close" bindtap="closeCustomerModal"></text>
    </view>
    
    <view class="modal-body">
      <van-search 
        value="{{customerSearchKeyword}}" 
        placeholder="æœç´¢å®¢æˆ·åç§°æˆ–å…¬å¸"
        bind:change="onCustomerSearchInput"
      />
      
      <view class="customer-list">
        <view 
          class="customer-item {{selectedCustomerId === item.id ? 'selected' : ''}}" 
          wx:for="{{availableCustomers}}" 
          wx:key="id"
          bindtap="onSelectCustomer"
          data-customer="{{item}}"
        >
          <view class="customer-info">
            <text class="customer-name">{{item.name}}</text>
            <text class="company-name">{{item.companyName}}</text>
            <text class="customer-phone">{{item.phone}}</text>
          </view>
          <view class="customer-status">
            <van-tag type="{{item.status === 'active' ? 'success' : 'default'}}" size="small">
              {{item.statusText}}
            </van-tag>
          </view>
        </view>
      </view>
    </view>
  </view>
</van-popup>

<!-- è·Ÿè¿›ç±»å‹é€‰æ‹©å¼¹çª— -->
<van-action-sheet 
  show="{{showFollowTypeModal}}" 
  actions="{{followTypeActions}}"
  bind:select="onFollowTypeSelect"
  bind:close="closeFollowTypeModal"
/>

<!-- é™„ä»¶ä¸Šä¼ é€‰æ‹©å¼¹çª— -->
<van-action-sheet 
  show="{{showAttachmentModal}}" 
  actions="{{attachmentTypes}}"
  bind:select="onAttachmentTypeSelect"
  bind:close="closeAttachmentModal"
  title="é€‰æ‹©é™„ä»¶ç±»å‹"
/>

<!-- æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨ -->
<van-popup show="{{showDatePicker}}" position="bottom" bind:close="closeDatePicker">
  <van-datetime-picker
    type="datetime"
    value="{{pickerDate}}"
    min-date="{{minDate}}"
    bind:confirm="onDateConfirm"
    bind:cancel="closeDatePicker"
  />
</van-popup>

<!-- ç­›é€‰é¢æ¿ -->
<van-popup show="{{showFilter}}" position="right" bind:close="closeFilter">
  <view class="filter-panel">
    <view class="filter-header">
      <text class="filter-title">ç­›é€‰æ¡ä»¶</text>
      <text class="filter-reset" bindtap="resetFilter">é‡ç½®</text>
    </view>
    
    <view class="filter-body">
      <view class="filter-group">
        <text class="filter-label">ä¼˜å…ˆçº§</text>
        <van-radio-group value="{{tempFilterParams.priority}}" bind:change="onFilterPriorityChange">
          <van-radio name="" icon-size="20rpx">å…¨éƒ¨</van-radio>
          <van-radio name="high" icon-size="20rpx">é«˜ä¼˜å…ˆçº§</van-radio>
          <van-radio name="medium" icon-size="20rpx">ä¸­ä¼˜å…ˆçº§</van-radio>
          <van-radio name="low" icon-size="20rpx">ä½ä¼˜å…ˆçº§</van-radio>
        </van-radio-group>
      </view>
      
      <view class="filter-group">
        <text class="filter-label">æ—¶é—´èŒƒå›´</text>
        <van-radio-group value="{{tempFilterParams.dateRange}}" bind:change="onFilterDateRangeChange">
          <van-radio name="" icon-size="20rpx">å…¨éƒ¨</van-radio>
          <van-radio name="today" icon-size="20rpx">ä»Šå¤©</van-radio>
          <van-radio name="week" icon-size="20rpx">æœ¬å‘¨</van-radio>
          <van-radio name="month" icon-size="20rpx">æœ¬æœˆ</van-radio>
          <van-radio name="overdue" icon-size="20rpx">å·²é€¾æœŸ</van-radio>
        </van-radio-group>
      </view>
    </view>
    
    <view class="filter-footer">
      <van-button plain size="large" bindtap="closeFilter">å–æ¶ˆ</van-button>
      <van-button type="primary" size="large" bindtap="applyFilter">ç¡®å®š</van-button>
    </view>
  </view>
</van-popup>

<!-- Toastæç¤º -->
<van-toast id="van-toast" />

<!-- åŠ è½½ä¸­ -->
<van-loading type="spinner" wx:if="{{loading}}" />

<view class="follow-page">
  <!-- é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-header">
    <view class="stats-card">
      <view class="card-row">
        <view class="stat-item" bind:tap="onStatTap" data-type="today">
          <view class="stat-number">{{statistics.todayFollow}}</view>
          <view class="stat-label">ä»Šæ—¥è·Ÿè¿›</view>
        </view>
        <view class="stat-item" bind:tap="onStatTap" data-type="pending">
          <view class="stat-number">{{statistics.pendingFollow}}</view>
          <view class="stat-label">å¾…è·Ÿè¿›</view>
        </view>
      </view>
      <view class="card-row">
        <view class="stat-item" bind:tap="onStatTap" data-type="overdue">
          <view class="stat-number overdue">{{statistics.overdueFollow}}</view>
          <view class="stat-label">å·²é€¾æœŸ</view>
        </view>
        <view class="stat-item" bind:tap="onStatTap" data-type="week">
          <view class="stat-number">{{statistics.weekFollow}}</view>
          <view class="stat-label">æœ¬å‘¨è·Ÿè¿›</view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰æ ‡ç­¾ -->
  <view class="filter-tabs">
    <scroll-view class="tabs-scroll" scroll-x="true">
      <view class="tab-list">
        <view 
          wx:for="{{followTabs}}" 
          wx:key="key"
          class="tab-item {{currentTab === item.key ? 'active' : ''}}"
          bind:tap="onTabChange"
          data-tab="{{item.key}}"
        >
          <text class="tab-text">{{item.name}}</text>
          <view class="tab-badge" wx:if="{{item.count > 0}}">{{item.count}}</view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æœç´¢å’Œç­›é€‰ -->
  <view class="search-filter-bar">
    <van-search
      value="{{ searchKeyword }}"
      placeholder="æœç´¢å®¢æˆ·åç§°æˆ–è·Ÿè¿›å†…å®¹"
      bind:search="onSearch"
      bind:clear="onSearchClear"
      bind:change="onSearchInput"
      use-action-slot
    >
      <view slot="action" bind:tap="showDateFilter">
        <van-icon name="calendar-o" />
      </view>
    </van-search>
  </view>

  <!-- è·Ÿè¿›åˆ—è¡¨ -->
  <view class="follow-list">
    <block wx:if="{{followList.length > 0}}">
      <view 
        wx:for="{{followList}}" 
        wx:key="id"
        class="follow-item {{item.status}}"
        bind:tap="onFollowTap"
        data-follow="{{item}}"
      >
        <!-- è·Ÿè¿›å¤´éƒ¨ -->
        <view class="follow-header">
          <view class="customer-info">
            <view class="customer-avatar">
              <image 
                src="{{item.customer.avatar || '/assets/images/default-avatar.png'}}" 
                mode="aspectFill"
              />
            </view>
            <view class="customer-details">
              <view class="customer-name">{{item.customer.name}}</view>
              <view class="customer-company">{{item.customer.companyName}}</view>
            </view>
          </view>
          <view class="follow-status">
            <view 
              class="status-tag status-{{item.status}}"
              style="background-color: {{getStatusColor(item.status)}}"
            >
              {{getStatusText(item.status)}}
            </view>
            <view class="priority-tag" wx:if="{{item.priority}}">
              <van-tag 
                type="{{getPriorityType(item.priority)}}" 
                size="small"
              >
                {{getPriorityText(item.priority)}}
              </van-tag>
            </view>
          </view>
        </view>

        <!-- è·Ÿè¿›æ—¶é—´ä¿¡æ¯ -->
        <view class="time-info">
          <view class="time-item">
            <van-icon name="clock-o" />
            <text class="time-label">è®¡åˆ’æ—¶é—´ï¼š</text>
            <text class="time-value {{isOverdue(item.planTime) ? 'overdue' : ''}}">
              {{formatTime(item.planTime)}}
            </text>
          </view>
          <view class="time-item" wx:if="{{item.actualTime}}">
            <van-icon name="passed" />
            <text class="time-label">å®Œæˆæ—¶é—´ï¼š</text>
            <text class="time-value">{{formatTime(item.actualTime)}}</text>
          </view>
        </view>

        <!-- è·Ÿè¿›å†…å®¹ -->
        <view class="follow-content">
          <view class="content-title">è·Ÿè¿›å†…å®¹</view>
          <view class="content-text">{{item.content || 'æš‚æ— å†…å®¹'}}</view>
        </view>

        <!-- è·Ÿè¿›ç»“æœï¼ˆå¦‚æœå·²å®Œæˆï¼‰ -->
        <view class="follow-result" wx:if="{{item.result && item.status === 'completed'}}">
          <view class="result-title">è·Ÿè¿›ç»“æœ</view>
          <view class="result-text">{{item.result}}</view>
          <view class="result-rating" wx:if="{{item.rating}}">
            <text class="rating-label">å®¢æˆ·æ»¡æ„åº¦ï¼š</text>
            <van-rate 
              value="{{ item.rating }}" 
              count="5" 
              size="16"
              readonly
              color="#ffd21e"
              void-color="#eee"
            />
          </view>
        </view>

        <!-- é™„ä»¶ä¿¡æ¯ -->
        <view class="attachments" wx:if="{{item.attachments && item.attachments.length > 0}}">
          <view class="attachments-title">
            <van-icon name="paperclip" />
            <text>é™„ä»¶ ({{item.attachments.length}})</text>
          </view>
          <view class="attachments-list">
            <view 
              wx:for="{{item.attachments}}" 
              wx:key="id"
              wx:for-item="attachment"
              class="attachment-item"
              bind:tap="previewAttachment"
              data-attachment="{{attachment}}"
            >
              <van-icon name="{{getAttachmentIcon(attachment.type)}}" />
              <text class="attachment-name">{{attachment.name}}</text>
            </view>
          </view>
        </view>

        <!-- æ“ä½œæŒ‰é’® -->
        <view class="follow-actions">
          <view 
            class="action-btn secondary"
            bind:tap="callCustomer"
            data-follow="{{item}}"
          >
            <van-icon name="phone-o" />
            <text>æ‹¨æ‰“</text>
          </view>
          <view 
            class="action-btn secondary"
            bind:tap="editFollow"
            data-follow="{{item}}"
            wx:if="{{item.status !== 'completed'}}"
          >
            <van-icon name="edit" />
            <text>ç¼–è¾‘</text>
          </view>
          <view 
            class="action-btn primary"
            bind:tap="completeFollow"
            data-follow="{{item}}"
            wx:if="{{item.status === 'pending'}}"
          >
            <van-icon name="success" />
            <text>å®Œæˆ</text>
          </view>
          <view 
            class="action-btn warning"
            bind:tap="postponeFollow"
            data-follow="{{item}}"
            wx:if="{{item.status === 'pending'}}"
          >
            <van-icon name="clock-o" />
            <text>å»¶æœŸ</text>
          </view>
        </view>

        <!-- ä¸‹æ¬¡è·Ÿè¿›æé†’ -->
        <view class="next-follow" wx:if="{{item.nextFollowTime}}">
          <view class="next-follow-info">
            <van-icon name="bell-o" />
            <text>ä¸‹æ¬¡è·Ÿè¿›ï¼š{{formatTime(item.nextFollowTime)}}</text>
          </view>
        </view>
      </view>
    </block>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-follow" wx:if="{{followList.length === 0 && !loading}}">
      <van-empty description="æš‚æ— è·Ÿè¿›è®°å½•">
        <van-button 
          type="primary" 
          size="small"
          bind:click="addFollow"
        >æ·»åŠ è·Ÿè¿›</van-button>
      </van-empty>
    </view>
  </view>

  <!-- æ—¥æœŸç­›é€‰å¼¹çª— -->
  <van-popup
    show="{{ showDateFilter }}"
    position="bottom"
    round
    bind:close="closeDateFilter"
  >
    <view class="date-filter-popup">
      <view class="popup-header">
        <text class="popup-title">é€‰æ‹©æ—¥æœŸèŒƒå›´</text>
        <van-icon name="cross" bind:tap="closeDateFilter" />
      </view>
      
      <van-calendar
        show="{{ showCalendar }}"
        type="range"
        bind:confirm="onDateRangeConfirm"
        bind:close="closeCalendar"
      />
      
      <view class="date-quick-select">
        <view class="quick-title">å¿«é€Ÿé€‰æ‹©</view>
        <view class="quick-options">
          <view 
            class="quick-option"
            bind:tap="selectQuickDate"
            data-type="today"
          >ä»Šå¤©</view>
          <view 
            class="quick-option"
            bind:tap="selectQuickDate"
            data-type="week"
          >æœ¬å‘¨</view>
          <view 
            class="quick-option"
            bind:tap="selectQuickDate"
            data-type="month"
          >æœ¬æœˆ</view>
          <view 
            class="quick-option"
            bind:tap="selectQuickDate"
            data-type="all"
          >å…¨éƒ¨</view>
        </view>
      </view>
      
      <view class="popup-actions">
        <van-button block bind:click="showCalendar">é€‰æ‹©æ—¥æœŸèŒƒå›´</van-button>
      </view>
    </view>
  </van-popup>

  <!-- å®Œæˆè·Ÿè¿›å¼¹çª— -->
  <van-popup
    show="{{ showCompletePopup }}"
    position="bottom"
    round
    bind:close="closeCompletePopup"
  >
    <view class="complete-popup">
      <view class="popup-header">
        <text class="popup-title">å®Œæˆè·Ÿè¿›</text>
        <van-icon name="cross" bind:tap="closeCompletePopup" />
      </view>
      
      <view class="complete-form">
        <van-field
          label="è·Ÿè¿›ç»“æœ"
          type="textarea"
          placeholder="è¯·è¾“å…¥è·Ÿè¿›ç»“æœå’Œå®¢æˆ·åé¦ˆ"
          value="{{ completeForm.result }}"
          bind:change="onCompleteResultChange"
          autosize
          maxlength="500"
          show-word-limit
        />
        
        <van-field label="å®¢æˆ·æ»¡æ„åº¦">
          <van-rate 
            slot="input"
            value="{{ completeForm.rating }}" 
            count="5" 
            size="20"
            bind:change="onRatingChange"
            color="#ffd21e"
            void-color="#eee"
          />
        </van-field>
        
        <van-field
          label="ä¸‹æ¬¡è·Ÿè¿›æ—¶é—´"
          value="{{ completeForm.nextFollowTime }}"
          placeholder="é€‰æ‹©ä¸‹æ¬¡è·Ÿè¿›æ—¶é—´"
          readonly
          is-link
          bind:click="selectNextFollowTime"
        />
      </view>
      
      <view class="popup-actions">
        <van-button block type="primary" bind:click="submitComplete">ç¡®è®¤å®Œæˆ</van-button>
      </view>
    </view>
  </van-popup>

  <!-- å»¶æœŸè·Ÿè¿›å¼¹çª— -->
  <van-popup
    show="{{ showPostponePopup }}"
    position="bottom"
    round
    bind:close="closePostponePopup"
  >
    <view class="postpone-popup">
      <view class="popup-header">
        <text class="popup-title">å»¶æœŸè·Ÿè¿›</text>
        <van-icon name="cross" bind:tap="closePostponePopup" />
      </view>
      
      <view class="postpone-form">
        <van-field
          label="å»¶æœŸè‡³"
          value="{{ postponeForm.newTime }}"
          placeholder="é€‰æ‹©æ–°çš„è·Ÿè¿›æ—¶é—´"
          readonly
          is-link
          bind:click="selectPostponeTime"
        />
        
        <van-field
          label="å»¶æœŸåŸå› "
          type="textarea"
          placeholder="è¯·è¾“å…¥å»¶æœŸåŸå› "
          value="{{ postponeForm.reason }}"
          bind:change="onPostponeReasonChange"
          autosize
          maxlength="200"
          show-word-limit
        />
      </view>
      
      <view class="popup-actions">
        <van-button block type="warning" bind:click="submitPostpone">ç¡®è®¤å»¶æœŸ</van-button>
      </view>
    </view>
  </van-popup>

  <!-- æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨ -->
  <van-datetime-picker
    show="{{ showDateTimePicker }}"
    type="datetime"
    value="{{ pickerDateTime }}"
    bind:confirm="onDateTimeConfirm"
    bind:cancel="closeDateTimePicker"
  />

  <!-- æµ®åŠ¨æ·»åŠ æŒ‰é’® -->
  <view class="fab-add" bind:tap="addFollow">
    <van-icon name="plus" />
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <van-loading size="24px">åŠ è½½ä¸­...</van-loading>
  </view>
</view> 