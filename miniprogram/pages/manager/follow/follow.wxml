<!--pages/manager/follow/follow.wxml-->
<view class="container">
  <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
  <view class="tabs-container">
    <view class="tabs-nav">
      <view 
        class="tab-item {{activeTab === index ? 'active' : ''}}" 
        wx:for="{{tabs}}" 
        wx:key="index"
        bindtap="onTabChange"
        data-index="{{index}}"
      >
        <text>{{item}}</text>
        <view class="tab-indicator" wx:if="{{activeTab === index}}"></view>
      </view>
    </view>
  </view>

  <!-- é¡¶éƒ¨ç­›é€‰æ  -->
  <view class="filter-bar">
    <view class="filter-item">
      <picker 
        bindchange="onStatusFilter" 
        value="{{statusFilterIndex}}" 
        range="{{statusFilterOptions}}"
        range-key="label"
      >
        <view class="picker-text">
          {{statusFilterOptions[statusFilterIndex].label}}
          <text class="iconfont icon-arrow-down"></text>
        </view>
      </picker>
    </view>
    
    <view class="filter-item">
      <picker 
        mode="date" 
        value="{{dateFilter}}" 
        bindchange="onDateFilter"
      >
        <view class="picker-text">
          {{dateFilter || 'é€‰æ‹©æ—¥æœŸ'}}
          <text class="iconfont icon-calendar"></text>
        </view>
      </picker>
    </view>
    
    <view class="filter-item search-item">
      <input 
        class="search-input" 
        placeholder="æœç´¢å®¢æˆ·å§“å" 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        confirm-type="search"
        bindconfirm="onSearchConfirm"
      />
      <text class="iconfont icon-search" bindtap="onSearchConfirm"></text>
    </view>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="stats-bar">
    <view class="stat-item">
      <text class="stat-number">{{statistics.todayFollow}}</text>
      <text class="stat-label">ä»Šæ—¥è·Ÿè¿›</text>
    </view>
    <view class="stat-item">
      <text class="stat-number">{{statistics.overdueFollow}}</text>
      <text class="stat-label">é€¾æœŸè·Ÿè¿›</text>
    </view>
    <view class="stat-item">
      <text class="stat-number">{{statistics.weeklyTarget}}</text>
      <text class="stat-label">å‘¨ç›®æ ‡</text>
    </view>
    <view class="stat-item">
      <text class="stat-number">{{statistics.completionRatePercent}}%</text>
      <text class="stat-label">å®Œæˆç‡</text>
    </view>
  </view>

  <!-- å¿«é€Ÿæ“ä½œæ  -->
  <view class="quick-actions">
    <view class="action-btn primary" bindtap="showAddFollowDialog">
      <text>æ·»åŠ è·Ÿè¿›</text>
    </view>
    <view class="action-btn" bindtap="toggleSelectMode">
      <text>{{selectMode ? 'å–æ¶ˆé€‰æ‹©' : 'æ‰¹é‡æ“ä½œ'}}</text>
    </view>
  </view>

  <!-- è·Ÿè¿›åˆ—è¡¨ -->
  <view class="follow-list">
    <view 
      class="follow-item {{item.priority === 'high' ? 'urgent' : ''}}" 
      wx:for="{{followList}}" 
      wx:key="id"
      bindtap="onFollowItemTap"
      data-follow="{{item}}"
    >
      <!-- å®¢æˆ·ä¿¡æ¯å¤´éƒ¨ -->
      <view class="item-header">
        <view class="customer-info">
          <text class="customer-name">{{item.customerName}}</text>
          <text class="company-name">{{item.companyName}}</text>
          <view class="status-badges">
            <text class="badge status-{{item.status}}">{{item.statusText || 'å¾…è·Ÿè¿›'}}</text>
            <text class="badge priority-high" wx:if="{{item.priority === 'high'}}">ç´§æ€¥</text>
          </view>
        </view>
        <view class="item-actions">
          <text class="phone-btn" bindtap="onCallCustomer" data-phone="{{item.phone}}">ğŸ“</text>
        </view>
      </view>

      <!-- è·Ÿè¿›å†…å®¹ -->
      <view class="follow-content">
        <view class="follow-type">
          <text class="type-text">{{item.typeText || 'ç”µè¯æ²Ÿé€š'}}</text>
        </view>
        <view class="follow-desc">{{item.content}}</view>
        <view class="follow-result" wx:if="{{item.result}}">
          <text class="result-label">è·Ÿè¿›ç»“æœï¼š</text>
          <text class="result-text">{{item.result}}</text>
        </view>
      </view>

      <!-- æ—¶é—´å’Œä¸‹æ¬¡è·Ÿè¿› -->
      <view class="item-footer">
        <view class="time-info">
          <view class="follow-time">
            <text>è·Ÿè¿›æ—¶é—´ï¼š{{item.followDate}}</text>
          </view>
          <view class="next-follow" wx:if="{{item.nextFollowDate}}">
            <text class="{{item.isOverdue ? 'overdue' : ''}}">
              ä¸‹æ¬¡è·Ÿè¿›ï¼š{{item.nextFollowDate}}
            </text>
          </view>
        </view>
        
        <view class="operation-btns">
          <text class="op-btn" bindtap="onEditFollow" data-follow="{{item}}">ç¼–è¾‘</text>
          <text class="op-btn" bindtap="onContinueFollow" data-follow="{{item}}">ç»§ç»­è·Ÿè¿›</text>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{followList.length === 0 && !loading}}">
      <text class="empty-text">æš‚æ— è·Ÿè¿›è®°å½•</text>
      <view class="empty-action" bindtap="showAddFollowDialog">
        <text>æ·»åŠ ç¬¬ä¸€æ¡è·Ÿè¿›è®°å½•</text>
      </view>
    </view>

    <!-- åŠ è½½ä¸­çŠ¶æ€ -->
    <view class="loading-state" wx:if="{{loading}}">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- è°ƒè¯•ä¿¡æ¯ -->
    <view class="debug-info" style="padding: 20rpx; background: #f0f0f0; margin: 20rpx;">
      <text>è°ƒè¯•ä¿¡æ¯ï¼š</text>
      <text>followListé•¿åº¦: {{followList.length}}</text>
      <text>loadingçŠ¶æ€: {{loading ? 'æ˜¯' : 'å¦'}}</text>
      <text>activeTab: {{activeTab}}</text>
    </view>
  </view>

  <!-- æ·»åŠ è·Ÿè¿›æµ®åŠ¨æŒ‰é’® -->
  <view class="fab" bindtap="showAddFollowDialog">
    <text>+</text>
  </view>
</view>

<!-- æ·»åŠ /ç¼–è¾‘è·Ÿè¿›å¼¹çª— -->
<van-popup show="{{showAddFollow}}" position="bottom" round bind:close="closeAddFollow">
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">{{followForm.id ? 'ç¼–è¾‘è·Ÿè¿›è®°å½•' : 'æ·»åŠ è·Ÿè¿›è®°å½•'}}</text>
      <text class="iconfont icon-close" bindtap="closeAddFollow"></text>
    </view>
    
    <view class="modal-body">
      <!-- å®¢æˆ·é€‰æ‹© -->
      <van-field 
        wx:if="{{!followForm.id}}"
        label="é€‰æ‹©å®¢æˆ·"
        value="{{followForm.customerName}}"
        placeholder="è¯·é€‰æ‹©å®¢æˆ·"
        readonly
        is-link
        bindtap="selectCustomer"
      />

      <!-- è·Ÿè¿›ç±»å‹ -->
      <van-field
        label="è·Ÿè¿›ç±»å‹"
        value="{{followForm.typeText}}"
        placeholder="è¯·é€‰æ‹©è·Ÿè¿›ç±»å‹"
        readonly
        is-link
        bindtap="selectFollowType"
      />

      <!-- è·Ÿè¿›å†…å®¹ -->
      <van-field
        label="è·Ÿè¿›å†…å®¹"
        type="textarea"
        value="{{followForm.content}}"
        placeholder="è¯·è¾“å…¥è·Ÿè¿›å†…å®¹..."
        maxlength="500"
        show-word-limit
        autosize
        bind:change="onContentInput"
      />

      <!-- è·Ÿè¿›ç»“æœ -->
      <van-field
        label="è·Ÿè¿›ç»“æœ"
        type="textarea"
        value="{{followForm.result}}"
        placeholder="è¯·è¾“å…¥è·Ÿè¿›ç»“æœ..."
        maxlength="300"
        show-word-limit
        autosize
        bind:change="onResultInput"
      />

      <!-- ä¸‹æ¬¡è·Ÿè¿›æ—¶é—´ -->
      <van-field
        label="ä¸‹æ¬¡è·Ÿè¿›"
        value="{{followForm.nextFollowDate}}"
        placeholder="è¯·é€‰æ‹©ä¸‹æ¬¡è·Ÿè¿›æ—¶é—´"
        readonly
        is-link
        bindtap="selectNextFollowDate"
      />

      <!-- ä¼˜å…ˆçº§ -->
      <van-field label="ä¼˜å…ˆçº§">
        <van-radio-group value="{{followForm.priority}}" bind:change="onPriorityChange">
          <van-radio name="low" icon-size="20rpx">ä½ä¼˜å…ˆçº§</van-radio>
          <van-radio name="medium" icon-size="20rpx">ä¸­ä¼˜å…ˆçº§</van-radio>
          <van-radio name="high" icon-size="20rpx">é«˜ä¼˜å…ˆçº§</van-radio>
        </van-radio-group>
      </van-field>

      <!-- æé†’è®¾ç½® -->
      <van-field label="æé†’è®¾ç½®">
        <van-switch checked="{{followForm.reminder}}" bind:change="onReminderChange" />
      </van-field>
    </view>
    
    <view class="modal-footer">
      <van-button plain size="large" bindtap="closeAddFollow">å–æ¶ˆ</van-button>
      <van-button type="primary" size="large" loading="{{saving}}" bindtap="saveFollow">
        {{saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}}
      </van-button>
    </view>
  </view>
</van-popup>

<!-- å®¢æˆ·é€‰æ‹©å¼¹çª— -->
<van-popup show="{{showCustomerModal}}" position="bottom" round bind:close="closeCustomerModal">
  <view class="modal-content customer-modal">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©å®¢æˆ·</text>
      <text class="iconfont icon-close" bindtap="closeCustomerModal"></text>
    </view>
    
    <view class="modal-body">
      <van-search 
        value="{{customerSearchKeyword}}" 
        placeholder="æœç´¢å®¢æˆ·åç§°æˆ–å…¬å¸"
        bind:change="onCustomerSearchInput"
      />
      
      <view class="customer-list">
        <view 
          class="customer-item {{selectedCustomerId === item.id ? 'selected' : ''}}" 
          wx:for="{{availableCustomers}}" 
          wx:key="id"
          bindtap="onSelectCustomer"
          data-customer="{{item}}"
        >
          <view class="customer-info">
            <text class="customer-name">{{item.name}}</text>
            <text class="company-name">{{item.companyName}}</text>
            <text class="customer-phone">{{item.phone}}</text>
          </view>
          <view class="customer-status">
            <van-tag type="{{item.status === 'active' ? 'success' : 'default'}}" size="small">
              {{item.statusText}}
            </van-tag>
          </view>
        </view>
      </view>
    </view>
  </view>
</van-popup>

<!-- è·Ÿè¿›ç±»å‹é€‰æ‹©å¼¹çª— -->
<van-action-sheet 
  show="{{showFollowTypeModal}}" 
  actions="{{followTypeActions}}"
  bind:select="onFollowTypeSelect"
  bind:close="closeFollowTypeModal"
/>

<!-- æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨ -->
<van-popup show="{{showDatePicker}}" position="bottom" bind:close="closeDatePicker">
  <van-datetime-picker
    type="datetime"
    value="{{pickerDate}}"
    min-date="{{minDate}}"
    bind:confirm="onDateConfirm"
    bind:cancel="closeDatePicker"
  />
</van-popup>

<!-- ç­›é€‰é¢æ¿ -->
<van-popup show="{{showFilter}}" position="right" bind:close="closeFilter">
  <view class="filter-panel">
    <view class="filter-header">
      <text class="filter-title">ç­›é€‰æ¡ä»¶</text>
      <text class="filter-reset" bindtap="resetFilter">é‡ç½®</text>
    </view>
    
    <view class="filter-body">
      <view class="filter-group">
        <text class="filter-label">ä¼˜å…ˆçº§</text>
        <van-radio-group value="{{tempFilterParams.priority}}" bind:change="onFilterPriorityChange">
          <van-radio name="" icon-size="20rpx">å…¨éƒ¨</van-radio>
          <van-radio name="high" icon-size="20rpx">é«˜ä¼˜å…ˆçº§</van-radio>
          <van-radio name="medium" icon-size="20rpx">ä¸­ä¼˜å…ˆçº§</van-radio>
          <van-radio name="low" icon-size="20rpx">ä½ä¼˜å…ˆçº§</van-radio>
        </van-radio-group>
      </view>
      
      <view class="filter-group">
        <text class="filter-label">æ—¶é—´èŒƒå›´</text>
        <van-radio-group value="{{tempFilterParams.dateRange}}" bind:change="onFilterDateRangeChange">
          <van-radio name="" icon-size="20rpx">å…¨éƒ¨</van-radio>
          <van-radio name="today" icon-size="20rpx">ä»Šå¤©</van-radio>
          <van-radio name="week" icon-size="20rpx">æœ¬å‘¨</van-radio>
          <van-radio name="month" icon-size="20rpx">æœ¬æœˆ</van-radio>
          <van-radio name="overdue" icon-size="20rpx">å·²é€¾æœŸ</van-radio>
        </van-radio-group>
      </view>
    </view>
    
    <view class="filter-footer">
      <van-button plain size="large" bindtap="closeFilter">å–æ¶ˆ</van-button>
      <van-button type="primary" size="large" bindtap="applyFilter">ç¡®å®š</van-button>
    </view>
  </view>
</van-popup>

<!-- Toastæç¤º -->
<van-toast id="van-toast" />

<!-- åŠ è½½ä¸­ -->
<van-loading type="spinner" wx:if="{{loading}}" /> 