<!--pages/manager/follow/add.wxml-->
<view class="follow-add-container">
  <!-- 权限守卫 -->
  <permission-guard required-user-type="manager" required-page="follow-add">
    
    <!-- 客户信息卡片 -->
    <view class="customer-card">
      <view class="customer-avatar">
        <text class="avatar-text">{{customerInfo.name ? customerInfo.name.charAt(0) : '客'}}</text>
      </view>
      <view class="customer-info">
        <view class="customer-name">{{customerInfo.name || '客户名称'}}</view>
        <view class="customer-company">{{customerInfo.company || '公司名称'}}</view>
        <view class="customer-position">{{customerInfo.position || '职位'}}</view>
      </view>
      <view class="customer-status">
        <view class="status-tag">{{customerInfo.status === 'interested' ? '有意向' : '待跟进'}}</view>
      </view>
    </view>
    
    <!-- 表单内容 -->
    <view class="form-container">
      
      <!-- 跟进类型 -->
      <view class="form-section">
        <view class="section-header">
          <text class="section-title">跟进类型</text>
          <text class="section-subtitle">选择本次跟进的方式</text>
        </view>
        <view class="type-grid">
          <view wx:for="{{followTypes}}" wx:key="value" 
                class="type-item {{followForm.type === item.value ? 'selected' : ''}}"
                data-value="{{item.value}}" bindtap="onSelectType">
            <view class="type-icon" style="background-color: {{item.color}}20; color: {{item.color}}">
              <text>{{item.icon}}</text>
            </view>
            <text class="type-label">{{item.label}}</text>
          </view>
        </view>
      </view>
      
      <!-- 快速模板 -->
      <view class="form-section">
        <view class="section-header">
          <text class="section-title">快速模板</text>
          <text class="section-subtitle">选择常用模板快速填写</text>
        </view>
        <view class="template-buttons">
          <view class="template-btn" data-type="phone" bindtap="onUseTemplate">电话模板</view>
          <view class="template-btn" data-type="visit" bindtap="onUseTemplate">拜访模板</view>
          <view class="template-btn" data-type="wechat" bindtap="onUseTemplate">微信模板</view>
          <view class="template-btn" data-type="email" bindtap="onUseTemplate">邮件模板</view>
        </view>
      </view>
      
      <!-- 跟进标题 -->
      <view class="form-section">
        <view class="section-header">
          <text class="section-title">跟进标题 <text class="required">*</text></text>
          <text class="section-subtitle">简洁描述本次跟进的主要内容</text>
        </view>
        <view class="input-group">
          <input class="form-input" 
                 placeholder="请输入跟进标题（如：电话沟通产品需求）" 
                 maxlength="50"
                 value="{{followForm.title}}"
                 bindinput="onTitleInput" />
          <text class="input-counter">{{followForm.title.length}}/50</text>
        </view>
      </view>
      
      <!-- 跟进内容 -->
      <view class="form-section">
        <view class="section-header">
          <text class="section-title">跟进内容 <text class="required">*</text></text>
          <text class="section-subtitle">详细描述跟进过程和结果</text>
        </view>
        <view class="textarea-group">
          <textarea class="form-textarea" 
                    placeholder="请详细描述本次跟进的具体内容、客户反馈、下一步计划等..."
                    maxlength="1000"
                    auto-height
                    value="{{followForm.content}}"
                    bindinput="onContentInput" />
          <text class="textarea-counter">{{followForm.content.length}}/1000</text>
        </view>
      </view>
      
      <!-- 优先级 -->
      <view class="form-section">
        <view class="section-header">
          <text class="section-title">优先级</text>
          <text class="section-subtitle">设置跟进的重要程度</text>
        </view>
        <view class="priority-selector">
          <view wx:for="{{priorities}}" wx:key="value"
                class="priority-item {{followForm.priority === item.value ? 'selected' : ''}}"
                data-value="{{item.value}}" bindtap="onSelectPriority">
            <view class="priority-color" style="background-color: {{item.color}}"></view>
            <text class="priority-label">{{item.label}}</text>
          </view>
        </view>
      </view>
      
      <!-- 下次跟进时间 -->
      <view class="form-section">
        <view class="section-header">
          <text class="section-title">下次跟进时间 <text class="required">*</text></text>
          <text class="section-subtitle">计划下次联系客户的时间</text>
        </view>
        <view class="datetime-group">
          <view class="datetime-item" bindtap="onShowDatePicker">
            <view class="datetime-label">日期</view>
            <view class="datetime-value">{{followForm.nextFollowDate || '请选择日期'}}</view>
            <image src="/assets/images/icons/calendar.png" class="datetime-icon" />
          </view>
          <view class="datetime-item" bindtap="onShowTimePicker">
            <view class="datetime-label">时间</view>
            <view class="datetime-value">{{followForm.nextFollowTime || '请选择时间'}}</view>
            <image src="/assets/images/icons/clock.png" class="datetime-icon" />
          </view>
        </view>
      </view>
      
      <!-- 标签 -->
      <view class="form-section">
        <view class="section-header">
          <text class="section-title">跟进标签</text>
          <text class="section-subtitle">添加标签便于分类管理</text>
        </view>
        
        <!-- 常用标签 -->
        <view class="common-tags">
          <view wx:for="{{commonTags}}" wx:key="index"
                class="tag-item {{followForm.tags.includes(item) ? 'selected' : ''}}"
                data-tag="{{item}}" bindtap="onAddTag">
            {{item}}
          </view>
          <view class="tag-item add-tag" bindtap="onShowTagInput">
            <image src="/assets/images/icons/add.png" class="add-icon" />
            自定义
          </view>
        </view>
        
        <!-- 已选标签 -->
        <view wx:if="{{followForm.tags.length > 0}}" class="selected-tags">
          <view class="selected-tags-title">已选标签：</view>
          <view class="selected-tags-list">
            <view wx:for="{{followForm.tags}}" wx:key="index"
                  class="selected-tag"
                  data-index="{{index}}" bindtap="onRemoveTag">
              {{item}}
              <image src="/assets/images/icons/close.png" class="remove-icon" />
            </view>
          </view>
        </view>
        
        <!-- 自定义标签输入 -->
        <view wx:if="{{showTagInput}}" class="tag-input-group">
          <input class="tag-input" 
                 placeholder="输入自定义标签" 
                 maxlength="20"
                 value="{{newTag}}"
                 bindinput="onNewTagInput" />
          <view class="tag-input-actions">
            <view class="tag-input-btn cancel" bindtap="onHideTagInput">取消</view>
            <view class="tag-input-btn confirm" bindtap="onAddNewTag">添加</view>
          </view>
        </view>
      </view>
      
      <!-- 附件 -->
      <view class="form-section">
        <view class="section-header">
          <text class="section-title">附件</text>
          <text class="section-subtitle">上传相关文件或图片</text>
        </view>
        
        <!-- 添加附件按钮 -->
        <view class="attachment-add" bindtap="onAddAttachment">
          <image src="/assets/images/icons/upload.png" class="upload-icon" />
          <text class="upload-text">点击添加附件</text>
          <text class="upload-hint">支持图片、文档等格式，最多3个文件</text>
        </view>
        
        <!-- 附件列表 -->
        <view wx:if="{{followForm.attachments.length > 0}}" class="attachment-list">
          <view wx:for="{{followForm.attachments}}" wx:key="index" class="attachment-item">
            <view class="attachment-info" data-index="{{index}}" bindtap="onPreviewAttachment">
              <image src="/assets/images/icons/file.png" class="file-icon" />
              <view class="file-details">
                <text class="file-name">{{item.name}}</text>
                <text class="file-size">{{formatFileSize(item.size)}}</text>
              </view>
            </view>
            <view class="attachment-remove" data-index="{{index}}" bindtap="onRemoveAttachment">
              <image src="/assets/images/icons/delete.png" class="remove-icon" />
            </view>
          </view>
        </view>
      </view>
      
    </view>
    
    <!-- 底部操作栏 -->
    <view class="bottom-actions">
      <view class="action-left">
        <view class="action-btn secondary" bindtap="onSaveDraft">保存草稿</view>
        <view class="action-btn secondary" bindtap="onLoadDraft">加载草稿</view>
      </view>
      <view class="action-right">
        <view class="submit-btn {{submitting ? 'loading' : ''}}" bindtap="onSubmit">
          <text wx:if="{{!submitting}}">提交跟进记录</text>
          <text wx:else>提交中...</text>
        </view>
      </view>
    </view>
    
    <!-- 日期选择器 -->
    <picker wx:if="{{showDatePicker}}" 
            mode="date" 
            value="{{followForm.nextFollowDate}}"
            bindchange="onDateConfirm"
            bindcancel="onDateCancel">
    </picker>
    
    <!-- 时间选择器 -->
    <picker wx:if="{{showTimePicker}}" 
            mode="time" 
            value="{{followForm.nextFollowTime}}"
            bindchange="onTimeConfirm"
            bindcancel="onTimeCancel">
    </picker>
    
  </permission-guard>
</view> 