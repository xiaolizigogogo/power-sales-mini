<!--pages/manager/follow/list.wxml-->
<permission-guard required-user-type="manager" required-page="/pages/manager/follow/list">
  <view class="follow-list-container">
    <!-- 头部统计信息 -->
    <view class="header-stats">
      <view class="stat-item">
        <text class="stat-number">{{totalCount}}</text>
        <text class="stat-label">总跟进数</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{todayCount}}</text>
        <text class="stat-label">今日跟进</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{weekCount}}</text>
        <text class="stat-label">本周跟进</text>
      </view>
      <view class="stat-item">
        <text class="stat-number text-danger">{{overdueCount}}</text>
        <text class="stat-label">逾期提醒</text>
      </view>
    </view>

    <!-- 搜索栏 -->
    <view class="search-bar">
      <view class="search-box">
        <van-icon class="search-icon" name="search" size="16px" color="#999"></van-icon>
        <input 
          class="search-input" 
          placeholder="搜索客户姓名、跟进内容"
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
          confirm-type="search"
        />
        <view class="clear-btn" wx:if="{{searchKeyword}}" bindtap="onClearSearch">
          <van-icon name="clear" size="14px" color="#999"></van-icon>
        </view>
      </view>
      <view class="filter-btn" bindtap="onShowFilter">
        <van-icon name="filter-o" size="16px" color="#666"></van-icon>
      </view>
    </view>

    <!-- 状态标签切换 -->
    <scroll-view class="status-tabs" scroll-x="{{true}}" show-scrollbar="{{false}}">
      <view class="tab-container">
        <view 
          class="tab-item {{activeTab === item.value ? 'active' : ''}} {{item.value === 'overdue' ? 'danger' : ''}}"
          wx:for="{{tabOptions}}" 
          wx:key="value"
          data-tab="{{item.value}}"
          bindtap="onTabChange"
        >
          <text class="tab-label">{{item.label}}</text>
          <text class="tab-count">{{item.count}}</text>
        </view>
      </view>
    </scroll-view>

    <!-- 跟进列表 -->
    <view class="follow-list">
      <view 
        class="follow-item {{item.isOverdue ? 'overdue' : ''}}"
        wx:for="{{followList}}" 
        wx:key="id"
        data-id="{{item.id}}"
        bindtap="onFollowTap"
      >
        <!-- 跟进类型图标 -->
        <view class="follow-type-icon {{item.followType}}">
          <text class="type-text">
            {{item.followType === 'phone' ? '📞' : 
              item.followType === 'visit' ? '🚶' : 
              item.followType === 'wechat' ? '💬' : '📧'}}
          </text>
        </view>
        
        <!-- 跟进内容 -->
        <view class="follow-content">
          <view class="follow-header">
            <view class="customer-info">
              <text class="customer-name">{{item.customerName}}</text>
              <text class="customer-company">{{item.customerCompany}}</text>
            </view>
            <view class="follow-status {{item.status}}">
              <text class="status-text">{{item.statusName}}</text>
            </view>
          </view>
          
          <view class="follow-detail">
            <text class="follow-title">{{item.title}}</text>
            <text class="follow-content-text">{{item.content}}</text>
          </view>
          
          <view class="follow-meta">
            <view class="meta-left">
              <text class="follow-time">跟进时间: {{item.followTime}}</text>
              <text class="priority priority-{{item.priority}}">{{item.priorityName}}优先级</text>
            </view>
            
            <view class="meta-right" wx:if="{{item.nextFollowTime}}">
              <text class="next-follow">下次跟进: {{item.nextFollowTime}}</text>
            </view>
          </view>
          
          <!-- 标签 -->
          <view class="follow-tags" wx:if="{{item.tags.length > 0}}">
            <text class="tag" wx:for="{{item.tags}}" wx:key="*this" wx:for-item="tag">{{tag}}</text>
          </view>
          
          <!-- 附件 -->
          <view class="attachments" wx:if="{{item.attachments.length > 0}}">
            <van-icon class="attachment-icon" name="paperclip" size="14px" color="#666"></van-icon>
            <text class="attachment-count">{{item.attachments.length}}个附件</text>
          </view>
        </view>
        
        <!-- 操作按钮 -->
        <view class="follow-actions">
          <view class="action-top">
            <view 
              class="contact-btn"
              data-phone="{{item.customerPhone}}"
              data-wechat="{{item.customerWechat}}"
              bindtap="onQuickContact"
            >
              <van-icon name="phone-o" size="16px" color="#52c41a"></van-icon>
            </view>
          </view>
          
          <view class="action-bottom" wx:if="{{item.status === 'pending'}}">
            <view 
              class="complete-btn"
              data-id="{{item.id}}"
              bindtap="onCompleteFollow"
            >
              <text>完成</text>
            </view>
            <view 
              class="delay-btn"
              data-id="{{item.id}}"
              bindtap="onDelayFollow"
            >
              <text>延期</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- 加载更多 -->
      <view class="load-more" wx:if="{{hasMore && !loading}}">
        <text>上拉加载更多</text>
      </view>
      
      <!-- 加载中 -->
      <view class="loading" wx:if="{{loading}}">
        <text>加载中...</text>
      </view>
      
      <!-- 暂无数据 -->
      <view class="empty-state" wx:if="{{!loading && followList.length === 0}}">
        <van-empty description="暂无跟进记录">
          <van-button round type="primary" size="small" bindtap="onAddFollow">
            添加跟进
          </van-button>
        </van-empty>
      </view>
    </view>

    <!-- 筛选弹窗 -->
    <view class="filter-modal" wx:if="{{showFilterModal}}">
      <view class="modal-mask" bindtap="onHideFilter"></view>
      <view class="modal-content">
        <view class="modal-header">
          <text class="modal-title">筛选条件</text>
          <view class="close-btn" bindtap="onHideFilter">
            <van-icon name="cross" size="16px" color="#999"></van-icon>
          </view>
        </view>
        
        <view class="filter-content">
          <!-- 跟进类型 -->
          <view class="filter-section">
            <text class="filter-label">跟进类型</text>
            <view class="filter-options">
              <view class="option-item">全部</view>
              <view class="option-item">电话跟进</view>
              <view class="option-item">实地拜访</view>
              <view class="option-item">微信沟通</view>
              <view class="option-item">邮件联系</view>
            </view>
          </view>
          
          <!-- 跟进状态 -->
          <view class="filter-section">
            <text class="filter-label">跟进状态</text>
            <view class="filter-options">
              <view class="option-item">全部</view>
              <view class="option-item">待跟进</view>
              <view class="option-item">已完成</view>
              <view class="option-item">已取消</view>
            </view>
          </view>
          
          <!-- 优先级 -->
          <view class="filter-section">
            <text class="filter-label">优先级</text>
            <view class="filter-options">
              <view class="option-item">全部</view>
              <view class="option-item">高优先级</view>
              <view class="option-item">中优先级</view>
              <view class="option-item">低优先级</view>
            </view>
          </view>
        </view>
        
        <view class="modal-footer">
          <view class="reset-btn" bindtap="onClearFilter">重置</view>
          <view class="confirm-btn" bindtap="onApplyFilter">确定</view>
        </view>
      </view>
    </view>

    <!-- 浮动添加按钮 -->
    <view class="floating-add-btn" bindtap="onAddFollow">
      <van-icon name="plus" size="20px" color="#fff"></van-icon>
    </view>
  </view>
</permission-guard> 