<!--å®¢æˆ·ç»ç†å·¥ä½œå°é¦–é¡µ-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-wrapper" wx:if="{{loading}}">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
  
  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else class="content">
    <!-- æ¬¢è¿åŒºåŸŸ -->
    <view class="welcome-section">
      <view class="welcome-header">
        <view class="welcome-text">
          <view class="greeting">
            <text class="time">{{refreshing ? 'åˆ·æ–°ä¸­...' : 'æ—©ä¸Šå¥½'}}</text>
            <text class="name">{{userInfo.name || 'å®¢æˆ·ç»ç†'}}</text>
          </view>
          <view class="date">{{refreshing ? '' : 'ä»Šå¤©æ˜¯ä¸ªå¥½æ—¥å­ï¼ŒåŠ æ²¹ï¼'}}</view>
          <!-- è°ƒè¯•ä¿¡æ¯ -->
          <view class="debug-info" wx:if="{{tokenInitialized}}">
            <text class="debug-text">ğŸ” è®¤è¯å·²åˆå§‹åŒ–</text>
          </view>
        </view>
        <view class="avatar">
          <view class="avatar-placeholder" wx:if="{{!userInfo.avatar}}">ğŸ‘¤</view>
          <image wx:else src="{{userInfo.avatar}}" mode="aspectFill" />
        </view>
      </view>
      
      <!-- Tokenè°ƒè¯•æŒ‰é’® -->
      <view class="debug-section" wx:if="{{tokenInitialized}}">
        <button class="debug-btn" size="mini" bindtap="onTokenDebugTap">ğŸ”§ Tokenè°ƒè¯•</button>
        <button class="debug-btn" size="mini" bindtap="onRefreshTokenTap">ğŸ”„ åˆ·æ–°Token</button>
        <button class="debug-btn logout" size="mini" bindtap="onLogoutTap">ğŸšª é€€å‡ºç™»å½•</button>
      </view>
    </view>

    <!-- ä»Šæ—¥æ•°æ® -->
    <view class="today-section">
      <view class="section-title">ä»Šæ—¥æ¦‚å†µ</view>
      <view class="today-grid">
        <view class="today-item" bindtap="onTodayDataTap" data-type="customers">
          <view class="today-number primary">{{workbenchData.todayData.newCustomers}}</view>
          <view class="today-label">æ–°å¢å®¢æˆ·</view>
        </view>
        <view class="today-item" bindtap="onTodayDataTap" data-type="tasks">
          <view class="today-number warning">{{workbenchData.todayData.followUpTasks}}</view>
          <view class="today-label">å¾…è·Ÿè¿›</view>
        </view>
        <view class="today-item" bindtap="onTodayDataTap" data-type="orders">
          <view class="today-number success">{{workbenchData.todayData.newOrders}}</view>
          <view class="today-label">æ–°è®¢å•</view>
        </view>
        <view class="today-item">
          <view class="today-number money">{{formatAmount(workbenchData.todayData.orderAmount)}}</view>
          <view class="today-label">æˆäº¤é‡‘é¢</view>
        </view>
      </view>
    </view>

    <!-- å¿«æ·æ“ä½œ -->
    <view class="quick-section">
      <view class="section-title">å¿«æ·æ“ä½œ</view>
      <view class="quick-grid">
        <view 
          wx:for="{{quickActions}}" 
          wx:key="title"
          class="quick-item"
          bindtap="onQuickActionTap"
          data-url="{{item.url}}"
        >
          <view class="quick-icon" style="background-color: {{item.color}}20;">
            <text class="quick-icon-text" style="color: {{item.color}};">{{item.icon === 'customers' ? 'ğŸ‘¥' : item.icon === 'follow' ? 'ğŸ“' : item.icon === 'performance' ? 'ğŸ“Š' : 'ğŸ“‹'}}</text>
          </view>
          <view class="quick-content">
            <view class="quick-title">{{item.title}}</view>
            <view class="quick-subtitle">{{item.subtitle}}</view>
          </view>
          <view class="quick-arrow">
            <text class="arrow-text">â€º</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æœ¬æœˆä¸šç»© -->
    <view class="performance-section">
      <view class="section-title">æœ¬æœˆä¸šç»©</view>
      <view class="performance-card">
        <view class="performance-header">
          <view class="performance-item">
            <view class="performance-number">{{workbenchData.monthData.newCustomers}}</view>
            <view class="performance-label">æ–°å¢å®¢æˆ·</view>
          </view>
          <view class="performance-item">
            <view class="performance-number">{{workbenchData.monthData.totalOrders}}</view>
            <view class="performance-label">æˆäº¤è®¢å•</view>
          </view>
          <view class="performance-item">
            <view class="performance-number">{{formatAmount(workbenchData.monthData.orderAmount)}}</view>
            <view class="performance-label">æˆäº¤é‡‘é¢</view>
          </view>
        </view>
        
        <view class="target-progress" bindtap="onTargetTap">
          <view class="target-header">
            <view class="target-title">ç›®æ ‡å®Œæˆåº¦</view>
            <view class="target-percent">{{workbenchData.monthData.targetProgress}}%</view>
          </view>
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{workbenchData.monthData.targetProgress}}%;"></view>
          </view>
        </view>
      </view>
    </view>

    <!-- æœ€è¿‘å®¢æˆ· -->
    <view wx:if="{{recentCustomers.length > 0}}" class="recent-section">
      <view class="section-header">
        <view class="section-title">æœ€è¿‘å®¢æˆ·</view>
        <view class="section-more" bindtap="onMoreCustomersTap">
          <text>æŸ¥çœ‹æ›´å¤š</text>
          <text class="arrow-text">â€º</text>
        </view>
      </view>
      <view class="recent-list">
        <view 
          wx:for="{{recentCustomers}}" 
          wx:key="id"
          class="recent-item"
          bindtap="onCustomerTap"
          data-customer-id="{{item.id}}"
        >
          <view class="customer-avatar">
            <view class="avatar-placeholder" wx:if="{{!item.avatar_url}}">ğŸ¢</view>
            <image wx:else src="{{item.avatar_url}}" mode="aspectFill" />
          </view>
          <view class="customer-info">
            <view class="customer-name">{{item.company || item.name}}</view>
            <view class="customer-contact">{{item.phone}}</view>
            <view class="customer-time">{{formatDate(item.lastContact)}}</view>
          </view>
          <view class="customer-status">
            <view class="status-tag status-{{item.status}}">
              {{item.status === 'following' ? 'è·Ÿè¿›ä¸­' : item.status === 'negotiating' ? 'å•†åŠ¡æ´½è°ˆ' : item.status === 'potential' ? 'æ½œåœ¨å®¢æˆ·' : 'å…¶ä»–'}}
            </view>
          </view>
          <view class="customer-actions">
            <view class="action-btn" bindtap="onCallTap" data-phone="{{item.phone}}" catchtap="true">
              <text>ğŸ“</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç´§æ€¥ä»»åŠ¡ -->
    <view wx:if="{{urgentTasks.length > 0}}" class="urgent-section">
      <view class="section-header">
        <view class="section-title">ç´§æ€¥ä»»åŠ¡</view>
        <view class="section-more" bindtap="onMoreTasksTap">
          <text>æŸ¥çœ‹æ›´å¤š</text>
          <text class="arrow-text">â€º</text>
        </view>
      </view>
      <view class="urgent-list">
        <view 
          wx:for="{{urgentTasks}}" 
          wx:key="id"
          class="urgent-item"
        >
          <view class="task-priority" style="background-color: {{getTaskPriorityColor(item.priority)}};"></view>
          <view class="task-content">
            <view class="task-title">{{item.content}}</view>
            <view class="task-customer">å®¢æˆ·ï¼š{{item.customerName}}</view>
            <view class="task-time">æˆªæ­¢ï¼š{{item.dueDate}}</view>
          </view>
          <view class="task-action">
            <button 
              class="follow-btn" 
              size="mini"
              bindtap="onFollowTap"
              data-customer-id="{{item.customerId}}"
              data-task-id="{{item.id}}"
            >
              ç«‹å³è·Ÿè¿›
            </button>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€æç¤º -->
    <view wx:if="{{recentCustomers.length === 0 && urgentTasks.length === 0}}" class="empty-section">
      <view class="empty-content">
        <text class="empty-icon">ğŸ“‹</text>
        <text class="empty-title">æš‚æ— å¾…å¤„ç†äº‹é¡¹</text>
        <text class="empty-desc">æ‚¨å¯ä»¥ä¸»åŠ¨æ·»åŠ å®¢æˆ·æˆ–ç­‰å¾…ç³»ç»Ÿåˆ†é…</text>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
  <view class="safe-area-bottom"></view>
</view>

<!-- æµ®åŠ¨æ“ä½œæŒ‰é’® (å¯é€‰) -->
<view class="fab-container" wx:if="{{showFab}}">
  <view class="fab-main" bindtap="onFabTap">
    <text class="icon-add"></text>
  </view>
  <view class="fab-options" wx:if="{{fabExpanded}}">
    <view class="fab-option" bindtap="onAddCustomerTap">
      <text class="icon-user-add"></text>
      <text>æ·»åŠ å®¢æˆ·</text>
    </view>
    <view class="fab-option" bindtap="onQuickFollowTap">
      <text class="icon-phone"></text>
      <text>å¿«é€Ÿè·Ÿè¿›</text>
    </view>
  </view>
</view>

<!-- ä¸‹æ‹‰åˆ·æ–°æç¤º -->
<view class="refresh-tip" wx:if="{{showRefreshTip}}">
  <text class="icon-refresh"></text>
  <text>æ•°æ®å·²æ›´æ–°</text>
</view> 