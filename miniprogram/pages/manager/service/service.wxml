<view class="service-management">
  <!-- é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-section">
    <view class="stats-grid">
      <view class="stat-card">
        <view class="stat-icon">ğŸš€</view>
        <view class="stat-number">{{statistics.pendingService}}</view>
        <view class="stat-label">å¾…å¼€é€š</view>
      </view>
      <view class="stat-card">
        <view class="stat-icon">âš¡</view>
        <view class="stat-number">{{statistics.activeService}}</view>
        <view class="stat-label">æœåŠ¡ä¸­</view>
      </view>
      <view class="stat-card">
        <view class="stat-icon">ğŸ“Š</view>
        <view class="stat-number">{{statistics.todayActivated}}</view>
        <view class="stat-label">ä»Šæ—¥å¼€é€š</view>
      </view>
      <view class="stat-card">
        <view class="stat-icon">ğŸ’¯</view>
        <view class="stat-number">{{statistics.satisfaction}}%</view>
        <view class="stat-label">æ»¡æ„åº¦</view>
      </view>
    </view>
  </view>

  <!-- æœç´¢å’Œç­›é€‰ -->
  <view class="search-filter-section">
    <view class="search-bar">
      <van-search
        value="{{ searchKeyword }}"
        placeholder="æœç´¢å®¢æˆ·åç§°ã€è®¢å•å·"
        use-action-slot
        bind:change="onSearchInput"
        bind:search="onSearchConfirm"
      >
        <view slot="action" bind:tap="onSearchConfirm">æœç´¢</view>
      </van-search>
    </view>
    
    <view class="filter-tabs">
      <view 
        wx:for="{{filterTabs}}" 
        wx:key="value"
        class="filter-tab {{currentFilter === item.value ? 'active' : ''}}"
        bind:tap="onFilterTabTap"
        data-filter="{{item.value}}"
      >
        <view class="tab-icon">{{item.icon}}</view>
        <view class="tab-text">{{item.label}}</view>
        <view wx:if="{{item.count > 0}}" class="tab-badge">{{item.count}}</view>
      </view>
    </view>
  </view>

  <!-- æœåŠ¡åˆ—è¡¨ -->
  <view class="service-list">
    <block wx:if="{{serviceList.length > 0}}">
      <view 
        wx:for="{{serviceList}}" 
        wx:key="id"
        class="service-card"
        bind:tap="onServiceTap"
        data-service="{{item}}"
      >
        <!-- æœåŠ¡å¤´éƒ¨ -->
        <view class="service-header">
          <view class="service-info">
            <view class="service-title">{{item.customerName}}</view>
            <view class="service-subtitle">{{item.productName}}</view>
          </view>
          <view class="service-status">
            <view 
              class="status-badge"
              style="background-color: {{getStatusColor(item.serviceStatus)}}"
            >{{getStatusText(item.serviceStatus)}}</view>
          </view>
        </view>

        <!-- è®¢å•ä¿¡æ¯ -->
        <view class="order-info">
          <view class="info-row">
            <view class="info-item">
              <text class="label">è®¢å•å·</text>
              <text class="value">{{item.orderNo}}</text>
            </view>
            <view class="info-item">
              <text class="label">åˆåŒé‡‘é¢</text>
              <text class="value highlight">Â¥{{formatAmount(item.amount)}}</text>
            </view>
          </view>
          <view class="info-row">
            <view class="info-item">
              <text class="label">æœåŠ¡æœŸé™</text>
              <text class="value">{{item.servicePeriod}}ä¸ªæœˆ</text>
            </view>
            <view class="info-item">
              <text class="label">å¼€é€šæ—¶é—´</text>
              <text class="value">{{item.activationDate || 'å¾…å¼€é€š'}}</text>
            </view>
          </view>
        </view>

        <!-- è¿›åº¦ä¿¡æ¯ -->
        <view class="progress-section" wx:if="{{item.serviceStatus === 'activating'}}">
          <view class="progress-title">å¼€é€šè¿›åº¦</view>
          <view class="progress-bar">
            <view 
              class="progress-fill" 
              style="width: {{item.progressPercent}}%"
            ></view>
          </view>
          <view class="progress-text">{{item.progressText}}</view>
        </view>

        <!-- æ“ä½œæŒ‰é’® -->
        <view class="action-buttons">
          <view 
            class="action-btn secondary"
            bind:tap="onContactCustomer"
            data-customer="{{item}}"
          >
            <van-icon name="phone-o" />
            <text>è”ç³»å®¢æˆ·</text>
          </view>
          
          <view 
            class="action-btn secondary"
            bind:tap="onViewProgress"
            data-service="{{item}}"
          >
            <van-icon name="info-o" />
            <text>æŸ¥çœ‹è¿›åº¦</text>
          </view>
          
          <view 
            wx:if="{{item.serviceStatus === 'pending'}}"
            class="action-btn primary"
            bind:tap="onStartActivation"
            data-service="{{item}}"
          >
            <van-icon name="play-circle-o" />
            <text>å¼€å§‹å¼€é€š</text>
          </view>
          
          <view 
            wx:if="{{item.serviceStatus === 'activating'}}"
            class="action-btn primary"
            bind:tap="onUpdateProgress"
            data-service="{{item}}"
          >
            <van-icon name="edit" />
            <text>æ›´æ–°è¿›åº¦</text>
          </view>
          
          <view 
            wx:if="{{item.serviceStatus === 'completed'}}"
            class="action-btn success"
            bind:tap="onServiceMonitor"
            data-service="{{item}}"
          >
            <van-icon name="eye-o" />
            <text>æœåŠ¡ç›‘æ§</text>
          </view>
        </view>
      </view>
    </block>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && serviceList.length === 0}}">
      <van-empty description="æš‚æ— æœåŠ¡è®°å½•">
        <van-button 
          type="primary" 
          size="small"
          bind:click="refreshData"
        >åˆ·æ–°æ•°æ®</van-button>
      </van-empty>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-more" wx:if="{{loading}}">
    <van-loading size="24px">åŠ è½½ä¸­...</van-loading>
  </view>

  <!-- æœåŠ¡å¼€é€šå¼¹çª— -->
  <van-dialog
    use-slot
    title="å¼€å§‹æœåŠ¡å¼€é€š"
    show="{{ showActivationDialog }}"
    bind:close="closeActivationDialog"
    confirmButtonText="ç¡®è®¤å¼€é€š"
    bind:confirm="confirmActivation"
  >
    <view class="activation-dialog">
      <view class="service-summary">
        <view class="summary-title">æœåŠ¡ä¿¡æ¯ç¡®è®¤</view>
        <view class="summary-item">
          <text class="label">å®¢æˆ·åç§°ï¼š</text>
          <text class="value">{{selectedService.customerName}}</text>
        </view>
        <view class="summary-item">
          <text class="label">äº§å“æœåŠ¡ï¼š</text>
          <text class="value">{{selectedService.productName}}</text>
        </view>
        <view class="summary-item">
          <text class="label">æœåŠ¡æœŸé™ï¼š</text>
          <text class="value">{{selectedService.servicePeriod}}ä¸ªæœˆ</text>
        </view>
      </view>

      <view class="activation-form">
        <view class="form-item">
          <text class="form-label">é¢„è®¡å¼€é€šæ—¶é—´</text>
          <van-field
            value="{{ activationForm.estimatedDate }}"
            placeholder="é€‰æ‹©é¢„è®¡å¼€é€šæ—¥æœŸ"
            readonly
            is-link
            bind:click="selectEstimatedDate"
          />
        </view>
        
        <view class="form-item">
          <text class="form-label">è´Ÿè´£éƒ¨é—¨</text>
          <van-field
            value="{{ activationForm.department }}"
            placeholder="é€‰æ‹©è´Ÿè´£éƒ¨é—¨"
            readonly
            is-link
            bind:click="selectDepartment"
          />
        </view>
        
        <view class="form-item">
          <text class="form-label">å¼€é€šè¯´æ˜</text>
          <van-field
            value="{{ activationForm.remark }}"
            type="textarea"
            placeholder="è¯·è¾“å…¥å¼€é€šè¯´æ˜æˆ–ç‰¹æ®Šè¦æ±‚"
            autosize
            bind:change="onActivationFormInput"
            data-field="remark"
          />
        </view>
      </view>
    </view>
  </van-dialog>

  <!-- è¿›åº¦æ›´æ–°å¼¹çª— -->
  <van-dialog
    use-slot
    title="æ›´æ–°å¼€é€šè¿›åº¦"
    show="{{ showProgressDialog }}"
    bind:close="closeProgressDialog"
    confirmButtonText="æ›´æ–°è¿›åº¦"
    bind:confirm="confirmProgressUpdate"
  >
    <view class="progress-dialog">
      <view class="progress-steps">
        <view 
          wx:for="{{progressSteps}}" 
          wx:key="value"
          class="progress-step {{item.value <= progressForm.currentStep ? 'completed' : ''}}"
          bind:tap="onProgressStepTap"
          data-step="{{item.value}}"
        >
          <view class="step-icon">
            <van-icon name="{{item.value <= progressForm.currentStep ? 'success' : 'circle'}}" />
          </view>
          <view class="step-text">{{item.label}}</view>
        </view>
      </view>

      <view class="progress-form">
        <view class="form-item">
          <text class="form-label">å½“å‰è¿›åº¦</text>
          <van-field
            value="{{ progressForm.stepText }}"
            placeholder="è¿›åº¦æè¿°"
            readonly
          />
        </view>
        
        <view class="form-item">
          <text class="form-label">è¿›åº¦è¯´æ˜</text>
          <van-field
            value="{{ progressForm.remark }}"
            type="textarea"
            placeholder="è¯·æè¿°å½“å‰è¿›åº¦è¯¦æƒ…"
            autosize
            bind:change="onProgressFormInput"
            data-field="remark"
          />
        </view>
        
        <view class="form-item">
          <text class="form-label">é¢„è®¡å®Œæˆæ—¶é—´</text>
          <van-field
            value="{{ progressForm.expectedDate }}"
            placeholder="é€‰æ‹©é¢„è®¡å®Œæˆæ—¶é—´"
            readonly
            is-link
            bind:click="selectExpectedDate"
          />
        </view>
      </view>
    </view>
  </van-dialog>

  <!-- æœåŠ¡ç›‘æ§å¼¹çª— -->
  <van-dialog
    use-slot
    title="æœåŠ¡ç›‘æ§"
    show="{{ showMonitorDialog }}"
    bind:close="closeMonitorDialog"
    confirmButtonText="ä¿å­˜è®°å½•"
    bind:confirm="confirmMonitorUpdate"
  >
    <view class="monitor-dialog">
      <view class="monitor-stats">
        <view class="stats-title">æœåŠ¡æ•°æ®ç›‘æ§</view>
        <view class="stats-grid">
          <view class="stat-item">
            <text class="stat-value">{{monitorData.powerConsumption}}</text>
            <text class="stat-label">æœˆç”¨ç”µé‡(kWh)</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">Â¥{{monitorData.monthlySavings}}</text>
            <text class="stat-label">æœˆèŠ‚çœé‡‘é¢</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{monitorData.satisfactionScore}}</text>
            <text class="stat-label">å®¢æˆ·æ»¡æ„åº¦</text>
          </view>
        </view>
      </view>

      <view class="monitor-form">
        <view class="form-item">
          <text class="form-label">å®¢æˆ·æ»¡æ„åº¦è¯„åˆ†</text>
          <van-rate
            value="{{ monitorForm.satisfaction }}"
            size="20"
            bind:change="onSatisfactionChange"
          />
        </view>
        
        <view class="form-item">
          <text class="form-label">æœåŠ¡é—®é¢˜è®°å½•</text>
          <van-field
            value="{{ monitorForm.issues }}"
            type="textarea"
            placeholder="è®°å½•å®¢æˆ·åé¦ˆçš„é—®é¢˜æˆ–å»ºè®®"
            autosize
            bind:change="onMonitorFormInput"
            data-field="issues"
          />
        </view>
        
        <view class="form-item">
          <text class="form-label">å¤„ç†æªæ–½</text>
          <van-field
            value="{{ monitorForm.solutions }}"
            type="textarea"
            placeholder="è®°å½•é‡‡å–çš„å¤„ç†æªæ–½"
            autosize
            bind:change="onMonitorFormInput"
            data-field="solutions"
          />
        </view>
      </view>
    </view>
  </van-dialog>

  <!-- éƒ¨é—¨é€‰æ‹©å™¨ -->
  <van-action-sheet
    show="{{ showDepartmentPicker }}"
    actions="{{ departmentOptions }}"
    bind:close="closeDepartmentPicker"
    bind:select="onDepartmentSelect"
    cancel-text="å–æ¶ˆ"
  />

  <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
  <van-datetime-picker
    show="{{ showDatePicker }}"
    type="date"
    value="{{ pickerDate }}"
    min-date="{{ minDate }}"
    bind:confirm="onDateConfirm"
    bind:cancel="closeDatePicker"
  />
</view> 