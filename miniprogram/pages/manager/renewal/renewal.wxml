<view class="renewal-page">
  <!-- é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-section">
    <view class="stats-grid">
      <view class="stat-card">
        <view class="stat-icon">â°</view>
        <view class="stat-number">{{statistics.expiringSoon}}</view>
        <view class="stat-label">å³å°†åˆ°æœŸ</view>
      </view>
      <view class="stat-card">
        <view class="stat-icon">ğŸ“‹</view>
        <view class="stat-number">{{statistics.pendingRenewal}}</view>
        <view class="stat-label">å¾…ç»­çº¦</view>
      </view>
      <view class="stat-card">
        <view class="stat-icon">âœ…</view>
        <view class="stat-number">{{statistics.renewedThisMonth}}</view>
        <view class="stat-label">æœ¬æœˆç»­çº¦</view>
      </view>
      <view class="stat-card">
        <view class="stat-icon">ğŸ“ˆ</view>
        <view class="stat-number">{{statistics.renewalRate}}%</view>
        <view class="stat-label">ç»­çº¦ç‡</view>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰æ ‡ç­¾ -->
  <view class="filter-section">
    <view class="filter-tabs">
      <view 
        wx:for="{{filterTabs}}" 
        wx:key="key"
        class="filter-tab {{currentFilter === item.key ? 'active' : ''}}"
        bind:tap="onFilterChange"
        data-filter="{{item.key}}"
      >
        <text class="tab-text">{{item.name}}</text>
        <view class="tab-count">{{item.count}}</view>
      </view>
    </view>
  </view>

  <!-- æœç´¢æ  -->
  <view class="search-section">
    <van-search
      value="{{ searchKeyword }}"
      placeholder="æœç´¢å®¢æˆ·åç§°æˆ–åˆåŒç¼–å·"
      bind:search="onSearch"
      bind:clear="onSearchClear"
      bind:change="onSearchInput"
    />
  </view>

  <!-- ç»­çº¦åˆ—è¡¨ -->
  <view class="renewal-list">
    <view class="list-header">
      <text class="list-title">ç»­çº¦ç®¡ç†</text>
      <view class="sort-options">
        <van-dropdown-menu>
          <van-dropdown-item 
            value="{{ sortBy }}" 
            options="{{ sortOptions }}"
            bind:change="onSortChange"
          />
        </van-dropdown-menu>
      </view>
    </view>

    <view class="contracts-container">
      <block wx:if="{{contractList.length > 0}}">
        <view 
          wx:for="{{contractList}}" 
          wx:key="id"
          class="contract-card"
          bind:tap="onContractTap"
          data-contract="{{item}}"
        >
          <!-- åˆåŒåŸºæœ¬ä¿¡æ¯ -->
          <view class="contract-header">
            <view class="contract-info">
              <view class="customer-name">{{item.customerName}}</view>
              <view class="contract-number">åˆåŒå·ï¼š{{item.contractNumber}}</view>
            </view>
            <view class="contract-status">
              <view 
                class="status-badge status-{{item.status}}"
                style="background-color: {{getRenewalStatusColor(item.status)}}"
              >
                {{getRenewalStatusText(item.status)}}
              </view>
            </view>
          </view>

          <!-- åˆåŒè¯¦æƒ… -->
          <view class="contract-details">
            <view class="detail-row">
              <view class="detail-item">
                <text class="detail-label">ç­¾çº¦æ—¶é—´</text>
                <text class="detail-value">{{item.signDate}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">åˆ°æœŸæ—¶é—´</text>
                <text class="detail-value expire-date">{{item.expireDate}}</text>
              </view>
            </view>
            <view class="detail-row">
              <view class="detail-item">
                <text class="detail-label">åˆåŒé‡‘é¢</text>
                <text class="detail-value amount">Â¥{{formatAmount(item.amount)}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">å‰©ä½™å¤©æ•°</text>
                <text class="detail-value {{item.daysLeft <= 30 ? 'urgent' : ''}}">
                  {{item.daysLeft}}å¤©
                </text>
              </view>
            </view>
          </view>

          <!-- ç»­çº¦è¿›åº¦ -->
          <view class="renewal-progress" wx:if="{{item.renewalProgress}}">
            <view class="progress-header">
              <text class="progress-title">ç»­çº¦è¿›åº¦</text>
              <text class="progress-percent">{{item.renewalProgress.completedSteps}}/{{item.renewalProgress.totalSteps}}</text>
            </view>
            <view class="progress-bar">
              <view 
                class="progress-fill" 
                style="width: {{(item.renewalProgress.completedSteps / item.renewalProgress.totalSteps) * 100}}%"
              ></view>
            </view>
            <view class="progress-desc">{{item.renewalProgress.currentStep}}</view>
          </view>

          <!-- æ“ä½œæŒ‰é’® -->
          <view class="contract-actions">
            <view 
              class="action-btn secondary"
              bind:tap="onCallCustomer"
              data-contract="{{item}}"
            >
              <van-icon name="phone-o" />
              <text>è”ç³»å®¢æˆ·</text>
            </view>
            
            <view 
              class="action-btn primary"
              bind:tap="onRenewalAction"
              data-contract="{{item}}"
            >
              <van-icon name="edit" />
              <text>{{getRenewalActionText(item.status)}}</text>
            </view>
          </view>
        </view>
      </block>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-contracts" wx:if="{{contractList.length === 0 && !loading}}">
        <van-empty description="æš‚æ— ç»­çº¦åˆåŒ">
          <van-button 
            type="primary" 
            size="small"
            bind:click="refreshData"
          >åˆ·æ–°æ•°æ®</van-button>
        </van-empty>
      </view>
    </view>
  </view>

  <!-- ç»­çº¦è·Ÿè¿›å¼¹çª— -->
  <van-dialog
    use-slot
    title="ç»­çº¦è·Ÿè¿›"
    show="{{ showRenewalDialog }}"
    bind:close="closeRenewalDialog"
    confirmButtonText="ä¿å­˜è·Ÿè¿›"
    bind:confirm="confirmRenewalFollow"
  >
    <view class="renewal-dialog">
      <view class="dialog-section">
        <view class="section-title">å®¢æˆ·ä¿¡æ¯</view>
        <view class="customer-summary">
          <view class="summary-item">
            <text class="label">å®¢æˆ·åç§°ï¼š</text>
            <text class="value">{{selectedContract.customerName}}</text>
          </view>
          <view class="summary-item">
            <text class="label">åˆåŒåˆ°æœŸï¼š</text>
            <text class="value">{{selectedContract.expireDate}}</text>
          </view>
          <view class="summary-item">
            <text class="label">å‰©ä½™å¤©æ•°ï¼š</text>
            <text class="value {{selectedContract.daysLeft <= 30 ? 'urgent' : ''}}">
              {{selectedContract.daysLeft}}å¤©
            </text>
          </view>
        </view>
      </view>

      <view class="dialog-section">
        <view class="section-title">ç»­çº¦æ„å‘è¯„ä¼°</view>
        <view class="intention-assessment">
          <van-field
            label="æ„å‘ç­‰çº§"
            value="{{ renewalForm.intentionLevel }}"
            placeholder="é€‰æ‹©å®¢æˆ·ç»­çº¦æ„å‘"
            readonly
            is-link
            bind:click="selectIntentionLevel"
          />
          <van-field
            label="å®¢æˆ·åé¦ˆ"
            value="{{ renewalForm.customerFeedback }}"
            type="textarea"
            placeholder="è®°å½•å®¢æˆ·å¯¹ç»­çº¦çš„åé¦ˆ"
            autosize
            bind:change="onRenewalFormInput"
            data-field="customerFeedback"
          />
        </view>
      </view>

      <view class="dialog-section">
        <view class="section-title">ç»­çº¦æ–¹æ¡ˆ</view>
        <view class="renewal-plan">
          <van-field
            label="ä¼˜æƒ æ”¿ç­–"
            value="{{ renewalForm.discountPolicy }}"
            placeholder="è¾“å…¥ä¼˜æƒ æ”¿ç­–"
            bind:change="onRenewalFormInput"
            data-field="discountPolicy"
          />
          <van-field
            label="ä»·æ ¼æ–¹æ¡ˆ"
            value="{{ renewalForm.priceScheme }}"
            placeholder="è¾“å…¥ä»·æ ¼æ–¹æ¡ˆ"
            bind:change="onRenewalFormInput"
            data-field="priceScheme"
          />
          <van-field
            label="æœåŠ¡æœŸé™"
            value="{{ renewalForm.servicePeriod }}"
            placeholder="é€‰æ‹©æœåŠ¡æœŸé™"
            readonly
            is-link
            bind:click="selectServicePeriod"
          />
        </view>
      </view>

      <view class="dialog-section">
        <view class="section-title">è·Ÿè¿›è®°å½•</view>
        <view class="follow-record">
          <van-field
            label="è·Ÿè¿›å†…å®¹"
            value="{{ renewalForm.followContent }}"
            type="textarea"
            placeholder="è¯¦ç»†è®°å½•æœ¬æ¬¡è·Ÿè¿›çš„å†…å®¹"
            autosize
            maxlength="500"
            show-word-limit
            bind:change="onRenewalFormInput"
            data-field="followContent"
          />
          <van-field
            label="ä¸‹æ¬¡è·Ÿè¿›"
            value="{{ renewalForm.nextFollowDate }}"
            placeholder="é€‰æ‹©ä¸‹æ¬¡è·Ÿè¿›æ—¶é—´"
            readonly
            is-link
            bind:click="selectNextFollowDate"
          />
        </view>
      </view>
    </view>
  </van-dialog>

  <!-- ç»­çº¦æé†’è®¾ç½®å¼¹çª— -->
  <van-dialog
    use-slot
    title="ç»­çº¦æé†’è®¾ç½®"
    show="{{ showReminderDialog }}"
    bind:close="closeReminderDialog"
    confirmButtonText="è®¾ç½®æé†’"
    bind:confirm="confirmReminderSetting"
  >
    <view class="reminder-dialog">
      <view class="reminder-options">
        <view class="option-item">
          <van-checkbox 
            value="{{ reminderForm.emailReminder }}"
            bind:change="onReminderFormChange"
            data-field="emailReminder"
          >
            é‚®ä»¶æé†’
          </van-checkbox>
        </view>
        <view class="option-item">
          <van-checkbox 
            value="{{ reminderForm.smsReminder }}"
            bind:change="onReminderFormChange"
            data-field="smsReminder"
          >
            çŸ­ä¿¡æé†’
          </van-checkbox>
        </view>
        <view class="option-item">
          <van-checkbox 
            value="{{ reminderForm.wechatReminder }}"
            bind:change="onReminderFormChange"
            data-field="wechatReminder"
          >
            å¾®ä¿¡æé†’
          </van-checkbox>
        </view>
      </view>
      
      <view class="reminder-timing">
        <van-field
          label="æé†’æ—¶é—´"
          value="{{ reminderForm.reminderDays }}"
          placeholder="é€‰æ‹©æå‰æé†’å¤©æ•°"
          readonly
          is-link
          bind:click="selectReminderDays"
        />
      </view>
    </view>
  </van-dialog>

  <!-- é€‰æ‹©å™¨ -->
  <van-action-sheet
    show="{{ showIntentionPicker }}"
    actions="{{ intentionOptions }}"
    bind:close="closeIntentionPicker"
    bind:select="onIntentionSelect"
    cancel-text="å–æ¶ˆ"
  />

  <van-action-sheet
    show="{{ showServicePeriodPicker }}"
    actions="{{ servicePeriodOptions }}"
    bind:close="closeServicePeriodPicker"
    bind:select="onServicePeriodSelect"
    cancel-text="å–æ¶ˆ"
  />

  <van-action-sheet
    show="{{ showReminderDaysPicker }}"
    actions="{{ reminderDaysOptions }}"
    bind:close="closeReminderDaysPicker"
    bind:select="onReminderDaysSelect"
    cancel-text="å–æ¶ˆ"
  />

  <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
  <van-datetime-picker
    show="{{ showDatePicker }}"
    type="date"
    value="{{ pickerDate }}"
    min-date="{{ minDate }}"
    bind:confirm="onDateConfirm"
    bind:cancel="closeDatePicker"
  />

  <!-- å¿«é€Ÿæ“ä½œ -->
  <view class="quick-actions">
    <view class="action-row">
      <view class="quick-btn" bind:tap="showExpiringContracts">
        <van-icon name="clock-o" />
        <text>å³å°†åˆ°æœŸ</text>
      </view>
      <view class="quick-btn" bind:tap="showRenewalReminders">
        <van-icon name="bell-o" />
        <text>ç»­çº¦æé†’</text>
      </view>
      <view class="quick-btn" bind:tap="exportRenewalReport">
        <van-icon name="description" />
        <text>ç»­çº¦æŠ¥å‘Š</text>
      </view>
      <view class="quick-btn" bind:tap="openRenewalSettings">
        <van-icon name="setting-o" />
        <text>æé†’è®¾ç½®</text>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <van-loading size="24px">åŠ è½½ä¸­...</van-loading>
  </view>
</view> 