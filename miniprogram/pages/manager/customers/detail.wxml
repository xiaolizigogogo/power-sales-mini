<!--pages/manager/customers/detail.wxml-->
<view class="customer-detail-container">
  <!-- æƒé™å®ˆå« -->
  <permission-guard required-user-type="manager" required-page="customer-detail">
    
    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{loading}}" class="loading">
      <image src="/assets/images/icons/loading.png" class="loading-icon" />
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
    
    <!-- å®¢æˆ·ä¿¡æ¯ -->
    <view wx:else class="customer-info">
      <!-- å¤´éƒ¨ä¿¡æ¯ -->
      <view class="customer-header">
        <view class="customer-avatar">
          <text class="avatar-text">{{customerInfo.name.charAt(0)}}</text>
        </view>
        <view class="customer-basic">
          <view class="customer-name">{{customerInfo.name}}</view>
          <view class="customer-company">{{customerInfo.company}}</view>
          <view class="customer-position">{{customerInfo.position}}</view>
        </view>
        <view class="customer-actions">
          <view class="status-tag" style="background-color: {{getStatusInfo(customerInfo.status).color}}" bindtap="onShowStatusModal">
            {{getStatusInfo(customerInfo.status).label}}
          </view>
          <view class="more-btn" bindtap="onShowMoreMenu">
            <image src="/assets/images/icons/more.png" />
          </view>
        </view>
      </view>
      
      <!-- ç»Ÿè®¡ä¿¡æ¯ -->
      <view class="customer-stats">
        <view class="stat-item">
          <view class="stat-value">{{customerInfo.totalOrders}}</view>
          <view class="stat-label">è®¢å•æ•°</view>
        </view>
        <view class="stat-item">
          <view class="stat-value">{{formatAmount(customerInfo.totalAmount)}}</view>
          <view class="stat-label">æ€»é‡‘é¢</view>
        </view>
        <view class="stat-item">
          <view class="stat-value">{{formatTime(customerInfo.lastFollowTime)}}</view>
          <view class="stat-label">æœ€åè·Ÿè¿›</view>
        </view>
      </view>
      
      <!-- è”ç³»æ–¹å¼ -->
      <view class="contact-info">
        <view class="contact-item">
          <image src="/assets/images/icons/phone.png" class="contact-icon" />
          <text class="contact-text">{{customerInfo.phone}}</text>
          <view class="contact-actions">
            <view class="action-btn" data-type="phone" bindtap="onQuickContact">
              <image src="/assets/images/icons/call.png" />
            </view>
            <view class="action-btn" data-type="sms" bindtap="onQuickContact">
              <image src="/assets/images/icons/message.png" />
            </view>
          </view>
        </view>
        
        <view class="contact-item">
          <image src="/assets/images/icons/email.png" class="contact-icon" />
          <text class="contact-text">{{customerInfo.email}}</text>
          <view class="contact-actions">
            <view class="action-btn" data-type="email" bindtap="onQuickContact">
              <image src="/assets/images/icons/copy.png" />
            </view>
          </view>
        </view>
        
        <view class="contact-item">
          <image src="/assets/images/icons/wechat.png" class="contact-icon" />
          <text class="contact-text">{{customerInfo.wechat}}</text>
          <view class="contact-actions">
            <view class="action-btn" data-type="wechat" bindtap="onQuickContact">
              <image src="/assets/images/icons/wechat.png" />
            </view>
          </view>
        </view>
      </view>
      
      <!-- è¯¦ç»†ä¿¡æ¯ -->
      <view class="detail-info">
        <view class="detail-section">
          <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
          <view class="detail-item">
            <text class="detail-label">æ‰€å±è¡Œä¸š</text>
            <text class="detail-value">{{customerInfo.industry}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">ä¼ä¸šè§„æ¨¡</text>
            <text class="detail-value">{{customerInfo.scale}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">å®¢æˆ·æ¥æº</text>
            <text class="detail-value">{{customerInfo.source}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">åœ°å€</text>
            <text class="detail-value">{{customerInfo.address}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">åˆ›å»ºæ—¶é—´</text>
            <text class="detail-value">{{customerInfo.createTime}}</text>
          </view>
        </view>
        
        <view class="detail-section">
          <view class="section-title">å®¢æˆ·æ ‡ç­¾</view>
          <view class="tags-container">
            <view wx:for="{{customerInfo.tags}}" wx:key="index" class="customer-tag">
              {{item}}
            </view>
          </view>
        </view>
        
        <view class="detail-section">
          <view class="section-title">å¤‡æ³¨ä¿¡æ¯</view>
          <view class="remark-content">{{customerInfo.remark}}</view>
        </view>
      </view>
      
      <!-- æ ‡ç­¾æ  -->
      <view class="tab-bar">
        <view class="tab-item {{tabIndex === 0 ? 'active' : ''}}" data-index="0" bindtap="onTabChange">
          <text class="tab-text">è·Ÿè¿›è®°å½•</text>
          <text class="tab-count">{{followRecords.length}}</text>
        </view>
        <view class="tab-item {{tabIndex === 1 ? 'active' : ''}}" data-index="1" bindtap="onTabChange">
          <text class="tab-text">è®¢å•è®°å½•</text>
          <text class="tab-count">{{orders.length}}</text>
        </view>
        <view class="tab-item {{tabIndex === 2 ? 'active' : ''}}" data-index="2" bindtap="onTabChange">
          <text class="tab-text">æ´»åŠ¨è®°å½•</text>
          <text class="tab-count">{{activities.length}}</text>
        </view>
      </view>
      
      <!-- è·Ÿè¿›è®°å½• -->
      <view wx:if="{{tabIndex === 0}}" class="follow-records">
        <view wx:if="{{loadingFollows}}" class="loading">
          <text>åŠ è½½è·Ÿè¿›è®°å½•...</text>
        </view>
        <view wx:elif="{{followRecords.length === 0}}" class="empty-state">
          <image src="/assets/images/icons/empty.png" />
          <text class="empty-text">æš‚æ— è·Ÿè¿›è®°å½•</text>
          <view class="add-follow-btn" bindtap="onShowFollowModal">æ·»åŠ è·Ÿè¿›</view>
        </view>
        <view wx:else class="follow-list">
          <view wx:for="{{followRecords}}" wx:key="id" class="follow-item">
            <view class="follow-type-icon {{item.type}}">
              <text class="type-text">
                {{item.type === 'phone' ? 'ğŸ“' : item.type === 'visit' ? 'ğŸ¢' : item.type === 'wechat' ? 'ğŸ’¬' : 'ğŸ“§'}}
              </text>
            </view>
            <view class="follow-content">
              <view class="follow-header">
                <view class="follow-title">{{item.title}}</view>
                <view class="follow-status {{item.status}}">
                  <text class="status-text">{{item.result}}</text>
                </view>
              </view>
              <view class="follow-text">{{item.content}}</view>
              <view class="follow-meta">
                <view class="follow-time">{{item.createTime}}</view>
                <view class="priority priority-{{item.priority}}">{{item.priority === 'high' ? 'é«˜ä¼˜å…ˆçº§' : item.priority === 'medium' ? 'ä¸­ä¼˜å…ˆçº§' : 'ä½ä¼˜å…ˆçº§'}}</view>
              </view>
              <view wx:if="{{item.tags && item.tags.length > 0}}" class="follow-tags">
                <view wx:for="{{item.tags}}" wx:key="index" wx:for-item="tag" class="tag">{{tag}}</view>
              </view>
              <view wx:if="{{item.nextFollowTime}}" class="next-follow">
                ä¸‹æ¬¡è·Ÿè¿›ï¼š{{item.nextFollowTime}}
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- è®¢å•è®°å½• -->
      <view wx:if="{{tabIndex === 1}}" class="order-records">
        <view wx:if="{{loadingOrders}}" class="loading">
          <text>åŠ è½½è®¢å•è®°å½•...</text>
        </view>
        <view wx:elif="{{orders.length === 0}}" class="empty-state">
          <image src="/assets/images/icons/empty.png" />
          <text class="empty-text">æš‚æ— è®¢å•è®°å½•</text>
          <view class="create-order-btn" bindtap="onCreateOrder">åˆ›å»ºè®¢å•</view>
        </view>
        <view wx:else class="order-list">
          <view wx:for="{{orders}}" wx:key="id" class="order-item" data-order-id="{{item.id}}" bindtap="onViewOrder">
            <view class="order-header">
              <view class="order-id">{{item.id}}</view>
              <view class="order-status {{item.status}}">
                {{item.status === 'completed' ? 'å·²å®Œæˆ' : item.status === 'pending' ? 'è¿›è¡Œä¸­' : 'å·²å–æ¶ˆ'}}
              </view>
            </view>
            <view class="order-content">
              <view class="order-product">{{item.productName}}</view>
              <view class="order-details">
                <text class="order-quantity">æ•°é‡ï¼š{{item.quantity}}</text>
                <text class="order-price">å•ä»·ï¼šÂ¥{{item.unitPrice}}</text>
              </view>
              <view class="order-amount">æ€»é¢ï¼šÂ¥{{item.totalAmount}}</view>
            </view>
            <view class="order-time">
              <text class="create-time">åˆ›å»ºï¼š{{item.createTime}}</text>
              <text wx:if="{{item.deliveryTime}}" class="delivery-time">äº¤ä»˜ï¼š{{item.deliveryTime}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- æ´»åŠ¨è®°å½• -->
      <view wx:if="{{tabIndex === 2}}" class="activity-records">
        <view wx:if="{{activities.length === 0}}" class="empty-state">
          <image src="/assets/images/icons/empty.png" />
          <text class="empty-text">æš‚æ— æ´»åŠ¨è®°å½•</text>
        </view>
        <view wx:else class="activity-list">
          <view wx:for="{{activities}}" wx:key="id" class="activity-item">
            <view class="activity-icon {{item.type}}">
              <text class="icon-text">
                {{item.type === 'follow' ? 'ğŸ“' : item.type === 'order' ? 'ğŸ“‹' : item.type === 'status' ? 'ğŸ”„' : 'ğŸ“Œ'}}
              </text>
            </view>
            <view class="activity-content">
              <view class="activity-title">{{item.title}}</view>
              <view class="activity-desc">{{item.content}}</view>
              <view class="activity-meta">
                <text class="activity-user">{{item.user}}</text>
                <text class="activity-time">{{formatTime(item.createTime)}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- æ›´å¤šèœå• -->
    <view wx:if="{{showMoreMenu}}" class="more-menu-modal" bindtap="onHideMoreMenu">
      <view class="menu-content" catchtap="">
        <view class="menu-item" bindtap="onEditCustomer">
          <image src="/assets/images/icons/edit.png" />
          <text>ç¼–è¾‘å®¢æˆ·</text>
        </view>
        <view class="menu-item" bindtap="onShowFollowModal">
          <image src="/assets/images/icons/follow.png" />
          <text>æ·»åŠ è·Ÿè¿›</text>
        </view>
        <view class="menu-item" bindtap="onCreateOrder">
          <image src="/assets/images/icons/order.png" />
          <text>åˆ›å»ºè®¢å•</text>
        </view>
        <view class="menu-item" bindtap="onShareCustomer">
          <image src="/assets/images/icons/share.png" />
          <text>åˆ†äº«å®¢æˆ·</text>
        </view>
      </view>
    </view>
    
    <!-- çŠ¶æ€ä¿®æ”¹å¼¹çª— -->
    <view wx:if="{{showStatusModal}}" class="status-modal" bindtap="onHideStatusModal">
      <view class="modal-content" catchtap="">
        <view class="modal-header">
          <text class="modal-title">ä¿®æ”¹å®¢æˆ·çŠ¶æ€</text>
          <image src="/assets/images/icons/close.png" class="close-btn" bindtap="onHideStatusModal" />
        </view>
        <view class="status-options">
          <view wx:for="{{statusOptions}}" wx:key="value" class="status-option {{customerInfo.status === item.value ? 'selected' : ''}}" 
                data-value="{{item.value}}" bindtap="onUpdateStatus">
            <view class="option-color" style="background-color: {{item.color}}"></view>
            <text class="option-label">{{item.label}}</text>
            <image wx:if="{{customerInfo.status === item.value}}" src="/assets/images/icons/check.png" class="check-icon" />
          </view>
        </view>
      </view>
    </view>
    
    <!-- æ·»åŠ è·Ÿè¿›å¼¹çª— -->
    <view wx:if="{{showFollowModal}}" class="follow-modal" bindtap="onHideFollowModal">
      <view class="modal-content" catchtap="">
        <view class="modal-header">
          <text class="modal-title">æ·»åŠ è·Ÿè¿›è®°å½•</text>
          <image src="/assets/images/icons/close.png" class="close-btn" bindtap="onHideFollowModal" />
        </view>
        <view class="follow-form">
          <view class="form-section">
            <text class="form-label">è·Ÿè¿›ç±»å‹</text>
            <view class="type-selector">
              <view wx:for="{{followTypes}}" wx:key="value" class="type-option {{newFollowType === item.value ? 'selected' : ''}}" 
                    data-field="type" data-value="{{item.value}}" bindtap="onFollowInput">
                <text class="type-icon">{{item.icon}}</text>
                <text class="type-label">{{item.label}}</text>
              </view>
            </view>
          </view>
          
          <view class="form-section">
            <text class="form-label">è·Ÿè¿›å†…å®¹</text>
            <textarea class="form-textarea" placeholder="è¯·è¾“å…¥è·Ÿè¿›å†…å®¹..." maxlength="500" 
                      data-field="content" bindinput="onFollowInput" value="{{newFollowContent}}" />
          </view>
          
          <view class="form-section">
            <text class="form-label">ä¼˜å…ˆçº§</text>
            <view class="priority-selector">
              <view wx:for="{{priorities}}" wx:key="value" class="priority-option {{newFollowPriority === item.value ? 'selected' : ''}}" 
                    data-field="priority" data-value="{{item.value}}" bindtap="onFollowInput">
                <view class="priority-color" style="background-color: {{item.color}}"></view>
                <text class="priority-label">{{item.label}}</text>
              </view>
            </view>
          </view>
          
          <view class="form-section">
            <text class="form-label">ä¸‹æ¬¡è·Ÿè¿›æ—¶é—´</text>
            <view class="datetime-selector">
              <picker mode="date" value="{{newFollowDate}}" data-field="date" bindchange="onFollowInput">
                <view class="datetime-input">{{newFollowDate}}</view>
              </picker>
              <picker mode="time" value="{{newFollowTime}}" data-field="time" bindchange="onFollowInput">
                <view class="datetime-input">{{newFollowTime}}</view>
              </picker>
            </view>
          </view>
        </view>
        
        <view class="modal-footer">
          <view class="cancel-btn" bindtap="onHideFollowModal">å–æ¶ˆ</view>
          <view class="confirm-btn" bindtap="onSubmitFollow">ç¡®å®š</view>
        </view>
      </view>
    </view>
    
    <!-- æµ®åŠ¨æ·»åŠ æŒ‰é’® -->
    <view wx:if="{{tabIndex === 0}}" class="floating-add-btn" bindtap="onShowFollowModal">
      <image src="/assets/images/icons/add.png" />
    </view>
    
  </permission-guard>
</view> 