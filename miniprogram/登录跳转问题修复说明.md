# 小程序登录跳转问题修复说明

## 问题描述
1. 普通用户登录成功后跳转回到登录页面
2. 客户经理登录成功后没有页面跳转

## 根本原因
1. **客户经理跳转问题**：原代码使用 `wx.switchTab` 跳转到 `/pages/manager/index/index`，但该页面不在 `app.json` 的 `tabBar` 配置中
2. **路径不一致**：`role-manager.js` 中的首页路径与自定义 tabBar 中的路径不一致
3. **状态管理不统一**：登录成功后只更新了 `role-manager` 的状态，但没有更新 `app.globalData.isLoggedIn`
4. **多处登录检查**：首页、auth-guard组件、loadHotProducts等多处都在检查登录状态，但使用的检查方式不统一

## 修复内容

### 1. 修复跳转方法 (utils/role-manager.js)
- 将 `wx.switchTab` 改为 `wx.reLaunch`
- 添加多重后备方案（reLaunch → switchTab → navigateTo）
- 统一客户经理首页路径为 `/pages/manager/workplace/workplace`

### 2. 统一登录状态检查 (pages/index/index.js)
- 首页的 `onShow` 方法改为使用 `role-manager.checkLoginStatus()`
- `loadHotProducts` 方法也改为使用 `role-manager.checkLoginStatus()`

### 3. 修复auth-guard组件 (components/auth-guard/index.js)
- 改为使用 `role-manager.checkLoginStatus()` 检查登录状态
- 这是首页跳转回登录页的主要原因

### 4. 双重状态管理 (pages/auth/login/login.js)
- 登录成功后同时调用 `role-manager.setCurrentUser()` 和 `app.login()`
- 确保两套状态管理系统都能正常工作

### 5. 添加调试信息
在以下位置添加了详细的 console.log：
- 登录过程的各个步骤
- 用户类型设置
- 页面跳转过程
- tabBar 更新过程
- 登录状态检查过程

## 修复后的执行流程

```
1. 用户登录成功
2. 存储token和用户信息
3. 调用 roleManager.setCurrentUser() 
4. 调用 app.login() 更新全局状态
5. 显示"登录成功"提示
6. 1.5秒后调用 roleManager.navigateToHomePage()
7. 使用 wx.reLaunch 跳转到首页
8. 首页 onShow 检查 roleManager.checkLoginStatus() → true
9. auth-guard 组件检查 roleManager.checkLoginStatus() → true
10. 页面正常显示，不再跳转回登录页
```

## 调试方法

### 1. 打开开发者工具
在微信开发者工具中查看 Console 面板

### 2. 关键调试信息
登录过程中会输出以下信息：

```
// 登录开始
开始密码登录: { phone: "138xxxx", loginType: "customer" }

// 接口响应
微信登录接口响应: { token: "xxx", userInfo: {...}, userType: "customer" }

// 登录成功处理
登录成功响应: { token: "xxx", userInfo: {...}, userType: "customer" }
设置当前用户开始: { userType: "customer", userInfo: {...} }
已更新app全局状态

// 页面跳转
开始跳转到首页
准备跳转到首页: { userType: "customer", homePage: "/pages/index/index" }
跳转首页成功: /pages/index/index

// 首页加载
首页onShow，检查登录状态
auth-guard检查登录状态: true
已登录，刷新页面数据
```

### 3. 测试步骤
1. 清除小程序缓存
2. 重新进入小程序
3. 分别测试普通用户和客户经理登录
4. 观察 Console 中的调试信息
5. 确认页面跳转是否正常

## 预期结果
- **普通用户**：登录成功后跳转到 `/pages/index/index` （首页）
- **客户经理**：登录成功后跳转到 `/pages/manager/workplace/workplace` （工作台）
- **不再出现**：登录成功后又跳转回登录页面的问题

## 如果问题仍然存在
请提供 Console 中的完整调试信息，特别是：
1. 登录接口的完整响应
2. 页面跳转过程中的错误信息
3. 用户类型设置过程中的信息
4. auth-guard组件的检查结果

## 相关文件
- `pages/auth/login/login.js` - 登录页面逻辑
- `utils/role-manager.js` - 角色管理和页面跳转
- `components/auth-guard/index.js` - 登录状态守卫组件
- `pages/index/index.js` - 首页登录状态检查
- `app.js` - 全局状态管理 