# 双用户类型小程序架构使用指南

## 概述

本小程序支持两种用户类型：
- **普通客户**：使用电力销售服务的客户
- **客户经理**：为客户提供服务的员工

每种用户类型都有独立的菜单系统、页面权限和功能模块。

## 架构组件

### 1. 角色管理器 (RoleManager)
**文件位置**: `utils/role-manager.js`

**主要功能**:
- 管理用户类型和权限
- 动态切换tabbar配置
- 页面访问权限控制

**使用示例**:
```javascript
const { roleManager, USER_TYPES } = require('../../utils/role-manager')

// 设置用户类型
roleManager.setCurrentUser(USER_TYPES.CUSTOMER, userInfo)

// 检查用户类型
if (roleManager.isManager()) {
  // 客户经理逻辑
} else {
  // 普通客户逻辑
}

// 检查页面权限
if (roleManager.checkPagePermission('/pages/manager/customers/customers')) {
  // 有权限访问
}
```

### 2. 权限守卫组件 (PermissionGuard)
**文件位置**: `components/permission-guard/`

**主要功能**:
- 页面级权限控制
- 自动跳转到登录页面
- 显示权限错误提示

**使用示例**:
```xml
<!-- 在页面中使用权限守卫 -->
<permission-guard required-user-type="manager" required-page="/pages/manager/customers/customers">
  <!-- 页面内容 -->
  <view>客户经理专属页面内容</view>
</permission-guard>
```

### 3. 自定义TabBar
**文件位置**: `custom-tab-bar/`

**主要功能**:
- 根据用户类型动态显示不同的底部菜单
- 自动权限检查
- 页面切换控制

**配置说明**:
```javascript
// 普通客户菜单
const customerTabs = [
  { icon: 'home-o', text: '首页', url: '/pages/index/index' },
  { icon: 'shop-o', text: '产品', url: '/pages/products/index/index' },
  { icon: 'orders-o', text: '订单', url: '/pages/orders/index/index' },
  { icon: 'user-o', text: '我的', url: '/pages/profile/index/index' }
]

// 客户经理菜单
const managerTabs = [
  { icon: 'apps-o', text: '工作台', url: '/pages/manager/index/index' },
  { icon: 'friends-o', text: '客户', url: '/pages/manager/customers/customers' },
  { icon: 'orders-o', text: '订单', url: '/pages/orders/index/index' },
  { icon: 'user-o', text: '我的', url: '/pages/profile/index/index' }
]
```

### 4. 统一登录页面
**文件位置**: `pages/auth/login/`

**主要功能**:
- 支持用户类型选择
- 多种登录方式（微信、密码、短信）
- 自动跳转到对应首页

**登录流程**:
1. 用户选择用户类型（普通客户/客户经理）
2. 选择登录方式（微信/密码/短信验证码）
3. 完成登录，系统自动设置用户类型
4. 跳转到对应的首页

## 页面权限配置

### 普通客户页面权限
```javascript
const customerPages = [
  '/pages/index/index',              // 首页
  '/pages/products/index/index',     // 产品列表
  '/pages/products/detail/detail',   // 产品详情
  '/pages/orders/index/index',       // 订单列表
  '/pages/orders/create/create',     // 创建订单
  '/pages/profile/index/index',      // 个人中心
  '/pages/profile/auth/auth',        // 企业认证
  '/pages/complaint/list/list',      // 投诉列表
  // ... 更多页面
]
```

### 客户经理页面权限
```javascript
const managerPages = [
  '/pages/manager/index/index',         // 工作台
  '/pages/manager/customers/customers', // 客户管理
  '/pages/manager/follow/follow',       // 跟进管理
  '/pages/manager/service/service',     // 服务管理
  '/pages/manager/performance/performance', // 业绩统计
  // ... 更多页面
]
```

## 如何在现有页面中添加权限控制

### 方法1: 使用权限守卫组件
```xml
<!-- 在页面的wxml文件中 -->
<permission-guard required-user-type="manager">
  <view class="page-content">
    <!-- 原有页面内容 -->
  </view>
</permission-guard>
```

### 方法2: 在页面JS中检查权限
```javascript
// 在页面的onLoad或onShow中
const { roleManager } = require('../../utils/role-manager')

Page({
  onLoad() {
    // 检查用户类型
    if (!roleManager.isManager()) {
      wx.showToast({
        title: '您没有权限访问此页面',
        icon: 'none'
      })
      wx.navigateBack()
      return
    }
    
    // 继续页面逻辑
  }
})
```

### 方法3: 条件渲染
```xml
<!-- 在wxml中根据用户类型条件渲染 -->
<view wx:if="{{userType === 'manager'}}">
  <!-- 客户经理专属内容 -->
</view>

<view wx:elif="{{userType === 'customer'}}">
  <!-- 普通客户专属内容 -->
</view>
```

## 后端API适配

### 统一认证接口
```javascript
// 前端调用示例
const response = await authAPI.login({
  phone: '13800138000',
  password: 'password123',
  loginType: 'customer' // 或 'manager'
})

// 后端返回格式
{
  "code": 200,
  "data": {
    "token": "jwt_token_here",
    "refreshToken": "refresh_token_here",
    "userType": "customer", // 或 "manager"
    "userInfo": {
      "id": 123,
      "name": "张三",
      "phone": "13800138000",
      // ... 其他用户信息
    },
    "expiresIn": 3600
  }
}
```

### 权限检查中间件
后端需要实现权限检查中间件，根据token中的用户类型进行权限验证。

## 新增页面的步骤

### 1. 创建页面文件
```bash
# 创建新的客户经理页面
mkdir -p pages/manager/new-feature
touch pages/manager/new-feature/new-feature.js
touch pages/manager/new-feature/new-feature.json
touch pages/manager/new-feature/new-feature.wxml
touch pages/manager/new-feature/new-feature.wxss
```

### 2. 添加页面权限配置
在 `utils/role-manager.js` 中添加新页面到对应的权限配置中：

```javascript
const ROLE_PERMISSIONS = {
  [USER_TYPES.MANAGER]: {
    pages: [
      // ... 现有页面
      '/pages/manager/new-feature/new-feature', // 新增页面
    ],
    // ...
  }
}
```

### 3. 添加导航入口
如果需要在tabbar中显示，更新tabbar配置：

```javascript
// 在role-manager.js中更新tabbar配置
tabbarConfig = [
  // ... 现有tab
  {
    icon: 'new-icon',
    text: '新功能',
    url: '/pages/manager/new-feature/new-feature'
  }
]
```

### 4. 页面中使用权限控制
```javascript
// new-feature.js
const { roleManager } = require('../../../utils/role-manager')

Page({
  onLoad() {
    // 检查权限
    if (!roleManager.isManager()) {
      wx.showToast({
        title: '您没有权限访问此页面',
        icon: 'none'
      })
      wx.navigateBack()
      return
    }
    
    // 页面初始化逻辑
  }
})
```

## 最佳实践

### 1. 用户类型判断
```javascript
// 推荐的用户类型判断方式
const { roleManager } = require('../../utils/role-manager')

// 优先使用角色管理器提供的方法
if (roleManager.isManager()) {
  // 客户经理逻辑
} else if (roleManager.isCustomer()) {
  // 普通客户逻辑
}

// 而不是直接判断字符串
// if (userType === 'manager') { ... } // 不推荐
```

### 2. 权限检查
```javascript
// 在需要权限控制的地方统一使用权限检查
if (!roleManager.checkPagePermission(currentPagePath)) {
  // 处理无权限情况
  return
}
```

### 3. 错误处理
```javascript
// 统一的错误处理方式
try {
  const response = await api.request(params)
  // 处理成功响应
} catch (error) {
  if (error.code === 403) {
    // 权限不足
    wx.showToast({
      title: '权限不足',
      icon: 'none'
    })
  } else {
    // 其他错误
    wx.showToast({
      title: error.message || '操作失败',
      icon: 'none'
    })
  }
}
```

## 常见问题

### Q1: 如何切换用户类型？
A1: 用户需要重新登录并选择不同的用户类型。系统会自动清除之前的登录状态。

### Q2: 如何为某个页面同时支持两种用户类型？
A2: 在权限配置中为两种用户类型都添加该页面，然后在页面中根据用户类型显示不同的内容。

### Q3: 如何处理权限不足的情况？
A3: 使用权限守卫组件会自动处理，或者在页面中手动检查权限并跳转。

### Q4: 如何添加新的用户类型？
A4: 在 `USER_TYPES` 常量中添加新类型，并在 `ROLE_PERMISSIONS` 中配置对应的权限。

## 总结

这个双用户类型架构提供了：
- 🔐 完整的权限控制系统
- 🎨 动态的用户界面切换
- 🚀 易于扩展的架构设计
- 📱 统一的用户体验

通过使用这个架构，你可以轻松地为不同类型的用户提供定制化的功能和体验。 