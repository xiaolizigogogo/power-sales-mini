# åŒç”¨æˆ·ç±»å‹å°ç¨‹åºæ¶æ„ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

æœ¬å°ç¨‹åºæ”¯æŒä¸¤ç§ç”¨æˆ·ç±»å‹ï¼š
- **æ™®é€šå®¢æˆ·**ï¼šä½¿ç”¨ç”µåŠ›é”€å”®æœåŠ¡çš„å®¢æˆ·
- **å®¢æˆ·ç»ç†**ï¼šä¸ºå®¢æˆ·æä¾›æœåŠ¡çš„å‘˜å·¥

æ¯ç§ç”¨æˆ·ç±»å‹éƒ½æœ‰ç‹¬ç«‹çš„èœå•ç³»ç»Ÿã€é¡µé¢æƒé™å’ŒåŠŸèƒ½æ¨¡å—ã€‚

## æ¶æ„ç»„ä»¶

### 1. è§’è‰²ç®¡ç†å™¨ (RoleManager)
**æ–‡ä»¶ä½ç½®**: `utils/role-manager.js`

**ä¸»è¦åŠŸèƒ½**:
- ç®¡ç†ç”¨æˆ·ç±»å‹å’Œæƒé™
- åŠ¨æ€åˆ‡æ¢tabbaré…ç½®
- é¡µé¢è®¿é—®æƒé™æ§åˆ¶

**ä½¿ç”¨ç¤ºä¾‹**:
```javascript
const { roleManager, USER_TYPES } = require('../../utils/role-manager')

// è®¾ç½®ç”¨æˆ·ç±»å‹
roleManager.setCurrentUser(USER_TYPES.CUSTOMER, userInfo)

// æ£€æŸ¥ç”¨æˆ·ç±»å‹
if (roleManager.isManager()) {
  // å®¢æˆ·ç»ç†é€»è¾‘
} else {
  // æ™®é€šå®¢æˆ·é€»è¾‘
}

// æ£€æŸ¥é¡µé¢æƒé™
if (roleManager.checkPagePermission('/pages/manager/customers/customers')) {
  // æœ‰æƒé™è®¿é—®
}
```

### 2. æƒé™å®ˆå«ç»„ä»¶ (PermissionGuard)
**æ–‡ä»¶ä½ç½®**: `components/permission-guard/`

**ä¸»è¦åŠŸèƒ½**:
- é¡µé¢çº§æƒé™æ§åˆ¶
- è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢
- æ˜¾ç¤ºæƒé™é”™è¯¯æç¤º

**ä½¿ç”¨ç¤ºä¾‹**:
```xml
<!-- åœ¨é¡µé¢ä¸­ä½¿ç”¨æƒé™å®ˆå« -->
<permission-guard required-user-type="manager" required-page="/pages/manager/customers/customers">
  <!-- é¡µé¢å†…å®¹ -->
  <view>å®¢æˆ·ç»ç†ä¸“å±é¡µé¢å†…å®¹</view>
</permission-guard>
```

### 3. è‡ªå®šä¹‰TabBar
**æ–‡ä»¶ä½ç½®**: `custom-tab-bar/`

**ä¸»è¦åŠŸèƒ½**:
- æ ¹æ®ç”¨æˆ·ç±»å‹åŠ¨æ€æ˜¾ç¤ºä¸åŒçš„åº•éƒ¨èœå•
- è‡ªåŠ¨æƒé™æ£€æŸ¥
- é¡µé¢åˆ‡æ¢æ§åˆ¶

**é…ç½®è¯´æ˜**:
```javascript
// æ™®é€šå®¢æˆ·èœå•
const customerTabs = [
  { icon: 'home-o', text: 'é¦–é¡µ', url: '/pages/index/index' },
  { icon: 'shop-o', text: 'äº§å“', url: '/pages/products/index/index' },
  { icon: 'orders-o', text: 'è®¢å•', url: '/pages/orders/index/index' },
  { icon: 'user-o', text: 'æˆ‘çš„', url: '/pages/profile/index/index' }
]

// å®¢æˆ·ç»ç†èœå•
const managerTabs = [
  { icon: 'apps-o', text: 'å·¥ä½œå°', url: '/pages/manager/index/index' },
  { icon: 'friends-o', text: 'å®¢æˆ·', url: '/pages/manager/customers/customers' },
  { icon: 'orders-o', text: 'è®¢å•', url: '/pages/orders/index/index' },
  { icon: 'user-o', text: 'æˆ‘çš„', url: '/pages/profile/index/index' }
]
```

### 4. ç»Ÿä¸€ç™»å½•é¡µé¢
**æ–‡ä»¶ä½ç½®**: `pages/auth/login/`

**ä¸»è¦åŠŸèƒ½**:
- æ”¯æŒç”¨æˆ·ç±»å‹é€‰æ‹©
- å¤šç§ç™»å½•æ–¹å¼ï¼ˆå¾®ä¿¡ã€å¯†ç ã€çŸ­ä¿¡ï¼‰
- è‡ªåŠ¨è·³è½¬åˆ°å¯¹åº”é¦–é¡µ

**ç™»å½•æµç¨‹**:
1. ç”¨æˆ·é€‰æ‹©ç”¨æˆ·ç±»å‹ï¼ˆæ™®é€šå®¢æˆ·/å®¢æˆ·ç»ç†ï¼‰
2. é€‰æ‹©ç™»å½•æ–¹å¼ï¼ˆå¾®ä¿¡/å¯†ç /çŸ­ä¿¡éªŒè¯ç ï¼‰
3. å®Œæˆç™»å½•ï¼Œç³»ç»Ÿè‡ªåŠ¨è®¾ç½®ç”¨æˆ·ç±»å‹
4. è·³è½¬åˆ°å¯¹åº”çš„é¦–é¡µ

## é¡µé¢æƒé™é…ç½®

### æ™®é€šå®¢æˆ·é¡µé¢æƒé™
```javascript
const customerPages = [
  '/pages/index/index',              // é¦–é¡µ
  '/pages/products/index/index',     // äº§å“åˆ—è¡¨
  '/pages/products/detail/detail',   // äº§å“è¯¦æƒ…
  '/pages/orders/index/index',       // è®¢å•åˆ—è¡¨
  '/pages/orders/create/create',     // åˆ›å»ºè®¢å•
  '/pages/profile/index/index',      // ä¸ªäººä¸­å¿ƒ
  '/pages/profile/auth/auth',        // ä¼ä¸šè®¤è¯
  '/pages/complaint/list/list',      // æŠ•è¯‰åˆ—è¡¨
  // ... æ›´å¤šé¡µé¢
]
```

### å®¢æˆ·ç»ç†é¡µé¢æƒé™
```javascript
const managerPages = [
  '/pages/manager/index/index',         // å·¥ä½œå°
  '/pages/manager/customers/customers', // å®¢æˆ·ç®¡ç†
  '/pages/manager/follow/follow',       // è·Ÿè¿›ç®¡ç†
  '/pages/manager/service/service',     // æœåŠ¡ç®¡ç†
  '/pages/manager/performance/performance', // ä¸šç»©ç»Ÿè®¡
  // ... æ›´å¤šé¡µé¢
]
```

## å¦‚ä½•åœ¨ç°æœ‰é¡µé¢ä¸­æ·»åŠ æƒé™æ§åˆ¶

### æ–¹æ³•1: ä½¿ç”¨æƒé™å®ˆå«ç»„ä»¶
```xml
<!-- åœ¨é¡µé¢çš„wxmlæ–‡ä»¶ä¸­ -->
<permission-guard required-user-type="manager">
  <view class="page-content">
    <!-- åŸæœ‰é¡µé¢å†…å®¹ -->
  </view>
</permission-guard>
```

### æ–¹æ³•2: åœ¨é¡µé¢JSä¸­æ£€æŸ¥æƒé™
```javascript
// åœ¨é¡µé¢çš„onLoadæˆ–onShowä¸­
const { roleManager } = require('../../utils/role-manager')

Page({
  onLoad() {
    // æ£€æŸ¥ç”¨æˆ·ç±»å‹
    if (!roleManager.isManager()) {
      wx.showToast({
        title: 'æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡µé¢',
        icon: 'none'
      })
      wx.navigateBack()
      return
    }
    
    // ç»§ç»­é¡µé¢é€»è¾‘
  }
})
```

### æ–¹æ³•3: æ¡ä»¶æ¸²æŸ“
```xml
<!-- åœ¨wxmlä¸­æ ¹æ®ç”¨æˆ·ç±»å‹æ¡ä»¶æ¸²æŸ“ -->
<view wx:if="{{userType === 'manager'}}">
  <!-- å®¢æˆ·ç»ç†ä¸“å±å†…å®¹ -->
</view>

<view wx:elif="{{userType === 'customer'}}">
  <!-- æ™®é€šå®¢æˆ·ä¸“å±å†…å®¹ -->
</view>
```

## åç«¯APIé€‚é…

### ç»Ÿä¸€è®¤è¯æ¥å£
```javascript
// å‰ç«¯è°ƒç”¨ç¤ºä¾‹
const response = await authAPI.login({
  phone: '13800138000',
  password: 'password123',
  loginType: 'customer' // æˆ– 'manager'
})

// åç«¯è¿”å›æ ¼å¼
{
  "code": 200,
  "data": {
    "token": "jwt_token_here",
    "refreshToken": "refresh_token_here",
    "userType": "customer", // æˆ– "manager"
    "userInfo": {
      "id": 123,
      "name": "å¼ ä¸‰",
      "phone": "13800138000",
      // ... å…¶ä»–ç”¨æˆ·ä¿¡æ¯
    },
    "expiresIn": 3600
  }
}
```

### æƒé™æ£€æŸ¥ä¸­é—´ä»¶
åç«¯éœ€è¦å®ç°æƒé™æ£€æŸ¥ä¸­é—´ä»¶ï¼Œæ ¹æ®tokenä¸­çš„ç”¨æˆ·ç±»å‹è¿›è¡Œæƒé™éªŒè¯ã€‚

## æ–°å¢é¡µé¢çš„æ­¥éª¤

### 1. åˆ›å»ºé¡µé¢æ–‡ä»¶
```bash
# åˆ›å»ºæ–°çš„å®¢æˆ·ç»ç†é¡µé¢
mkdir -p pages/manager/new-feature
touch pages/manager/new-feature/new-feature.js
touch pages/manager/new-feature/new-feature.json
touch pages/manager/new-feature/new-feature.wxml
touch pages/manager/new-feature/new-feature.wxss
```

### 2. æ·»åŠ é¡µé¢æƒé™é…ç½®
åœ¨ `utils/role-manager.js` ä¸­æ·»åŠ æ–°é¡µé¢åˆ°å¯¹åº”çš„æƒé™é…ç½®ä¸­ï¼š

```javascript
const ROLE_PERMISSIONS = {
  [USER_TYPES.MANAGER]: {
    pages: [
      // ... ç°æœ‰é¡µé¢
      '/pages/manager/new-feature/new-feature', // æ–°å¢é¡µé¢
    ],
    // ...
  }
}
```

### 3. æ·»åŠ å¯¼èˆªå…¥å£
å¦‚æœéœ€è¦åœ¨tabbarä¸­æ˜¾ç¤ºï¼Œæ›´æ–°tabbaré…ç½®ï¼š

```javascript
// åœ¨role-manager.jsä¸­æ›´æ–°tabbaré…ç½®
tabbarConfig = [
  // ... ç°æœ‰tab
  {
    icon: 'new-icon',
    text: 'æ–°åŠŸèƒ½',
    url: '/pages/manager/new-feature/new-feature'
  }
]
```

### 4. é¡µé¢ä¸­ä½¿ç”¨æƒé™æ§åˆ¶
```javascript
// new-feature.js
const { roleManager } = require('../../../utils/role-manager')

Page({
  onLoad() {
    // æ£€æŸ¥æƒé™
    if (!roleManager.isManager()) {
      wx.showToast({
        title: 'æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡µé¢',
        icon: 'none'
      })
      wx.navigateBack()
      return
    }
    
    // é¡µé¢åˆå§‹åŒ–é€»è¾‘
  }
})
```

## æœ€ä½³å®è·µ

### 1. ç”¨æˆ·ç±»å‹åˆ¤æ–­
```javascript
// æ¨èçš„ç”¨æˆ·ç±»å‹åˆ¤æ–­æ–¹å¼
const { roleManager } = require('../../utils/role-manager')

// ä¼˜å…ˆä½¿ç”¨è§’è‰²ç®¡ç†å™¨æä¾›çš„æ–¹æ³•
if (roleManager.isManager()) {
  // å®¢æˆ·ç»ç†é€»è¾‘
} else if (roleManager.isCustomer()) {
  // æ™®é€šå®¢æˆ·é€»è¾‘
}

// è€Œä¸æ˜¯ç›´æ¥åˆ¤æ–­å­—ç¬¦ä¸²
// if (userType === 'manager') { ... } // ä¸æ¨è
```

### 2. æƒé™æ£€æŸ¥
```javascript
// åœ¨éœ€è¦æƒé™æ§åˆ¶çš„åœ°æ–¹ç»Ÿä¸€ä½¿ç”¨æƒé™æ£€æŸ¥
if (!roleManager.checkPagePermission(currentPagePath)) {
  // å¤„ç†æ— æƒé™æƒ…å†µ
  return
}
```

### 3. é”™è¯¯å¤„ç†
```javascript
// ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ–¹å¼
try {
  const response = await api.request(params)
  // å¤„ç†æˆåŠŸå“åº”
} catch (error) {
  if (error.code === 403) {
    // æƒé™ä¸è¶³
    wx.showToast({
      title: 'æƒé™ä¸è¶³',
      icon: 'none'
    })
  } else {
    // å…¶ä»–é”™è¯¯
    wx.showToast({
      title: error.message || 'æ“ä½œå¤±è´¥',
      icon: 'none'
    })
  }
}
```

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•åˆ‡æ¢ç”¨æˆ·ç±»å‹ï¼Ÿ
A1: ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•å¹¶é€‰æ‹©ä¸åŒçš„ç”¨æˆ·ç±»å‹ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨æ¸…é™¤ä¹‹å‰çš„ç™»å½•çŠ¶æ€ã€‚

### Q2: å¦‚ä½•ä¸ºæŸä¸ªé¡µé¢åŒæ—¶æ”¯æŒä¸¤ç§ç”¨æˆ·ç±»å‹ï¼Ÿ
A2: åœ¨æƒé™é…ç½®ä¸­ä¸ºä¸¤ç§ç”¨æˆ·ç±»å‹éƒ½æ·»åŠ è¯¥é¡µé¢ï¼Œç„¶ååœ¨é¡µé¢ä¸­æ ¹æ®ç”¨æˆ·ç±»å‹æ˜¾ç¤ºä¸åŒçš„å†…å®¹ã€‚

### Q3: å¦‚ä½•å¤„ç†æƒé™ä¸è¶³çš„æƒ…å†µï¼Ÿ
A3: ä½¿ç”¨æƒé™å®ˆå«ç»„ä»¶ä¼šè‡ªåŠ¨å¤„ç†ï¼Œæˆ–è€…åœ¨é¡µé¢ä¸­æ‰‹åŠ¨æ£€æŸ¥æƒé™å¹¶è·³è½¬ã€‚

### Q4: å¦‚ä½•æ·»åŠ æ–°çš„ç”¨æˆ·ç±»å‹ï¼Ÿ
A4: åœ¨ `USER_TYPES` å¸¸é‡ä¸­æ·»åŠ æ–°ç±»å‹ï¼Œå¹¶åœ¨ `ROLE_PERMISSIONS` ä¸­é…ç½®å¯¹åº”çš„æƒé™ã€‚

## æ€»ç»“

è¿™ä¸ªåŒç”¨æˆ·ç±»å‹æ¶æ„æä¾›äº†ï¼š
- ğŸ” å®Œæ•´çš„æƒé™æ§åˆ¶ç³»ç»Ÿ
- ğŸ¨ åŠ¨æ€çš„ç”¨æˆ·ç•Œé¢åˆ‡æ¢
- ğŸš€ æ˜“äºæ‰©å±•çš„æ¶æ„è®¾è®¡
- ğŸ“± ç»Ÿä¸€çš„ç”¨æˆ·ä½“éªŒ

é€šè¿‡ä½¿ç”¨è¿™ä¸ªæ¶æ„ï¼Œä½ å¯ä»¥è½»æ¾åœ°ä¸ºä¸åŒç±»å‹çš„ç”¨æˆ·æä¾›å®šåˆ¶åŒ–çš„åŠŸèƒ½å’Œä½“éªŒã€‚ 